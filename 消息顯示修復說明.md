# æ¶ˆæ¯é¡¯ç¤ºå•é¡Œä¿®å¾©èªªæ˜

## ğŸ› å•é¡Œæè¿°

**ç—‡ç‹€**ï¼šåªæœ‰è‡ªå·±ç™¼é€çš„æ¶ˆæ¯èƒ½æ­£å¸¸é¡¯ç¤ºï¼Œå…¶ä»–äººçš„æ¶ˆæ¯é¡¯ç¤ºç‚ºç©ºç™½ã€‚

**å½±éŸ¿ç¯„åœ**ï¼šæ‰€æœ‰æ¥æ”¶çš„æ¶ˆæ¯ï¼ˆfrom_me = falseï¼‰

---

## ğŸ” å•é¡ŒåŸå› 

### æ ¹æœ¬åŸå› 
å‰ç«¯åœ¨æ¸²æŸ“æ¶ˆæ¯æ™‚ï¼Œæ²’æœ‰æ­£ç¢ºå¾ `full_message_json` ä¸­æå–æ¶ˆæ¯å…§å®¹ã€‚

### æŠ€è¡“ç´°ç¯€

1. **æ•¸æ“šåº«å­˜å„²**ï¼š
   - æœå‹™å™¨ç«¯å°‡æ¶ˆæ¯å­˜å„²åˆ°æ•¸æ“šåº«æ™‚ï¼Œ`content` å­—æ®µå¯èƒ½ç‚ºï¼š
     - å¯¦éš›æ–‡å­—å…§å®¹ï¼ˆä¾‹å¦‚ï¼š"ä½ å¥½"ï¼‰
     - æ¶ˆæ¯é¡å‹åç¨±ï¼ˆä¾‹å¦‚ï¼š"conversation"ã€"extendedTextMessage"ï¼‰
     - ç©ºå­—ç¬¦ä¸²ï¼ˆå°æ–¼ç´”åª’é«”æ¶ˆæ¯ï¼‰

2. **å‰ç«¯æ¸²æŸ“å•é¡Œ**ï¼š
   - ç•¶ `content` å­—æ®µæ˜¯æ¶ˆæ¯é¡å‹åç¨±æˆ–ç©ºå­—ç¬¦ä¸²æ™‚
   - å‰ç«¯æ²’æœ‰å˜—è©¦å¾ `full_message_json` æå–å¯¦éš›å…§å®¹
   - å°è‡´æ¶ˆæ¯é¡¯ç¤ºç‚ºç©ºç™½

3. **ç‚ºä»€éº¼è‡ªå·±çš„æ¶ˆæ¯èƒ½é¡¯ç¤º**ï¼š
   - å¯èƒ½æ˜¯å› ç‚ºç™¼é€æ™‚çš„æ¶ˆæ¯çµæ§‹ä¸åŒ
   - æˆ–è€… `content` å­—æ®µè¢«æ­£ç¢ºå¡«å……äº†

---

## âœ… ä¿®å¾©æ–¹æ¡ˆ

### æ”¹é€²çš„æ¶ˆæ¯å…§å®¹æå–é‚è¼¯

```javascript
// 1. æª¢æŸ¥ content æ˜¯å¦ç‚ºç©ºæˆ–æ˜¯æ¶ˆæ¯é¡å‹åç¨±
if (!content || ['conversation', 'extendedTextMessage', 'imageMessage', ...].includes(content)) {
    
    // 2. å¾ full_message_json æå–çœŸå¯¦æ¶ˆæ¯
    const realMsg = msg.full_message_json?.message;
    
    // 3. Unwrap æ¶ˆæ¯ï¼ˆè™•ç† viewOnceã€ephemeral ç­‰åŒ…è£ï¼‰
    let unwrapped = realMsg;
    if (realMsg.viewOnceMessage?.message) unwrapped = realMsg.viewOnceMessage.message;
    if (realMsg.ephemeralMessage?.message) unwrapped = realMsg.ephemeralMessage.message;
    
    // 4. æå–å¯¦éš›æ–‡å­—å…§å®¹
    if (unwrapped.conversation) {
        content = unwrapped.conversation;  // æ™®é€šæ–‡å­—æ¶ˆæ¯
    } else if (unwrapped.extendedTextMessage?.text) {
        content = unwrapped.extendedTextMessage.text;  // æ“´å±•æ–‡å­—æ¶ˆæ¯
    } else if (unwrapped.imageMessage?.caption) {
        content = unwrapped.imageMessage.caption;  // åœ–ç‰‡æ¨™é¡Œ
    } else if (unwrapped.videoMessage?.caption) {
        content = unwrapped.videoMessage.caption;  // è¦–é »æ¨™é¡Œ
    }
}
```

### é—œéµæ”¹é€²é»

1. **ä¸»å‹•æå–å…§å®¹**ï¼š
   - ä¸å†ä¾è³´æ•¸æ“šåº«çš„ `content` å­—æ®µ
   - ç›´æ¥å¾ `full_message_json` æå–åŸå§‹æ¶ˆæ¯

2. **æ¶ˆæ¯è§£åŒ…ï¼ˆUnwrapï¼‰**ï¼š
   - è™•ç† WhatsApp çš„æ¶ˆæ¯åŒ…è£å±¤
   - æ”¯æŒ viewOnceï¼ˆé–±å¾Œå³ç„šï¼‰
   - æ”¯æŒ ephemeralï¼ˆé™æ™‚æ¶ˆæ¯ï¼‰
   - æ”¯æŒ documentWithCaptionï¼ˆå¸¶æ¨™é¡Œçš„æ–‡æª”ï¼‰

3. **å¤šç¨®å…§å®¹ä¾†æº**ï¼š
   - `conversation`ï¼šæ™®é€šæ–‡å­—
   - `extendedTextMessage.text`ï¼šå¸¶æ ¼å¼çš„æ–‡å­—
   - `imageMessage.caption`ï¼šåœ–ç‰‡èªªæ˜
   - `videoMessage.caption`ï¼šè¦–é »èªªæ˜
   - `documentMessage.fileName`ï¼šæ–‡ä»¶å

---

## ğŸ“Š ä¿®å¾©æ•ˆæœ

### ä¿®å¾©å‰ âŒ
```
ä½ çš„æ¶ˆæ¯ï¼šä½ å¥½ï¼         âœ… æ­£å¸¸é¡¯ç¤º
å°æ–¹æ¶ˆæ¯ï¼š               âŒ ç©ºç™½
å°æ–¹æ¶ˆæ¯ï¼š[åœ–ç‰‡]         âš ï¸ åªé¡¯ç¤ºæ¨™ç±¤
```

### ä¿®å¾©å¾Œ âœ…
```
ä½ çš„æ¶ˆæ¯ï¼šä½ å¥½ï¼         âœ… æ­£å¸¸é¡¯ç¤º
å°æ–¹æ¶ˆæ¯ï¼šè¬è¬ä½ å“¦       âœ… æ­£å¸¸é¡¯ç¤º
å°æ–¹æ¶ˆæ¯ï¼š[åœ–ç‰‡é¡¯ç¤º]     âœ… æ­£å¸¸é¡¯ç¤ºåœ–ç‰‡
```

---

## ğŸ§ª æ¸¬è©¦å»ºè­°

### æ¸¬è©¦å ´æ™¯

1. **ç´”æ–‡å­—æ¶ˆæ¯**
   - âœ… ç™¼é€æ™®é€šæ–‡å­—
   - âœ… æ¥æ”¶æ™®é€šæ–‡å­—
   - âœ… å¸¶ Emoji çš„æ–‡å­—

2. **åª’é«”æ¶ˆæ¯**
   - âœ… åœ–ç‰‡ï¼ˆå¸¶æ¨™é¡Œï¼‰
   - âœ… åœ–ç‰‡ï¼ˆç„¡æ¨™é¡Œï¼‰
   - âœ… è¦–é »ï¼ˆå¸¶æ¨™é¡Œï¼‰
   - âœ… è¦–é »ï¼ˆç„¡æ¨™é¡Œï¼‰
   - âœ… èªéŸ³æ¶ˆæ¯
   - âœ… è²¼åœ–

3. **ç‰¹æ®Šæ¶ˆæ¯**
   - âœ… å›è¦†æ¶ˆæ¯ï¼ˆå¼•ç”¨ï¼‰
   - âœ… Emoji åæ‡‰
   - âœ… é–±å¾Œå³ç„šæ¶ˆæ¯
   - âœ… é™æ™‚æ¶ˆæ¯

### æ¸¬è©¦æ­¥é©Ÿ

1. åˆ·æ–°ç€è¦½å™¨é é¢ï¼ˆCtrl+R æˆ– Cmd+Rï¼‰
2. é»æ“Šä»»ä½•å°è©±
3. æ»¾å‹•æŸ¥çœ‹æ­·å²æ¶ˆæ¯
4. ç¢ºèªæ‰€æœ‰æ¶ˆæ¯éƒ½èƒ½æ­£å¸¸é¡¯ç¤º

---

## ğŸ”§ æŠ€è¡“åƒè€ƒ

### WhatsApp æ¶ˆæ¯çµæ§‹

```javascript
{
  key: {
    remoteJid: "85291234567@s.whatsapp.net",  // å°è©± ID
    fromMe: false,                              // æ˜¯å¦è‡ªå·±ç™¼é€
    id: "ABC123..."                             // æ¶ˆæ¯ ID
  },
  message: {
    conversation: "ä½ å¥½"                        // æ™®é€šæ–‡å­—
    // æˆ–
    extendedTextMessage: {
      text: "ä½ å¥½",                             // æ“´å±•æ–‡å­—
      contextInfo: { ... }                      // ä¸Šä¸‹æ–‡ï¼ˆå¼•ç”¨ç­‰ï¼‰
    }
    // æˆ–
    imageMessage: {
      caption: "åœ–ç‰‡èªªæ˜",                      // åœ–ç‰‡æ¨™é¡Œ
      mimetype: "image/jpeg",
      url: "..."
    }
  },
  messageTimestamp: 1234567890,
  pushName: "è¯çµ¡äººå§“å"
}
```

### æ¶ˆæ¯åŒ…è£é¡å‹

1. **viewOnceMessage**ï¼šé–±å¾Œå³ç„š
2. **viewOnceMessageV2**ï¼šé–±å¾Œå³ç„š V2
3. **ephemeralMessage**ï¼šé™æ™‚æ¶ˆæ¯
4. **documentWithCaptionMessage**ï¼šå¸¶æ¨™é¡Œçš„æ–‡æª”

---

## ğŸ“ ç›¸é—œæ–‡ä»¶

- **ä¿®æ”¹æ–‡ä»¶**ï¼š`public/index.html`
- **ä¿®æ”¹å‡½æ•¸**ï¼š`renderMessageBubble(msg)`
- **æäº¤è¨˜éŒ„**ï¼š`ea124a6`

---

## ğŸ’¡ é é˜²æªæ–½

### å¾ŒçºŒå»ºè­°

1. **æœå‹™å™¨ç«¯å„ªåŒ–**ï¼š
   - ç¢ºä¿ `content` å­—æ®µå§‹çµ‚åŒ…å«å¯é¡¯ç¤ºçš„å…§å®¹
   - æ”¹é€² `prepareMessageForSupabase` å‡½æ•¸

2. **æ•¸æ“šé©—è­‰**ï¼š
   - åœ¨ä¿å­˜å‰é©—è­‰ `content` æ˜¯å¦ç‚ºç©º
   - è¨˜éŒ„ç„¡æ³•æå–å…§å®¹çš„æ¶ˆæ¯

3. **éŒ¯èª¤è™•ç†**ï¼š
   - æ·»åŠ æ¶ˆæ¯å…§å®¹æå–å¤±æ•—çš„æç¤º
   - è¨˜éŒ„ç•°å¸¸æ¶ˆæ¯çµæ§‹ä¾›èª¿è©¦

---

## ğŸ‰ ç¸½çµ

### ä¿®å¾©æˆæœ
- âœ… æ‰€æœ‰æ¶ˆæ¯éƒ½èƒ½æ­£ç¢ºé¡¯ç¤ºæ–‡å­—å…§å®¹
- âœ… æ”¯æŒå„ç¨®æ¶ˆæ¯é¡å‹
- âœ… æ­£ç¢ºè™•ç†æ¶ˆæ¯åŒ…è£å±¤
- âœ… æå–åœ–ç‰‡å’Œè¦–é »æ¨™é¡Œ

### ç”¨æˆ¶é«”é©—æ”¹å–„
- ğŸ’¬ å°è©±æ›´å®Œæ•´ï¼Œä¸å†æœ‰ç©ºç™½æ¶ˆæ¯
- ğŸ“¸ åª’é«”æ¶ˆæ¯é¡¯ç¤ºæ›´æ¸…æ™°
- ğŸ¯ æ¶ˆæ¯ä¸Šä¸‹æ–‡æ›´å®Œæ•´

**ç¾åœ¨åˆ·æ–°é é¢ï¼Œæ‰€æœ‰æ¶ˆæ¯éƒ½æ‡‰è©²èƒ½æ­£å¸¸é¡¯ç¤ºäº†ï¼** ğŸŠ

---

## ğŸ“ å¦‚æœé‚„æœ‰å•é¡Œ

å¦‚æœåˆ·æ–°å¾Œä»æœ‰æ¶ˆæ¯é¡¯ç¤ºå•é¡Œï¼š

1. **æ¸…é™¤ç€è¦½å™¨ç·©å­˜**
   - Chrome/Edgeï¼šCtrl+Shift+Delete
   - Safariï¼šCmd+Option+E

2. **å¼·åˆ¶åˆ·æ–°**
   - Windowsï¼šCtrl+Shift+R
   - Macï¼šCmd+Shift+R

3. **æª¢æŸ¥æ§åˆ¶å°**
   - æŒ‰ F12 æ‰“é–‹é–‹ç™¼è€…å·¥å…·
   - æŸ¥çœ‹ Console æ¨™ç±¤æ˜¯å¦æœ‰éŒ¯èª¤

4. **é‡æ–°åŒæ­¥**
   - é»æ“Š"å¼·åˆ¶åŒæ­¥"æŒ‰éˆ•
   - é‡æ–°æƒæ QR Code

---

**æ›´æ–°æ™‚é–“**ï¼š2026-02-05  
**ç‰ˆæœ¬**ï¼šv1.1  
**ç‹€æ…‹**ï¼šå·²éƒ¨ç½² âœ…
