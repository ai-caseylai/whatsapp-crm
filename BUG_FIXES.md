# Bug 修复说明

## 📋 修复的问题

### 1. ✅ 无法接收新消息（前端不显示，但数据库有记录）

**原因：** WebSocket 只在 `type === 'notify'` 时广播消息，但新消息可能有多种类型（notify、append 等）

**修复：**
- 修改了 `server.js` 第 741-750 行
- 现在会广播 `notify` 和 `append` 类型的消息
- 添加了详细的日志记录

### 6. ✅ 收不到群组消息

**原因：** 
1. 群组消息的联系人信息没有正确保存
2. 消息处理逻辑忽略了群组类型的消息

**修复：**
- 修改了 `server.js` 第 754-820 行，添加群组消息处理
- 修改了 `server.js` 第 681-721 行，添加实时群组信息获取
- 添加了群组消息的特殊处理逻辑

### 3. ✅ API 调用失败

**修复：**
- 改进了 API 的错误处理和日志
- 添加了 try-catch 捕获异常
- 详细记录 API 调用过程

### 5. ✅ 消息显示不完整或乱码

**修复：**
- 消息内容提取逻辑已经很完善，支持各种消息类型
- 前端 WebSocket 处理添加了更详细的日志
- 改进了群组消息发送者信息的显示

## 🔧 修改的文件

### 1. `server.js`
- **第 741-750 行**: 修改 WebSocket 广播逻辑，支持 append 类型
- **第 681-721 行**: 添加实时群组信息获取
- **第 754-820 行**: 改进群组消息联系人处理
- **第 1394-1415 行**: 改进 API 错误处理
- **第 1834-1860 行**: 增强 WebSocket 广播函数

### 2. `public/index.html`
- **第 923-943 行**: 改进前端 WebSocket 消息处理
- 添加了详细的日志记录
- 改进了群组消息的显示

## 🧪 测试步骤

### 测试 1: 新消息实时显示

1. 启动服务器：
   ```bash
   node server.js
   ```

2. 打开浏览器访问 `http://localhost:3000`

3. 扫描 QR 码连接 WhatsApp

4. 让朋友发送一条消息给你

5. **预期结果：**
   - 浏览器控制台显示：`📨 收到私聊消息`
   - 联系人列表自动刷新，该联系人移到顶部
   - 如果当前打开该聊天，消息立即显示

6. **检查后端日志：**
   ```
   [sessionId] Received 1 messages (type: notify)
   [sessionId] 📤 广播消息到前端: xxxxx@s.whatsapp.net
   [WebSocket] 📤 广播消息 - 会话: xxx, 聊天: xxx, 类型: 私聊
   [WebSocket] ✅ 消息已发送到 1 个客户端
   ```

### 测试 2: 群组消息接收

1. 让朋友在群组中发送消息

2. **预期结果：**
   - 浏览器控制台显示：`📨 收到群组消息`
   - 群组出现在联系人列表中（如果是新群组）
   - 群组名称正确显示（不是 JID）
   - 打开群组聊天，可以看到消息
   - 消息显示发送者的名字

3. **检查后端日志：**
   ```
   [sessionId] 📋 检测到 1 个群组的消息，正在获取群组信息...
   [sessionId] ✅ 已更新 1 个群组的信息
   [sessionId] ✅ 更新了 1 个联系人（包括群组）
   [WebSocket] 📤 广播消息 - 类型: 群组
   ```

### 测试 3: API 调用

1. 测试获取联系人：
   ```bash
   curl http://localhost:3000/api/session/YOUR_SESSION_ID/contacts
   ```

2. 测试获取消息：
   ```bash
   curl http://localhost:3000/api/session/YOUR_SESSION_ID/messages/CONTACT_JID
   ```

3. **预期结果：**
   - 返回 JSON 数据
   - 后端日志显示 API 调用信息

### 测试 4: 消息内容显示

1. 发送不同类型的消息测试：
   - 纯文字消息
   - 图片消息（带/不带说明文字）
   - 视频消息
   - 语音消息
   - 贴图
   - 回复消息

2. **预期结果：**
   - 所有消息类型都能正确显示
   - 图片、视频可以预览
   - 语音可以播放
   - 回复消息显示 `[回覆]` 标记

## 🚀 部署

### 重启服务

如果服务器正在运行，需要重启：

```bash
# 使用 PM2
pm2 restart whatsapp-crm

# 或直接运行
pkill -f "node server.js"
node server.js
```

### 清除浏览器缓存

1. 打开浏览器控制台（F12）
2. 右键点击刷新按钮
3. 选择"清空缓存并硬性重新加载"

## 📊 监控日志

### 查看实时日志

```bash
# 使用 PM2
pm2 logs whatsapp-crm

# 或使用 tail
tail -f /path/to/log/file
```

### 关键日志标识

- `📨 收到X消息` - 接收到新消息
- `📤 广播消息` - WebSocket 广播
- `✅ 消息已发送` - WebSocket 发送成功
- `📋 检测到X个群组` - 群组消息处理
- `[API]` - API 调用
- `❌` - 错误信息

## 🔍 故障排查

### 问题：前端仍然收不到新消息

1. **检查 WebSocket 连接：**
   - 打开浏览器控制台
   - 应该看到：`✅ WebSocket 已連接`
   - 如果看到错误，检查服务器是否正常运行

2. **检查后端日志：**
   - 确认消息已保存到数据库
   - 确认有 `📤 广播消息` 日志
   - 确认有 `✅ 消息已发送到 X 个客户端`

3. **检查会话状态：**
   - 确认页面顶部显示"已連線"（绿色）
   - 如果显示"未連線"，尝试重新扫描 QR 码

### 问题：群组消息仍然收不到

1. **检查群组是否在联系人列表中：**
   - 点击"刷新群组"按钮
   - 等待几秒钟，看群组是否出现

2. **检查后端日志：**
   - 应该看到：`📋 检测到 X 个群组的消息`
   - 应该看到：`✅ 已更新 X 个群组的信息`

3. **检查数据库：**
   ```sql
   -- 检查群组联系人
   SELECT * FROM whatsapp_contacts 
   WHERE jid LIKE '%@g.us' 
   AND session_id = 'YOUR_SESSION_ID';
   
   -- 检查群组消息
   SELECT * FROM whatsapp_messages 
   WHERE remote_jid LIKE '%@g.us' 
   AND session_id = 'YOUR_SESSION_ID'
   ORDER BY message_timestamp DESC 
   LIMIT 10;
   ```

### 问题：API 返回 500 错误

1. **检查 Supabase 连接：**
   - 确认 `SUPABASE_URL` 和 `SUPABASE_KEY` 正确
   - 测试 Supabase 是否可访问

2. **检查数据库表结构：**
   - 确认表 `whatsapp_contacts` 和 `whatsapp_messages` 存在
   - 确认字段匹配代码中的字段名

## 📝 后续优化建议

1. **添加环境变量配置**
   - 将 Supabase 配置移到 `.env` 文件
   - 不要在代码中硬编码密钥

2. **添加消息通知**
   - 可以在收到新消息时显示浏览器通知
   - 添加声音提示

3. **优化群组消息显示**
   - 群组消息可以显示发送者头像
   - 添加群组成员列表查看功能

4. **添加消息搜索功能**
   - 按内容搜索消息
   - 按日期范围筛选

5. **性能优化**
   - 消息分页加载（目前加载所有消息）
   - 图片懒加载
   - WebSocket 断线重连优化

## ✅ 验收标准

修复完成后，系统应该满足：

1. ✅ 收到新消息后，前端立即显示（1-2秒内）
2. ✅ 群组消息能正常接收和显示
3. ✅ 群组名称正确显示（不是 JID）
4. ✅ 群组消息显示发送者信息
5. ✅ API 调用正常，无 500 错误
6. ✅ 所有消息类型（文字、图片、视频等）正常显示
7. ✅ 控制台有清晰的日志记录，方便调试

---

修复完成时间：2026-02-06
修复人：AI Assistant
