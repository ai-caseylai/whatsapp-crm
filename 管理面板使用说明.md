# WhatsApp CRM 管理面板使用说明

## 🎛️ 访问管理面板

### 📍 访问地址
```
http://whatsapp-crm.techforliving.app/admin.html
```

### 🔐 登录密码
```
whatsapp-admin-2026
```

---

## 📊 功能介绍

### 1️⃣ 服务状态

**查看内容：**
- 💬 WhatsApp Bot 状态
  - 运行状态（在线/离线）
  - 进程 ID (PID)
  - 内存使用量
  - CPU 使用率
  - 重启次数
  - 运行时间

- 🪝 Webhook 服务状态
  - 同上

**可执行操作：**
- 🔄 重启 WhatsApp Bot
- 🔄 重启 Webhook 服务
- 🔄 重启所有服务
- 📥 手动触发部署
- 🔄 刷新状态

---

### 2️⃣ 实时日志

**功能：**
- 实时查看 WhatsApp Bot 日志
- 实时查看 Webhook 服务日志
- 自动滚动到最新日志
- 日志流式传输（SSE）

**操作：**
- 点击 "WhatsApp Bot" 或 "Webhook" 切换日志源
- 点击 "清空" 清除当前显示的日志
- 自动实时更新

**适用场景：**
- 调试问题
- 监控消息接收
- 查看部署过程
- 监控 Webhook 触发

---

### 3️⃣ 部署历史

**查看内容：**
- 📜 最近 20 条 Git 提交记录
- 每条记录显示：
  - Commit Hash（哈希值）
  - 提交信息

**操作：**
- 🔄 刷新历史
- 📝 查看 GitHub Webhook 配置（跳转到 GitHub）

**适用场景：**
- 查看代码更新历史
- 确认当前版本
- 追踪功能迭代

---

### 4️⃣ 系统信息

**查看内容：**
- ⏱️ 系统运行时间
- 💾 内存使用情况
  - 总内存
  - 已使用
  - 可用
  - 缓存

- 💿 磁盘使用情况
  - 总容量
  - 已使用
  - 可用
  - 使用百分比

- 🌿 Git 仓库状态
  - 当前分支
  - 工作目录状态

**操作：**
- 🔄 刷新系统信息

**适用场景：**
- 监控资源使用
- 检查磁盘空间
- 确认 Git 状态

---

## 🔍 使用场景示例

### 场景 1：代码部署后验证

1. 推送代码到 GitHub
2. 打开管理面板
3. 切换到 "实时日志" 标签
4. 选择 "Webhook" 日志
5. 观察部署过程
6. 切换到 "服务状态" 查看服务是否重启
7. 查看 "部署历史" 确认新版本

### 场景 2：排查消息接收问题

1. 打开管理面板
2. 切换到 "实时日志"
3. 选择 "WhatsApp Bot"
4. 发送测试消息到 WhatsApp
5. 观察日志是否有新消息记录
6. 根据日志信息排查问题

### 场景 3：服务重启

1. 打开管理面板
2. 在 "服务状态" 标签
3. 点击对应服务的 "重启服务" 按钮
4. 确认弹窗
5. 等待几秒刷新状态
6. 确认服务已成功重启

### 场景 4：监控服务器资源

1. 打开管理面板
2. 切换到 "系统信息" 标签
3. 查看内存使用情况
4. 查看磁盘空间
5. 如果资源不足，考虑清理或升级

---

## ⚡ 快捷操作

### 从主应用跳转到管理面板
```
http://whatsapp-crm.techforliving.app/admin.html
```

### 从本地 SSH 查看日志
```bash
ssh whatsapp-crm
pm2 logs whatsapp-bot      # 主应用日志
pm2 logs whatsapp-webhook  # Webhook 日志
pm2 logs whatsapp-admin    # 管理面板日志
```

### 从命令行重启服务
```bash
ssh whatsapp-crm
pm2 restart whatsapp-bot      # 重启主应用
pm2 restart whatsapp-webhook  # 重启 Webhook
pm2 restart whatsapp-admin    # 重启管理面板
pm2 restart all               # 重启所有服务
```

---

## 🔒 安全建议

1. **修改默认密码**
   - 修改 `/home/ubuntu/whatsapp-bot/.env` 中的 `ADMIN_SECRET`
   - 重启管理服务：`pm2 restart whatsapp-admin`

2. **限制访问 IP**（可选）
   - 在 Nginx 配置中添加 IP 白名单
   - 只允许特定 IP 访问管理面板

3. **启用 HTTPS**（推荐）
   ```bash
   sudo certbot --nginx -d whatsapp-crm.techforliving.app
   ```
   启用后访问地址改为：
   ```
   https://whatsapp-crm.techforliving.app/admin.html
   ```

4. **定期查看日志**
   - 检查异常登录尝试
   - 监控服务异常

---

## 🛠️ 故障排除

### 问题 1：无法访问管理面板

**检查服务状态：**
```bash
ssh whatsapp-crm
pm2 status whatsapp-admin
```

**重启服务：**
```bash
pm2 restart whatsapp-admin
```

**查看错误日志：**
```bash
pm2 logs whatsapp-admin --err
```

### 问题 2：登录密码错误

**检查密码配置：**
```bash
ssh whatsapp-crm
cat /home/ubuntu/whatsapp-bot/.env | grep ADMIN_SECRET
```

**重置密码：**
```bash
ssh whatsapp-crm
cd /home/ubuntu/whatsapp-bot
# 编辑 .env 文件
nano .env
# 修改 ADMIN_SECRET 行
# 保存并重启
pm2 restart whatsapp-admin
```

### 问题 3：实时日志不更新

**刷新页面：**
- 按 F5 或 Ctrl+R 刷新页面

**检查网络连接：**
- 打开浏览器开发者工具 (F12)
- 查看 Console 和 Network 标签
- 检查 EventSource 连接是否正常

**重启管理服务：**
```bash
ssh whatsapp-crm
pm2 restart whatsapp-admin
```

### 问题 4：服务重启失败

**查看详细错误：**
- 在管理面板的 "实时日志" 中查看错误信息

**手动重启：**
```bash
ssh whatsapp-crm
pm2 restart whatsapp-bot
pm2 status
```

---

## 📞 技术支持

### 服务端口
- 主应用：3000（内部）
- Webhook：9000（内部）
- 管理面板：9001（内部）
- Nginx：80/443（外部）

### 重要文件位置
- 管理服务器：`/home/ubuntu/whatsapp-bot/admin-server.js`
- 管理页面：`/home/ubuntu/whatsapp-bot/public/admin.html`
- 环境变量：`/home/ubuntu/whatsapp-bot/.env`
- Nginx 配置：`/etc/nginx/sites-available/webhook`

### PM2 进程列表
```bash
pm2 list

┌─────┬────────────────────┬─────────┬─────────┐
│ id  │ name               │ status  │ restart │
├─────┼────────────────────┼─────────┼─────────┤
│ 0   │ whatsapp-bot       │ online  │ 68      │
│ 2   │ whatsapp-webhook   │ online  │ 1       │
│ 3   │ whatsapp-admin     │ online  │ 0       │
└─────┴────────────────────┴─────────┴─────────┘
```

---

## 🎯 最佳实践

1. **定期查看状态**
   - 每天打开管理面板查看一次
   - 关注服务重启次数
   - 监控资源使用情况

2. **部署后验证**
   - 每次推送代码后查看部署日志
   - 确认服务正常重启
   - 测试功能是否正常

3. **备份重要数据**
   - 定期备份数据库
   - 备份认证信息
   - 备份配置文件

4. **性能优化**
   - 如果内存使用高，考虑重启服务
   - 如果磁盘空间不足，清理日志文件
   - 监控 CPU 使用率

---

## 📱 移动端访问

管理面板已优化响应式设计，可以在手机或平板上访问：

1. 在手机浏览器中打开：
   ```
   http://whatsapp-crm.techforliving.app/admin.html
   ```

2. 输入密码登录

3. 所有功能均可正常使用

---

**管理面板访问地址：**
```
http://whatsapp-crm.techforliving.app/admin.html
```

**登录密码：**
```
whatsapp-admin-2026
```

**祝使用愉快！** 🎊
