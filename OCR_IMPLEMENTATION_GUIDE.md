# ğŸ“· OCR åŠŸèƒ½å¯¦ç¾æŒ‡å—

## ğŸ¯ OCR åŠŸèƒ½æ¦‚è¿°

OCRï¼ˆOptical Character Recognitionï¼Œå…‰å­¸å­—ç¬¦è­˜åˆ¥ï¼‰å¯ä»¥å¾åœ–ç‰‡ä¸­æå–æ–‡å­—å…§å®¹ï¼Œå°æ–¼æ‚¨çš„ WhatsApp CRM ç³»çµ±ç‰¹åˆ¥æœ‰ç”¨ï¼š

- âœ… æå–åç‰‡ä¿¡æ¯
- âœ… è­˜åˆ¥æ–‡æª”ã€æ”¶æ“šã€ç™¼ç¥¨
- âœ… è®€å–æˆªåœ–ä¸­çš„æ–‡å­—
- âœ… æå–èŠå¤©è¨˜éŒ„åœ–ç‰‡ä¸­çš„å…§å®¹

---

## ğŸš€ æ¨è–¦æ–¹æ¡ˆå°æ¯”

### æ–¹æ¡ˆ 1ï¼šGoogle Gemini Visionï¼ˆæ¨è–¦ â­â­â­â­â­ï¼‰

**å„ªé»**ï¼š
- âœ… **æ‚¨å·²ç¶“åœ¨ä½¿ç”¨** - ç„¡éœ€é¡å¤–é…ç½®
- âœ… **å…è²»é¡åº¦å¤§** - æ¯æœˆ 1500 æ¬¡è«‹æ±‚
- âœ… **å¤šèªè¨€æ”¯æŒ** - ä¸­æ–‡ã€è‹±æ–‡ç­‰
- âœ… **æ™ºèƒ½ç†è§£** - ä¸åƒ…æå–æ–‡å­—ï¼Œé‚„èƒ½ç†è§£ä¸Šä¸‹æ–‡
- âœ… **è³ªé‡æ¥µé«˜** - æ‰‹å¯«å­—é«”ã€è¤‡é›œæ’ç‰ˆéƒ½èƒ½è­˜åˆ¥

**æˆæœ¬**ï¼š
- å…è²»é¡åº¦å…§ï¼š$0
- è¶…å‡ºå¾Œï¼šç´„ $0.001/å¼µåœ–ç‰‡

**é©ç”¨å ´æ™¯**ï¼š
- âœ… è¤‡é›œæ–‡æª”ï¼ˆå¤šæ¬„ä½ã€è¡¨æ ¼ï¼‰
- âœ… æ‰‹å¯«æ–‡å­—
- âœ… æ··åˆä¸­è‹±æ–‡
- âœ… éœ€è¦ç†è§£æ–‡å­—å«ç¾©

---

### æ–¹æ¡ˆ 2ï¼šTesseract OCRï¼ˆå…è²»é–‹æºï¼‰

**å„ªé»**ï¼š
- âœ… **å®Œå…¨å…è²»** - æœ¬åœ°é‹è¡Œ
- âœ… **ç„¡ API é™åˆ¶**
- âœ… **éš±ç§ä¿è­·** - æ•¸æ“šä¸ä¸Šå‚³
- âœ… **æ”¯æŒå¤šèªè¨€**

**ç¼ºé»**ï¼š
- âš ï¸ éœ€è¦å®‰è£ç³»çµ±ä¾è³´
- âš ï¸ å°æ¨¡ç³Šåœ–ç‰‡æ•ˆæœè¼ƒå·®
- âš ï¸ æ‰‹å¯«å­—è­˜åˆ¥ä¸ä½³

**æˆæœ¬**ï¼šå®Œå…¨å…è²»

**é©ç”¨å ´æ™¯**ï¼š
- âœ… æ¸…æ™°çš„æ‰“å°æ–‡æª”
- âœ… å¤§æ‰¹é‡è™•ç†
- âœ… éš±ç§æ•æ„Ÿæ•¸æ“š

---

### æ–¹æ¡ˆ 3ï¼šGPT-4 Visionï¼ˆOpenRouterï¼‰

**å„ªé»**ï¼š
- âœ… è­˜åˆ¥æº–ç¢ºç‡é«˜
- âœ… å¯ä»¥ç†è§£è¤‡é›œæ’ç‰ˆ
- âœ… æ‚¨å·²é…ç½® OpenRouter

**ç¼ºé»**ï¼š
- âš ï¸ æˆæœ¬è¼ƒé«˜ï¼ˆ$0.003-$0.01/å¼µï¼‰

**æˆæœ¬**ï¼šç´„ $0.005/å¼µåœ–ç‰‡

---

### æ–¹æ¡ˆ 4ï¼šå°ˆæ¥­ OCR API

#### Azure Computer Vision OCR
- **å„ªé»**ï¼šä¼æ¥­ç´šã€æº–ç¢ºåº¦é«˜ã€æ”¯æŒè¡¨æ ¼è­˜åˆ¥
- **æˆæœ¬**ï¼š$1/1000 æ¬¡

#### AWS Textract
- **å„ªé»**ï¼šå¯è­˜åˆ¥è¡¨æ ¼ã€è¡¨å–®çµæ§‹
- **æˆæœ¬**ï¼š$1.5/1000 é 

---

## ğŸ¯ æˆ‘çš„æ¨è–¦

### æœ€ä½³æ–¹æ¡ˆï¼š**Gemini Vision OCR**

æ‚¨å·²ç¶“æœ‰ Gemini APIï¼Œç›´æ¥ä½¿ç”¨å°±èƒ½ç²å¾—æœ€ä½³æ•ˆæœï¼æˆ‘æœƒç‚ºæ‚¨å‰µå»ºå¯¦ç¾è…³æœ¬ã€‚

---

## ğŸ’» å¯¦ç¾ä»£ç¢¼

### 1. ä½¿ç”¨ Gemini Vision å¯¦ç¾ OCR

```javascript
// ocr-gemini.js
const { GoogleGenerativeAI } = require('@google/generative-ai');
const { createClient } = require('@supabase/supabase-js');
const fs = require('fs');
const path = require('path');
require('dotenv').config();

// é…ç½®
const GOOGLE_GEMINI_API_KEY = process.env.GOOGLE_GEMINI_API_KEY;
const SUPABASE_URL = 'https://izwdetsrqjepoxmocore.supabase.co';
const SUPABASE_KEY = 'your-service-key';
const SESSION_ID = 'sess_id73sa6oi_1770363274857';
const MEDIA_DIR = path.join(__dirname, 'data', 'media');

const genAI = new GoogleGenerativeAI(GOOGLE_GEMINI_API_KEY);
const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

// OCR æç¤ºè©ï¼ˆå¯æ ¹æ“šéœ€æ±‚èª¿æ•´ï¼‰
const OCR_PROMPTS = {
    // é€šç”¨ OCR - æå–æ‰€æœ‰æ–‡å­—
    general: `è«‹æå–åœ–ç‰‡ä¸­çš„æ‰€æœ‰æ–‡å­—å…§å®¹ã€‚
è¦æ±‚ï¼š
1. ä¿æŒåŸå§‹æ’ç‰ˆå’Œæ ¼å¼
2. å¦‚æœæœ‰å¤šæ¬„ï¼ŒæŒ‰å¾å·¦åˆ°å³ã€å¾ä¸Šåˆ°ä¸‹çš„é †åº
3. å¦‚æœæœ‰è¡¨æ ¼ï¼Œç”¨ Markdown è¡¨æ ¼æ ¼å¼è¼¸å‡º
4. ä¿ç•™æ‰€æœ‰æ¨™é»ç¬¦è™Ÿ
5. å¦‚æœåœ–ç‰‡ä¸­æ²’æœ‰æ–‡å­—ï¼Œå›ç­”ã€Œç„¡æ–‡å­—å…§å®¹ã€

è«‹ç›´æ¥è¼¸å‡ºæ–‡å­—å…§å®¹ï¼Œä¸è¦åŠ ä»»ä½•è§£é‡‹ã€‚`,

    // åç‰‡è­˜åˆ¥
    businessCard: `è«‹è­˜åˆ¥é€™å¼µåç‰‡ä¸¦æå–ä»¥ä¸‹ä¿¡æ¯ï¼ˆJSON æ ¼å¼ï¼‰ï¼š
{
  "name": "å§“å",
  "company": "å…¬å¸åç¨±",
  "title": "è·ä½",
  "phone": "é›»è©±è™Ÿç¢¼",
  "email": "é›»å­éƒµä»¶",
  "address": "åœ°å€",
  "website": "ç¶²ç«™",
  "other": "å…¶ä»–ä¿¡æ¯"
}

å¦‚æœæŸé …ä¿¡æ¯ä¸å­˜åœ¨ï¼Œè«‹å¡«å¯« nullã€‚`,

    // æ–‡æª”æå–ï¼ˆä¿ç•™çµæ§‹ï¼‰
    document: `è«‹æå–æ–‡æª”ä¸­çš„æ‰€æœ‰æ–‡å­—ï¼Œä¸¦ä¿æŒåŸæœ‰çµæ§‹ï¼š
1. æ¨™é¡Œä½¿ç”¨ Markdown # æ ¼å¼
2. åˆ—è¡¨ä½¿ç”¨ - æˆ–æ•¸å­—æ ¼å¼
3. è¡¨æ ¼ä½¿ç”¨ Markdown è¡¨æ ¼
4. ä¿ç•™æ®µè½æ›è¡Œ

è«‹ç›´æ¥è¼¸å‡ºæå–çš„å…§å®¹ã€‚`,

    // æ”¶æ“š/ç™¼ç¥¨
    receipt: `è«‹è­˜åˆ¥é€™å¼µæ”¶æ“š/ç™¼ç¥¨ä¸¦æå–é—œéµä¿¡æ¯ï¼ˆJSON æ ¼å¼ï¼‰ï¼š
{
  "merchant": "å•†å®¶åç¨±",
  "date": "æ—¥æœŸ",
  "total": "ç¸½é‡‘é¡",
  "items": ["é …ç›®1", "é …ç›®2", ...],
  "payment_method": "ä»˜æ¬¾æ–¹å¼",
  "receipt_number": "æ”¶æ“šç·¨è™Ÿ"
}`,

    // æˆªåœ–æ–‡å­—æå–
    screenshot: `é€™æ˜¯ä¸€å¼µæˆªåœ–ï¼Œè«‹æå–å…¶ä¸­çš„æ‰€æœ‰æ–‡å­—å…§å®¹ã€‚
æŒ‰ç…§å¾ä¸Šåˆ°ä¸‹çš„é †åºè¼¸å‡ºï¼Œä¿æŒåŸå§‹æ’ç‰ˆã€‚
å¦‚æœæœ‰å°è©±ï¼Œè«‹æ¨™æ³¨èªªè©±è€…ã€‚`
};

// OCR å‡½æ•¸
async function performOCR(imagePath, mode = 'general') {
    try {
        const model = genAI.getGenerativeModel({ model: 'gemini-1.5-flash' });
        
        // è®€å–åœ–ç‰‡
        const imageData = fs.readFileSync(imagePath);
        const base64Image = imageData.toString('base64');
        
        const imagePart = {
            inlineData: {
                data: base64Image,
                mimeType: 'image/jpeg'
            }
        };
        
        // é¸æ“‡æç¤ºè©
        const prompt = OCR_PROMPTS[mode] || OCR_PROMPTS.general;
        
        // èª¿ç”¨ API
        const result = await model.generateContent([prompt, imagePart]);
        const response = await result.response;
        const text = response.text();
        
        return {
            success: true,
            text: text.trim(),
            mode
        };
        
    } catch (error) {
        console.error('OCR å¤±æ•—:', error.message);
        return {
            success: false,
            error: error.message
        };
    }
}

// æ‰¹é‡è™•ç†åœ–ç‰‡ OCR
async function processImagesOCR(limit = 10, mode = 'general') {
    console.log('ğŸ” é–‹å§‹ OCR è™•ç†...\n');
    console.log(`æ¨¡å¼: ${mode}`);
    console.log(`è™•ç†æ•¸é‡: ${limit}\n`);
    
    // ç²å–éœ€è¦è™•ç†çš„åœ–ç‰‡
    const { data: messages, error } = await supabase
        .from('whatsapp_messages')
        .select('id, message_type, attachment_path, from_name')
        .eq('session_id', SESSION_ID)
        .eq('message_type', 'imageMessage')
        .not('attachment_path', 'is', null)
        .limit(limit);
    
    if (error) {
        console.error('âŒ æŸ¥è©¢å¤±æ•—:', error);
        return;
    }
    
    console.log(`æ‰¾åˆ° ${messages.length} å¼µåœ–ç‰‡å¾…è™•ç†\n`);
    
    let successCount = 0;
    let failCount = 0;
    
    for (let i = 0; i < messages.length; i++) {
        const msg = messages[i];
        console.log(`\n[${i+1}/${messages.length}] è™•ç†åœ–ç‰‡...`);
        console.log(`ä¾†æº: ${msg.from_name}`);
        
        const imagePath = path.join(MEDIA_DIR, path.basename(msg.attachment_path));
        
        if (!fs.existsSync(imagePath)) {
            console.log('âš ï¸ æ–‡ä»¶ä¸å­˜åœ¨ï¼Œè·³é');
            failCount++;
            continue;
        }
        
        // åŸ·è¡Œ OCR
        const ocrResult = await performOCR(imagePath, mode);
        
        if (ocrResult.success && ocrResult.text !== 'ç„¡æ–‡å­—å…§å®¹') {
            console.log('âœ… OCR æˆåŠŸ');
            console.log(`æ–‡å­—å…§å®¹:\n${ocrResult.text.substring(0, 200)}${ocrResult.text.length > 200 ? '...' : ''}\n`);
            
            // ä¿å­˜åˆ°æ•¸æ“šåº«
            const { error: insertError } = await supabase
                .from('rag_knowledge')
                .insert({
                    session_id: SESSION_ID,
                    source_type: 'image_ocr',
                    source_id: msg.id,
                    content: ocrResult.text,
                    metadata: {
                        original_path: msg.attachment_path,
                        from_name: msg.from_name,
                        ocr_mode: mode
                    }
                });
            
            if (!insertError) {
                successCount++;
            } else {
                console.log('âš ï¸ ä¿å­˜å¤±æ•—:', insertError.message);
                failCount++;
            }
        } else {
            console.log('â„¹ï¸ ç„¡æ–‡å­—å…§å®¹æˆ–è™•ç†å¤±æ•—');
            failCount++;
        }
        
        // é¿å… rate limit
        await new Promise(resolve => setTimeout(resolve, 1500));
    }
    
    console.log('\n' + '='.repeat(50));
    console.log('ğŸ“Š OCR è™•ç†å®Œæˆ');
    console.log('='.repeat(50));
    console.log(`âœ… æˆåŠŸ: ${successCount}`);
    console.log(`âŒ å¤±æ•—/ç„¡æ–‡å­—: ${failCount}`);
    console.log(`ğŸ“ˆ ç¸½è¨ˆ: ${messages.length}`);
}

// å–®å¼µåœ–ç‰‡ OCR æ¸¬è©¦
async function testSingleImage(imagePath, mode = 'general') {
    console.log('ğŸ” æ¸¬è©¦å–®å¼µåœ–ç‰‡ OCR\n');
    console.log(`åœ–ç‰‡: ${imagePath}`);
    console.log(`æ¨¡å¼: ${mode}\n`);
    
    const result = await performOCR(imagePath, mode);
    
    if (result.success) {
        console.log('âœ… OCR æˆåŠŸ\n');
        console.log('æå–çš„æ–‡å­—ï¼š');
        console.log('â”€'.repeat(50));
        console.log(result.text);
        console.log('â”€'.repeat(50));
    } else {
        console.log('âŒ OCR å¤±æ•—:', result.error);
    }
}

// ä¸»ç¨‹åº
async function main() {
    const args = process.argv.slice(2);
    
    if (args[0] === 'test') {
        // æ¸¬è©¦å–®å¼µåœ–ç‰‡
        const imagePath = args[1];
        const mode = args[2] || 'general';
        if (!imagePath) {
            console.log('ç”¨æ³•: node ocr-gemini.js test <åœ–ç‰‡è·¯å¾‘> [æ¨¡å¼]');
            return;
        }
        await testSingleImage(imagePath, mode);
    } else {
        // æ‰¹é‡è™•ç†
        const limit = parseInt(args[0]) || 10;
        const mode = args[1] || 'general';
        await processImagesOCR(limit, mode);
    }
}

main().catch(console.error);
```

---

## ğŸ¯ ä½¿ç”¨æ–¹æ³•

### 1. å®‰è£ä¾è³´

```bash
npm install @google/generative-ai
```

### 2. é…ç½®ç’°å¢ƒè®Šæ•¸

åœ¨ `.env` æ–‡ä»¶ä¸­æ·»åŠ ï¼š

```bash
GOOGLE_GEMINI_API_KEY=ä½ çš„_Gemini_API_å¯†é‘°
```

### 3. é‹è¡Œ OCR

#### æ¸¬è©¦å–®å¼µåœ–ç‰‡

```bash
# é€šç”¨ OCR
node ocr-gemini.js test data/media/åœ–ç‰‡å.jpg

# åç‰‡è­˜åˆ¥
node ocr-gemini.js test data/media/åç‰‡.jpg businessCard

# æ–‡æª”æå–
node ocr-gemini.js test data/media/æ–‡æª”.jpg document

# æ”¶æ“šè­˜åˆ¥
node ocr-gemini.js test data/media/æ”¶æ“š.jpg receipt
```

#### æ‰¹é‡è™•ç†

```bash
# è™•ç† 50 å¼µåœ–ç‰‡ï¼ˆé€šç”¨ OCRï¼‰
node ocr-gemini.js 50

# è™•ç† 100 å¼µåœ–ç‰‡ï¼ˆæ–‡æª”æ¨¡å¼ï¼‰
node ocr-gemini.js 100 document

# è™•ç†æ‰€æœ‰åœ–ç‰‡
node ocr-gemini.js 1718
```

---

## ğŸ“Š OCR çµæœå­˜å„²

OCR æå–çš„æ–‡å­—æœƒä¿å­˜åˆ° `rag_knowledge` è¡¨ï¼š

```javascript
{
  session_id: 'sess_id73sa6oi_1770363274857',
  source_type: 'image_ocr',
  source_id: 'åŸå§‹æ¶ˆæ¯ ID',
  content: 'æå–çš„æ–‡å­—å…§å®¹',
  metadata: {
    original_path: 'åŸå§‹åœ–ç‰‡è·¯å¾‘',
    from_name: 'ç™¼é€è€…',
    ocr_mode: 'general'
  }
}
```

ä¹‹å¾Œå¯ä»¥é€šéå‘é‡æœç´¢æ‰¾åˆ°é€™äº›æ–‡å­—å…§å®¹ï¼

---

## ğŸ” æœç´¢ OCR å…§å®¹

OCR è™•ç†å¾Œï¼Œæ‚¨å¯ä»¥æœç´¢åœ–ç‰‡ä¸­çš„æ–‡å­—ï¼š

```javascript
// ä½¿ç”¨ç¾æœ‰çš„æœç´¢è…³æœ¬
node test-vector-search.js "ç™¼ç¥¨"
node test-vector-search.js "é›»è©±è™Ÿç¢¼"
node test-vector-search.js "åœ°å€"
```

---

## ğŸ’¡ é€²éšåŠŸèƒ½

### 1. è‡ªå‹•åˆ¤æ–· OCR æ¨¡å¼

å¯ä»¥è®“ AI å…ˆåˆ¤æ–·åœ–ç‰‡é¡å‹ï¼Œå†é¸æ“‡åˆé©çš„ OCR æ¨¡å¼ï¼š

```javascript
async function smartOCR(imagePath) {
    // ç¬¬ä¸€æ­¥ï¼šåˆ¤æ–·åœ–ç‰‡é¡å‹
    const typeResult = await performOCR(imagePath, 'general');
    
    // ç¬¬äºŒæ­¥ï¼šæ ¹æ“šå…§å®¹é¸æ“‡æ¨¡å¼
    let mode = 'general';
    if (typeResult.text.includes('åç‰‡') || typeResult.text.includes('é›»è©±')) {
        mode = 'businessCard';
    } else if (typeResult.text.includes('ç™¼ç¥¨') || typeResult.text.includes('ç¸½é¡')) {
        mode = 'receipt';
    }
    
    // ç¬¬ä¸‰æ­¥ï¼šç”¨å°ˆé–€æ¨¡å¼é‡æ–°è™•ç†
    return await performOCR(imagePath, mode);
}
```

### 2. OCR + ç¿»è­¯

```javascript
const translatePrompt = `è«‹å…ˆæå–åœ–ç‰‡ä¸­çš„æ–‡å­—ï¼Œç„¶å¾Œç¿»è­¯æˆç¹é«”ä¸­æ–‡ã€‚
æ ¼å¼ï¼š
åŸæ–‡ï¼š[æå–çš„æ–‡å­—]
ç¿»è­¯ï¼š[ç¿»è­¯å¾Œçš„å…§å®¹]`;
```

### 3. OCR + æ•¸æ“šæå–

```javascript
const extractPrompt = `è«‹æå–åœ–ç‰‡ä¸­çš„æ‰€æœ‰è¯ç¹«ä¿¡æ¯ï¼Œä»¥ JSON æ ¼å¼è¼¸å‡ºï¼š
{
  "names": ["å§“å1", "å§“å2"],
  "phones": ["é›»è©±1", "é›»è©±2"],
  "emails": ["email1", "email2"],
  "addresses": ["åœ°å€1", "åœ°å€2"]
}`;
```

---

## ğŸ¯ æˆæœ¬ä¼°ç®—

### Gemini Vision OCR

- **å…è²»é¡åº¦**: 1500 æ¬¡/æœˆ
- **è¶…å‡ºå¾Œ**: ~$0.001/å¼µåœ–ç‰‡
- **1718 å¼µåœ–ç‰‡**: ç´„ $1.72ï¼ˆè¶…å‡ºå…è²»é¡åº¦éƒ¨åˆ†ï¼‰

### å¯¦éš›ä½¿ç”¨å»ºè­°

1. **å…ˆè™•ç† 1500 å¼µ**ï¼ˆå…è²»é¡åº¦å…§ï¼‰
2. **ä¸‹å€‹æœˆå†è™•ç†å‰©é¤˜çš„**ï¼ˆç¹¼çºŒå…è²»ï¼‰
3. **æˆ–è€…ä»˜è²»è™•ç†å…¨éƒ¨**ï¼ˆç¸½æˆæœ¬ < $2ï¼‰

---

## âœ… ç¸½çµ

### æ¨è–¦æ–¹æ¡ˆï¼šGemini Vision OCR

- âœ… æ‚¨å·²ç¶“æœ‰ API Key
- âœ… è³ªé‡æœ€å¥½
- âœ… æˆæœ¬æœ€ä½
- âœ… æ”¯æŒå¤šç¨®æ–‡æª”é¡å‹
- âœ… å¯ä»¥ç†è§£ä¸Šä¸‹æ–‡

### ç«‹å³é–‹å§‹

1. ç¢ºä¿ `.env` ä¸­æœ‰ `GOOGLE_GEMINI_API_KEY`
2. é‹è¡Œæˆ‘æä¾›çš„è…³æœ¬
3. é¸æ“‡åˆé©çš„ OCR æ¨¡å¼
4. é–‹å§‹æå–æ–‡å­—ï¼

éœ€è¦æˆ‘ç‚ºæ‚¨å‰µå»ºå¯¦éš›çš„é‹è¡Œè…³æœ¬å—ï¼Ÿ ğŸš€
