# WhatsApp 群組消息同步說明

## 問題現象

部分群組（如 "AiTLE 20/11 SolnShow PRT"）顯示「暫無訊息」。

## 根本原因

### WhatsApp 歷史同步限制

1. **自動歷史同步有限制**
   - WhatsApp 服務器只會在第一次連接時發送一次歷史同步通知
   - 歷史同步有20秒超時限制（Baileys 庫內部限制）
   - 本系統實際只同步了 **1,370 / 4,423** 條歷史消息
   - 剩餘的 **3,053** 條消息未被包含在歷史同步中

2. **WhatsApp 的同步策略**
   - 優先同步最近活躍的對話
   - 不活躍的群組可能被跳過
   - 大量群組（1254個）時，無法一次性同步所有歷史

## 技術細節

### 歷史同步日志

```
[sess_aqvjddrte_1770264874287] History sync is enabled, awaiting notification with a 20s timeout.
[sess_aqvjddrte_1770264874287] Timeout in AwaitingInitialSync, forcing state to Online
[sess_aqvjddrte_1770264874287] Received 1254 group updates
[sess_aqvjddrte_1770264874287] Saved 1370/4423 history messages...
```

### 已驗證的事實

- ✅ 群組存在於聯系人列表中（JID: `120363019503865721@g.us`）
- ✅ 群組信息已正確保存到數據庫
- ❌ 該群組的歷史消息未被歷史同步包含
- ✅ 系統現在可以接收該群組的新消息

## 解決方案

### 1. 自動解決（推薦）

**一旦有人在這些群組中發送新消息，系統會自動：**
- 接收並存儲新消息
- 更新群組的最後活躍時間
- 該群組將正常顯示消息

### 2. 優化措施

我們已經實施了以下優化：

1. **增加超時時間**
   - 連接超時：120秒 → 300秒（5分鐘）
   - 查詢超時：120秒 → 300秒（5分鐘）

2. **增強日志記錄**
   - 詳細的歷史同步進度日志
   - 每批次消息保存的統計
   - 總同步消息數追蹤

3. **添加手動重啟 API**
   ```bash
   POST /api/session/:id/restart
   ```
   可以重啟會話觸發重新同步（但由於 WhatsApp 限制，可能不會獲得更多歷史消息）

### 3. 數據庫優先加載

系統已配置為：
- 優先從 Supabase 數據庫加載歷史消息
- 新消息實時存儲到數據庫
- 刷新頁面會顯示數據庫中的所有消息

## 測試驗證

### 檢查群組狀態

```bash
# 檢查群組是否在聯系人列表
curl -s http://localhost:3000/api/session/sess_aqvjddrte_1770264874287/contacts | grep "120363019503865721@g.us"

# 檢查群組消息數
curl -s http://localhost:3000/api/session/sess_aqvjddrte_1770264874287/messages/120363019503865721@g.us | python3 -c "import sys,json; print(f'消息數: {len(json.load(sys.stdin))}')"
```

## 建議

1. **耐心等待新消息**
   - 系統已優化，可以正常接收新消息
   - 一旦有人在群組中發言，消息會自動顯示

2. **重要群組優先**
   - 活躍群組的消息會被優先同步
   - 可以在重要群組中發送測試消息來激活

3. **定期檢查**
   - 查看 PM2 日志確認消息接收正常
   - 監控數據庫消息增長

## 相關文件

- `server.js` - 歷史同步邏輯（第 394-500 行）
- `deploy.sh` - 自動部署腳本
- `數據加載優化說明.md` - 數據加載策略

## 更新歷史

- 2026-02-05: 初次記錄問題和解決方案
- 2026-02-05: 增加超時時間和詳細日志
- 2026-02-05: 添加手動重啟 API（受 WhatsApp 限制影響）
