# WhatsApp 自動重連和同步說明

## 功能概述

系統現已具備**完整的自動重連和消息同步機制**，確保 WhatsApp 連接穩定運行。

## 核心功能

### 1. 🔄 智能自動重連

#### 重連策略
- **指數退避算法**：每次重連延遲時間逐漸增加
  - 第 1 次：3 秒
  - 第 2 次：6 秒
  - 第 3 次：12 秒
  - 第 4 次：24 秒
  - 最多延遲：60 秒
  
- **重連限制**：最多嘗試 10 次
- **自動觸發**：連接斷開時自動開始重連
- **日志記錄**：每次重連嘗試都有詳細日志

#### 重連觸發條件
- ✅ 網絡波動導致斷線
- ✅ WhatsApp 服務器臨時不可用
- ✅ WebSocket 連接超時
- ❌ 不重連：手動登出

### 2. 💓 心跳檢測

#### 功能
- **檢測頻率**：每 30 秒檢查一次
- **檢測內容**：
  - WebSocket 連接狀態
  - 會話運行時間
  - 連接健康度

#### 日志輸出示例
```
[sess_xxx] 💓 心跳正常 (運行時間: 15 分鐘)
```

### 3. 🔍 自動健康檢查

- **檢查頻率**：每 5 分鐘
- **檢查內容**：所有會話的連接狀態
- **自動修復**：發現斷開的會話自動重連

### 4. 🛡️ 進程保護

#### PM2 自動重啟配置

**配置文件**：`ecosystem.config.js`

```javascript
{
  autorestart: true,              // 進程崩潰自動重啟
  max_memory_restart: '1G',       // 內存超過 1GB 自動重啟
  max_restarts: 10,               // 1分鐘內最多重啟10次
  restart_delay: 4000,            // 重啟延遲 4 秒
  exp_backoff_restart_delay: 100, // 指數退避
  cron_restart: '0 3 * * *'       // 每天凌晨 3 點自動重啟
}
```

#### 優雅退出
- 收到 SIGINT/SIGTERM 信號時
- 自動關閉所有 WhatsApp 連接
- 清理心跳定時器
- 確保數據完整性

### 5. 📝 詳細日志

#### 連接狀態日志
```
[sess_xxx] ✅ 連接成功
[sess_xxx] 💓 啟動心跳檢測 (每 30 秒)
[sess_xxx] 🔄 將在 6 秒後重連 (第 2/10 次嘗試)
[sess_xxx] ❌ 超過最大重連次數 (10), 停止重連
```

#### 自動檢查日志
```
🔍 檢查所有會話狀態...
[sess_xxx] 檢測到斷開的會話，嘗試重新連接...
```

## 使用方法

### 啟動服務（使用 PM2 配置文件）

```bash
# 首次啟動
pm2 start ecosystem.config.js

# 保存配置
pm2 save

# 設置開機自啟
pm2 startup
```

### 查看運行狀態

```bash
# 查看所有進程
pm2 list

# 查看詳細信息
pm2 show whatsapp-bot

# 查看日志
pm2 logs whatsapp-bot

# 實時監控
pm2 monit
```

### 手動管理

```bash
# 重啟（會自動重連所有會話）
pm2 restart whatsapp-bot

# 停止
pm2 stop whatsapp-bot

# 刪除進程
pm2 delete whatsapp-bot
```

## API 端點

### 手動重啟會話

```bash
POST /api/session/:id/restart
```

**功能**：
- 關閉現有連接
- 等待 2 秒
- 重新建立連接
- 自動開始歷史同步

**使用示例**：
```bash
curl -X POST http://localhost:3000/api/session/sess_xxx/restart
```

## 配置參數

### 修改重連配置

在 `server.js` 中：

```javascript
const RECONNECT_CONFIG = {
    maxAttempts: 10,        // 最大重連次數
    baseDelay: 3000,        // 基礎延遲（毫秒）
    maxDelay: 60000,        // 最大延遲（毫秒）
    heartbeatInterval: 30000 // 心跳間隔（毫秒）
};
```

### 修改自動檢查頻率

在 `server.js` 底部修改：

```javascript
setInterval(async () => {
    // 自動檢查邏輯
}, 5 * 60 * 1000); // 5 分鐘 = 5 * 60 * 1000 毫秒
```

## 故障排查

### 問題 1：重連次數耗盡

**現象**：
```
[sess_xxx] ❌ 超過最大重連次數 (10), 停止重連
```

**解決方案**：
1. 檢查網絡連接
2. 檢查 WhatsApp 帳號狀態
3. 手動重啟會話：
   ```bash
   curl -X POST http://localhost:3000/api/session/sess_xxx/restart
   ```

### 問題 2：心跳檢測異常

**現象**：
```
[sess_xxx] ⚠️ WebSocket 狀態異常 (3), 可能需要重連
```

**解決方案**：
- 系統會自動重連
- 如未自動恢復，執行 `pm2 restart whatsapp-bot`

### 問題 3：進程頻繁重啟

**檢查**：
```bash
pm2 logs whatsapp-bot --lines 100
```

**可能原因**：
- 內存洩漏（已配置 1GB 限制）
- 未捕獲的錯誤（已添加處理）
- 端口衝突

## 監控建議

### 1. PM2 監控
```bash
pm2 monit
```

### 2. 日志監控
```bash
# 實時查看
pm2 logs whatsapp-bot --lines 50

# 只看錯誤
pm2 logs whatsapp-bot --err

# 保存日志
pm2 logs whatsapp-bot > whatsapp-logs.txt
```

### 3. 健康檢查腳本

創建 `health-check.sh`：

```bash
#!/bin/bash

# 檢查進程狀態
pm2 jlist | jq '.[] | select(.name=="whatsapp-bot") | {
  name: .name,
  status: .pm2_env.status,
  uptime: .pm2_env.pm_uptime,
  restarts: .pm2_env.restart_time,
  memory: .monit.memory
}'
```

## 性能優化

### 1. 內存管理
- 自動在 1GB 時重啟
- 定時清理緩存
- 優化消息處理

### 2. 連接管理
- 心跳保持活躍
- 自動重連減少人工介入
- 指數退避避免頻繁重連

### 3. 日志管理
```bash
# 清理舊日志
pm2 flush

# 配置日志輪轉
pm2 install pm2-logrotate
pm2 set pm2-logrotate:max_size 10M
pm2 set pm2-logrotate:retain 7
```

## 總結

✅ **自動重連**：網絡斷開自動恢復  
✅ **心跳檢測**：實時監控連接健康  
✅ **自動檢查**：定期修復斷開的會話  
✅ **進程保護**：PM2 確保服務持續運行  
✅ **優雅退出**：安全關閉所有連接  
✅ **詳細日志**：方便問題排查  

系統現在可以**完全自動化**地維持 WhatsApp 連接，無需人工干預！

## 相關文件

- `server.js` - 核心邏輯和重連機制
- `ecosystem.config.js` - PM2 配置文件
- `deploy.sh` - 自動部署腳本

## 更新歷史

- 2026-02-05: 初次創建完整的自動重連系統
- 2026-02-05: 添加心跳檢測和自動健康檢查
- 2026-02-05: 配置 PM2 自動重啟和優雅退出
