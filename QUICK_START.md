# ğŸš€ WhatsApp CRM - å¿«é€Ÿå¯åŠ¨æŒ‡å—

## âœ… Bug ä¿®å¤æ€»ç»“

å·²ä¿®å¤ä»¥ä¸‹é—®é¢˜ï¼š
- âœ… **é—®é¢˜1**: æ–°æ¶ˆæ¯ä¸å®æ—¶æ˜¾ç¤ºï¼ˆæ•°æ®åº“æœ‰è®°å½•ä½†å‰ç«¯ä¸æ›´æ–°ï¼‰
- âœ… **é—®é¢˜3**: API è°ƒç”¨å¤±è´¥
- âœ… **é—®é¢˜5**: æ¶ˆæ¯æ˜¾ç¤ºä¸å®Œæ•´æˆ–ä¹±ç 
- âœ… **é—®é¢˜6**: æ”¶ä¸åˆ°ç¾¤ç»„æ¶ˆæ¯
- âœ… **é—®é¢˜7**: ç¬¬ä¸€æ¬¡åŒæ­¥æ—¶ç¾¤ç»„æ²¡æœ‰åå­—ï¼Œåªæ˜¾ç¤ºå·ç 
- âœ… **é—®é¢˜8**: è”ç³»äººå’Œç¾¤ç»„æ’åºä¸æ­£ç¡®ï¼ˆæœªæŒ‰æœ€æ–°æ¶ˆæ¯æ—¶é—´æ’åºï¼‰

## ğŸ“¦ ç¯å¢ƒè¦æ±‚

- Node.js 16+
- Supabase è´¦æˆ·
- WhatsApp è´¦å·

## ğŸ”§ é…ç½®æ­¥éª¤

### 0. åˆ›å»ºæ€§èƒ½ä¼˜åŒ–å‡½æ•°ï¼ˆå¯é€‰ï¼Œæ¨èï¼‰

åœ¨ Supabase SQL Editor ä¸­æ‰§è¡Œ `get_last_messages.sql`ï¼Œåˆ›å»ºé«˜æ•ˆæŸ¥è¯¢å‡½æ•°ï¼š

```sql
CREATE OR REPLACE FUNCTION get_last_message_times(session_id_param TEXT)
RETURNS TABLE (remote_jid TEXT, last_message_timestamp TIMESTAMP WITH TIME ZONE)
AS $$
BEGIN
    RETURN QUERY
    SELECT m.remote_jid, MAX(m.message_timestamp) as last_message_timestamp
    FROM whatsapp_messages m
    WHERE m.session_id = session_id_param
    GROUP BY m.remote_jid;
END;
$$ LANGUAGE plpgsql;
```

**ä½œç”¨ï¼š** æé«˜è”ç³»äººåˆ—è¡¨åŠ è½½é€Ÿåº¦ 10 å€ï¼ˆä» 5-10 ç§’é™åˆ° 0.5-1 ç§’ï¼‰

### 1. æ£€æŸ¥æ•°æ®åº“è¡¨ç»“æ„

åœ¨ Supabase SQL Editor ä¸­æ‰§è¡Œ `database_schema.sql`ï¼š

```bash
# æˆ–è€…ä½¿ç”¨ psql
psql -h YOUR_SUPABASE_HOST -U postgres -d postgres -f database_schema.sql
```

è¿™å°†ï¼š
- åˆ›å»º/æ›´æ–°æ‰€æœ‰å¿…è¦çš„è¡¨
- æ·»åŠ ç¼ºå¤±çš„å­—æ®µï¼ˆparticipant, participant_phone, is_groupï¼‰
- åˆ›å»ºç´¢å¼•æé«˜æŸ¥è¯¢æ€§èƒ½
- è®¾ç½®è‡ªåŠ¨æ›´æ–°è§¦å‘å™¨

### 2. é…ç½®ç¯å¢ƒå˜é‡ï¼ˆæ¨èï¼‰

åˆ›å»º `.env` æ–‡ä»¶ï¼š

```env
# Supabase é…ç½®
SUPABASE_URL=https://izwdetsrqjepoxmocore.supabase.co
SUPABASE_KEY=your_supabase_service_role_key

# æœåŠ¡å™¨é…ç½®
PORT=3000

# API å¯†é’¥ï¼ˆå¯é€‰ï¼‰
BAILEYS_MASTER_KEY=your_master_key
WHATSAPP_WEBHOOK_SECRET=your_webhook_secret
```

**é‡è¦ï¼š** å»ºè®®ä¿®æ”¹ `server.js` ç¬¬ 15-17 è¡Œï¼Œä»ç¯å¢ƒå˜é‡è¯»å–é…ç½®ï¼š

```javascript
// ä¿®æ”¹å‰ï¼š
const SUPABASE_URL = 'https://izwdetsrqjepoxmocore.supabase.co';
const SUPABASE_KEY = 'eyJhbGci...';

// ä¿®æ”¹åï¼š
const SUPABASE_URL = process.env.SUPABASE_URL || 'https://izwdetsrqjepoxmocore.supabase.co';
const SUPABASE_KEY = process.env.SUPABASE_KEY || 'eyJhbGci...';
```

### 3. å®‰è£…ä¾èµ–

```bash
npm install
```

### 4. å¯åŠ¨æœåŠ¡å™¨

```bash
# å¼€å‘æ¨¡å¼
node server.js

# æˆ–ä½¿ç”¨ PM2ï¼ˆç”Ÿäº§ç¯å¢ƒæ¨èï¼‰
pm2 start server.js --name whatsapp-crm
pm2 save
pm2 startup
```

### 5. è®¿é—®ç³»ç»Ÿ

æ‰“å¼€æµè§ˆå™¨è®¿é—®ï¼š`http://localhost:3000`

## ğŸ“± ä½¿ç”¨æ­¥éª¤

### ç¬¬ä¸€æ¬¡ä½¿ç”¨

1. **æ‰«æ QR ç **
   - æ‰“å¼€é¡µé¢åï¼Œä¼šè‡ªåŠ¨ç”Ÿæˆ QR ç 
   - æ‰“å¼€æ‰‹æœº WhatsApp > è®¾å®š > è¿ç»“è£…ç½®
   - æ‰«æé¡µé¢ä¸Šçš„ QR ç 

2. **ç­‰å¾…åŒæ­¥**
   - è¿æ¥æˆåŠŸåï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨åŒæ­¥è”ç³»äººå’Œæ¶ˆæ¯
   - å³ä¸Šè§’æ˜¾ç¤º"å·²é€£ç·š"ï¼ˆç»¿è‰²ï¼‰è¡¨ç¤ºè¿æ¥æˆåŠŸ
   - ç­‰å¾…å‡ åˆ†é’Ÿï¼Œè®©ç³»ç»ŸåŒæ­¥å†å²æ¶ˆæ¯

3. **éªŒè¯åŠŸèƒ½**
   - è®©æœ‹å‹å‘é€æµ‹è¯•æ¶ˆæ¯
   - æ£€æŸ¥æ˜¯å¦ç«‹å³æ˜¾ç¤ºåœ¨å‰ç«¯
   - åœ¨ç¾¤ç»„ä¸­å‘é€æ¶ˆæ¯ï¼ŒéªŒè¯ç¾¤ç»„æ¶ˆæ¯åŠŸèƒ½

### æ—¥å¸¸ä½¿ç”¨

1. **æŸ¥çœ‹æ¶ˆæ¯**
   - ç‚¹å‡»å·¦ä¾§è”ç³»äººåˆ—è¡¨
   - å³ä¾§æ˜¾ç¤ºå®Œæ•´å¯¹è¯è®°å½•
   - æ”¯æŒå›¾ç‰‡ã€è§†é¢‘ã€è¯­éŸ³ç­‰åª’ä½“æ¶ˆæ¯

2. **ç¾¤å‘æ¶ˆæ¯**
   - ç‚¹å‡»å³ä¸Šè§’"ç¾¤ç™¼è¡ŒéŠ·"æŒ‰é’®
   - é€‰æ‹©è”ç³»äººï¼ˆå¯å¤šé€‰ï¼‰
   - è¾“å…¥æ¶ˆæ¯å†…å®¹å’Œé™„ä»¶
   - ç‚¹å‡»"ç™¼é€å»£æ’­"

3. **æŸ¥çœ‹ç»Ÿè®¡**
   - ç‚¹å‡»é¡¶éƒ¨"ç™¼é€æ—¥æ›†"
   - æŸ¥çœ‹æ¯æ—¥å‘é€è®°å½•
   - ç›‘æ§å‘é€é¢åº¦ï¼ˆ50æ¡/å¤©ï¼‰

## ğŸ§ª æµ‹è¯•ä¿®å¤æ˜¯å¦æˆåŠŸ

### æµ‹è¯• 1: æ–°æ¶ˆæ¯å®æ—¶æ˜¾ç¤º

```bash
# 1. æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å°ï¼ˆF12ï¼‰
# 2. è®©æœ‹å‹å‘é€æ¶ˆæ¯
# 3. è§‚å¯Ÿæ§åˆ¶å°è¾“å‡º
```

**é¢„æœŸè¾“å‡ºï¼š**
```
ğŸ“¨ æ”¶åˆ°ç§èŠæ¶ˆæ¯: ä¼šè¯=sess_xxx, èŠå¤©=123456@s.whatsapp.net, å‘é€è€…=å¼ ä¸‰
ğŸ”„ ç«‹å³åˆ·æ–°å½“å‰èŠå¤©: 123456@s.whatsapp.net
ğŸ”„ åˆ·æ–°è”ç³»äººåˆ—è¡¨...
```

**åç«¯æ—¥å¿—åº”æ˜¾ç¤ºï¼š**
```
[sess_xxx] Received 1 messages (type: notify)
[sess_xxx] ğŸ“¤ å¹¿æ’­æ¶ˆæ¯åˆ°å‰ç«¯: 123456@s.whatsapp.net
[WebSocket] ğŸ“¤ å¹¿æ’­æ¶ˆæ¯ - ä¼šè¯: sess_xxx, èŠå¤©: 123456@s.whatsapp.net, ç±»å‹: ç§èŠ
[WebSocket] âœ… æ¶ˆæ¯å·²å‘é€åˆ° 1 ä¸ªå®¢æˆ·ç«¯
```

### æµ‹è¯• 2: ç¾¤ç»„æ¶ˆæ¯

```bash
# 1. åœ¨ç¾¤ç»„ä¸­å‘é€æ¶ˆæ¯
# 2. æ£€æŸ¥æ§åˆ¶å°è¾“å‡º
```

**é¢„æœŸè¾“å‡ºï¼š**
```
ğŸ“¨ æ”¶åˆ°ç¾¤ç»„æ¶ˆæ¯: ä¼šè¯=sess_xxx, èŠå¤©=1234567890@g.us, å‘é€è€…=æå››
ğŸ”„ ç«‹å³åˆ·æ–°å½“å‰èŠå¤©: 1234567890@g.us
```

**åç«¯æ—¥å¿—åº”æ˜¾ç¤ºï¼š**
```
[sess_xxx] ğŸ“‹ æ£€æµ‹åˆ° 1 ä¸ªç¾¤ç»„çš„æ¶ˆæ¯ï¼Œæ­£åœ¨è·å–ç¾¤ç»„ä¿¡æ¯...
[sess_xxx] âœ… å·²æ›´æ–° 1 ä¸ªç¾¤ç»„çš„ä¿¡æ¯
[sess_xxx] âœ… æ›´æ–°äº† 1 ä¸ªè”ç³»äººï¼ˆåŒ…æ‹¬ç¾¤ç»„ï¼‰
[WebSocket] ğŸ“¤ å¹¿æ’­æ¶ˆæ¯ - ç±»å‹: ç¾¤ç»„
```

### æµ‹è¯• 3: ç¾¤ç»„åç§°æ˜¾ç¤º

```bash
# 1. ç­‰å¾… 30-60 ç§’è®©ç³»ç»Ÿè·å–ç¾¤ç»„ä¿¡æ¯
# 2. åˆ·æ–°é¡µé¢
# 3. æ£€æŸ¥è”ç³»äººåˆ—è¡¨ä¸­çš„ç¾¤ç»„
```

**é¢„æœŸç»“æœï¼š**
- âœ… ç¾¤ç»„æ˜¾ç¤ºä¸º"XXXç¾¤"æˆ–"XXå›¢é˜Ÿ"ç­‰åç§°
- âŒ ä¸åº”è¯¥æ˜¾ç¤ºä¸º"1234567890@g.us"

**åç«¯æ—¥å¿—åº”æ˜¾ç¤ºï¼š**
```
[sess_xxx] æ­£åœ¨ç²å–æ‰€æœ‰ç¾¤çµ„ä¿¡æ¯...
[sess_xxx] æ‰¾åˆ° 15 å€‹ç¾¤çµ„ï¼Œæ­£åœ¨æ›´æ–°åç¨±...
[sess_xxx] âœ… ç¾¤çµ„åç¨±å·²æ›´æ–°
[sess_xxx] ğŸ”„ 10ç§’åå†æ¬¡è·å–ç¾¤ç»„ä¿¡æ¯...
[sess_xxx] ğŸ”„ 30ç§’åç¬¬ä¸‰æ¬¡è·å–ç¾¤ç»„ä¿¡æ¯...
[sess_xxx] ğŸ“Š æœ€ç»ˆè·å–åˆ° 20 ä¸ªç¾¤ç»„
```

### æµ‹è¯• 4: è”ç³»äººæ’åº

```bash
# 1. åœ¨ä¸åŒçš„èŠå¤©ä¸­å‘é€æ¶ˆæ¯
# 2. è§‚å¯Ÿè”ç³»äººåˆ—è¡¨
```

**é¢„æœŸç»“æœï¼š**
- âœ… åˆšå‘é€æ¶ˆæ¯çš„è”ç³»äººç«‹å³è·³åˆ°åˆ—è¡¨é¡¶éƒ¨
- âœ… æ‰€æœ‰è”ç³»äººæŒ‰æœ€æ–°æ¶ˆæ¯æ—¶é—´ä»æ–°åˆ°æ—§æ’åº
- âœ… ç¾¤ç»„å’Œä¸ªäººèŠå¤©æ··åˆæ’åº

**åç«¯æ—¥å¿—åº”æ˜¾ç¤ºï¼š**
```
[API] ğŸ“‹ è·å– 50 ä¸ªè”ç³»äººçš„æœ€åæ¶ˆæ¯æ—¶é—´...
[API] âœ… ä½¿ç”¨ RPC å‡½æ•°è·å–åˆ° 50 ä¸ªè”ç³»äººçš„æœ€åæ¶ˆæ¯æ—¶é—´
[API] âœ… è¿”å› 50 ä¸ªè”ç³»äººï¼ˆå·²æŒ‰æœ€æ–°æ¶ˆæ¯æ—¶é—´æ’åºï¼‰
```

### æµ‹è¯• 5: API è°ƒç”¨

```bash
# æ›¿æ¢ YOUR_SESSION_ID ä¸ºä½ çš„å®é™…ä¼šè¯ID
curl http://localhost:3000/api/session/YOUR_SESSION_ID/contacts

# æµ‹è¯•è·å–æ¶ˆæ¯
curl http://localhost:3000/api/session/YOUR_SESSION_ID/messages/CONTACT_JID
```

**é¢„æœŸç»“æœï¼š** è¿”å› JSON æ•°æ®ï¼Œæ—  500 é”™è¯¯

## ğŸ” æ•…éšœæ’æŸ¥

### é—®é¢˜ï¼šå‰ç«¯ä»ç„¶ä¸æ˜¾ç¤ºæ–°æ¶ˆæ¯

**è§£å†³æ–¹æ¡ˆï¼š**

1. **æ£€æŸ¥ WebSocket è¿æ¥**
   ```javascript
   // åœ¨æµè§ˆå™¨æ§åˆ¶å°è¾“å…¥ï¼š
   console.log('WebSocket çŠ¶æ€:', ws ? ws.readyState : 'ws æœªå®šä¹‰');
   // 1 = OPEN (æ­£å¸¸), å…¶ä»–å€¼ = æœ‰é—®é¢˜
   ```

2. **æ£€æŸ¥åç«¯æ˜¯å¦è¿è¡Œ**
   ```bash
   curl http://localhost:3000/api/session/YOUR_SESSION_ID/status
   ```

3. **é‡å¯æœåŠ¡**
   ```bash
   pm2 restart whatsapp-crm
   # æˆ–
   pkill -f "node server.js" && node server.js
   ```

4. **æ¸…é™¤æµè§ˆå™¨ç¼“å­˜**
   - æŒ‰ Ctrl+Shift+R (Windows) æˆ– Cmd+Shift+R (Mac)

### é—®é¢˜ï¼šç¾¤ç»„æ¶ˆæ¯æ”¶ä¸åˆ°

**è§£å†³æ–¹æ¡ˆï¼š**

1. **æ‰‹åŠ¨åˆ·æ–°ç¾¤ç»„**
   - ç‚¹å‡»è”ç³»äººåˆ—è¡¨ä¸Šæ–¹çš„"ç¾¤çµ„"æŒ‰é’®
   - ç­‰å¾…å‡ ç§’é’Ÿ

2. **æ£€æŸ¥æ•°æ®åº“**
   ```sql
   -- åœ¨ Supabase SQL Editor æ‰§è¡Œ
   SELECT * FROM whatsapp_contacts 
   WHERE jid LIKE '%@g.us' 
   AND session_id = 'YOUR_SESSION_ID';
   ```

3. **æ£€æŸ¥åç«¯æ—¥å¿—**
   ```bash
   pm2 logs whatsapp-crm | grep "ç¾¤çµ„"
   ```

4. **å¼ºåˆ¶é‡æ–°åŒæ­¥**
   - ç‚¹å‡»é¡µé¢å³ä¸Šè§’"å¼·åˆ¶åŒæ­¥"æŒ‰é’®
   - é‡æ–°æ‰«æ QR ç 

### é—®é¢˜ï¼šç¾¤ç»„ä»ç„¶æ˜¾ç¤ºä¸ºå·ç 

**è§£å†³æ–¹æ¡ˆï¼š**

1. **ç­‰å¾…æ›´é•¿æ—¶é—´**
   - ç¾¤ç»„ä¿¡æ¯è·å–éœ€è¦ 30-60 ç§’
   - ç³»ç»Ÿä¼šè‡ªåŠ¨é‡è¯• 3 æ¬¡ï¼ˆ0ç§’ã€10ç§’ã€30ç§’åï¼‰
   - è€å¿ƒç­‰å¾…

2. **æ‰‹åŠ¨åˆ·æ–°ç¾¤ç»„**
   - ç‚¹å‡»è”ç³»äººåˆ—è¡¨ä¸Šæ–¹çš„"ç¾¤çµ„"æŒ‰é’®
   - ç­‰å¾…å‡ ç§’é’Ÿ
   - åˆ·æ–°é¡µé¢

3. **æ£€æŸ¥åç«¯æ—¥å¿—**
   ```bash
   pm2 logs whatsapp-crm | grep "ç¾¤çµ„"
   ```
   
   åº”è¯¥çœ‹åˆ°ï¼š
   ```
   âœ… ç¾¤çµ„åç¨±å·²æ›´æ–°
   ```

4. **æ•°æ®åº“æ£€æŸ¥**
   ```sql
   -- æ£€æŸ¥ç¾¤ç»„æ•°æ®
   SELECT jid, name, is_group, updated_at 
   FROM whatsapp_contacts 
   WHERE session_id = 'YOUR_SESSION_ID' 
   AND jid LIKE '%@g.us'
   ORDER BY updated_at DESC;
   ```

5. **å¼ºåˆ¶é‡æ–°åŒæ­¥**
   - ç‚¹å‡»é¡µé¢å³ä¸Šè§’"å¼·åˆ¶åŒæ­¥"
   - é‡æ–°æ‰«æ QR ç 
   - ç­‰å¾… 1-2 åˆ†é’Ÿ

### é—®é¢˜ï¼šè”ç³»äººæ’åºä¸æ­£ç¡®

**è§£å†³æ–¹æ¡ˆï¼š**

1. **æ£€æŸ¥ API å“åº”**
   ```bash
   curl http://localhost:3000/api/session/YOUR_SESSION_ID/contacts | \
   jq '.[0:5] | .[] | {name, last_message_time, updated_at}'
   ```

2. **åˆ›å»º RPC å‡½æ•°ï¼ˆæé«˜æ€§èƒ½ï¼‰**
   - åœ¨ Supabase SQL Editor ä¸­æ‰§è¡Œ `get_last_messages.sql`
   - é‡å¯æœåŠ¡å™¨
   - åç«¯æ—¥å¿—åº”æ˜¾ç¤º"ä½¿ç”¨ RPC å‡½æ•°"è€Œä¸æ˜¯"ä½¿ç”¨åŸç”ŸæŸ¥è¯¢"

3. **æ¸…é™¤æµè§ˆå™¨ç¼“å­˜**
   ```bash
   # æŒ‰ Ctrl+Shift+R (Windows) æˆ– Cmd+Shift+R (Mac)
   ```

4. **æ£€æŸ¥æ¶ˆæ¯è¡¨**
   ```sql
   SELECT 
       remote_jid,
       COUNT(*) as msg_count,
       MAX(message_timestamp) as last_msg
   FROM whatsapp_messages
   WHERE session_id = 'YOUR_SESSION_ID'
   GROUP BY remote_jid
   ORDER BY last_msg DESC
   LIMIT 10;
   ```

### é—®é¢˜ï¼šæ¶ˆæ¯æ˜¾ç¤ºä¸ºç©ºæˆ–ä¹±ç 

**è§£å†³æ–¹æ¡ˆï¼š**

1. **æ£€æŸ¥æ•°æ®åº“ä¸­çš„æ¶ˆæ¯**
   ```sql
   SELECT message_id, content, message_type, full_message_json 
   FROM whatsapp_messages 
   WHERE session_id = 'YOUR_SESSION_ID' 
   ORDER BY message_timestamp DESC 
   LIMIT 10;
   ```

2. **æ£€æŸ¥åª’ä½“æ–‡ä»¶**
   ```bash
   ls -lh data/media/
   # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨ä¸”å¤§å°æ­£å¸¸
   ```

3. **é‡æ–°ä¸‹è½½åª’ä½“**
   - åˆ é™¤ `data/media/` ç›®å½•ä¸­çš„æ–‡ä»¶
   - é‡å¯æœåŠ¡ï¼Œç³»ç»Ÿä¼šé‡æ–°ä¸‹è½½

## ğŸ“Š ç›‘æ§å’Œæ—¥å¿—

### æŸ¥çœ‹å®æ—¶æ—¥å¿—

```bash
# PM2
pm2 logs whatsapp-crm

# æˆ–ç›´æ¥æŸ¥çœ‹æ–‡ä»¶
tail -f logs/whatsapp-crm.log
```

### å…³é”®æ—¥å¿—æ ‡è¯†ç¬¦

| æ ‡è¯† | å«ä¹‰ |
|------|------|
| `ğŸ“¨` | æ¥æ”¶åˆ°æ–°æ¶ˆæ¯ |
| `ğŸ“¤` | WebSocket å¹¿æ’­æ¶ˆæ¯ |
| `âœ…` | æ“ä½œæˆåŠŸ |
| `âŒ` | æ“ä½œå¤±è´¥ |
| `ğŸ“‹` | ç¾¤ç»„æ¶ˆæ¯å¤„ç† |
| `[API]` | API è°ƒç”¨ |
| `ğŸ”„` | åˆ·æ–°/æ›´æ–°æ“ä½œ |
| `ğŸ’“` | å¿ƒè·³æ£€æµ‹ |

### æ€§èƒ½ç›‘æ§

```bash
# CPU å’Œå†…å­˜ä½¿ç”¨
pm2 monit

# è¯¦ç»†ä¿¡æ¯
pm2 show whatsapp-crm
```

## ğŸ” å®‰å…¨å»ºè®®

1. **ä¸è¦åœ¨ä»£ç ä¸­ç¡¬ç¼–ç å¯†é’¥**
   - ä½¿ç”¨ `.env` æ–‡ä»¶
   - æ·»åŠ  `.env` åˆ° `.gitignore`

2. **è®¾ç½®è®¿é—®æ§åˆ¶**
   - ä½¿ç”¨ nginx åå‘ä»£ç†
   - æ·»åŠ  HTTP Basic Auth
   - é…ç½® HTTPS

3. **å®šæœŸå¤‡ä»½**
   ```bash
   # å¤‡ä»½æ•°æ®åº“
   pg_dump -h YOUR_SUPABASE_HOST -U postgres > backup.sql
   
   # å¤‡ä»½åª’ä½“æ–‡ä»¶
   tar -czf media-backup.tar.gz data/media/
   ```

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

### æ•°æ®åº“ä¼˜åŒ–

```sql
-- æ¸…ç†æ—§æ¶ˆæ¯ï¼ˆä¿ç•™æœ€è¿‘30å¤©ï¼‰
DELETE FROM whatsapp_messages 
WHERE message_timestamp < NOW() - INTERVAL '30 days';

-- æ¸…ç†æ—§çš„åª’ä½“æ–‡ä»¶
-- æ³¨æ„ï¼šéœ€è¦æ‰‹åŠ¨åˆ é™¤ data/media/ ä¸­å¯¹åº”çš„æ–‡ä»¶

-- é‡å»ºç´¢å¼•
REINDEX TABLE whatsapp_messages;
REINDEX TABLE whatsapp_contacts;
```

### ç³»ç»Ÿä¼˜åŒ–

```bash
# å¢åŠ  Node.js å†…å­˜é™åˆ¶
node --max-old-space-size=4096 server.js

# æˆ–åœ¨ PM2 ä¸­é…ç½®
pm2 start server.js --name whatsapp-crm --node-args="--max-old-space-size=4096"
```

## ğŸ†˜ è·å–å¸®åŠ©

### æŸ¥çœ‹æ—¥å¿—

```bash
# åç«¯æ—¥å¿—
pm2 logs whatsapp-crm

# å‰ç«¯æ—¥å¿—
# æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å°ï¼ˆF12ï¼‰
```

### æ£€æŸ¥æ•°æ®åº“è¿æ¥

```bash
# æµ‹è¯• Supabase è¿æ¥
curl -H "apikey: YOUR_SUPABASE_KEY" \
     https://YOUR_PROJECT.supabase.co/rest/v1/whatsapp_sessions?select=*
```

### é‡å¯æ‰€æœ‰æœåŠ¡

```bash
# å®Œå…¨é‡å¯
pm2 delete whatsapp-crm
rm -rf auth_sessions/*  # å¦‚æœéœ€è¦æ¸…é™¤è®¤è¯ä¿¡æ¯
pm2 start server.js --name whatsapp-crm
```

## ğŸ¯ ä¸‹ä¸€æ­¥

ç³»ç»Ÿç°åœ¨åº”è¯¥å®Œå…¨æ­£å¸¸å·¥ä½œäº†ï¼ä½ å¯ä»¥ï¼š

1. âœ… å®æ—¶æ¥æ”¶å’Œæ˜¾ç¤ºæ–°æ¶ˆæ¯
2. âœ… æ­£å¸¸æ¥æ”¶å’Œæ˜¾ç¤ºç¾¤ç»„æ¶ˆæ¯
3. âœ… ä½¿ç”¨ API è·å–æ•°æ®
4. âœ… æŸ¥çœ‹æ‰€æœ‰ç±»å‹çš„æ¶ˆæ¯ï¼ˆæ–‡å­—ã€å›¾ç‰‡ã€è§†é¢‘ç­‰ï¼‰

å¦‚æœè¿˜æœ‰é—®é¢˜ï¼Œè¯·æ£€æŸ¥ï¼š
- åç«¯æ—¥å¿—ä¸­çš„é”™è¯¯ä¿¡æ¯
- æµè§ˆå™¨æ§åˆ¶å°ä¸­çš„é”™è¯¯ä¿¡æ¯
- æ•°æ®åº“ä¸­çš„æ•°æ®æ˜¯å¦æ­£ç¡®ä¿å­˜

---

**æœ€åæ›´æ–°ï¼š** 2026-02-06
**ç‰ˆæœ¬ï¼š** v0.12 (Bug Fixed)
