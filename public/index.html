<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WhatsApp CRM</title>
    <link rel="stylesheet" href="shared-styles.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .chat-container { 
            display: grid; 
            grid-template-columns: 320px 1fr; 
            height: calc(100vh - 65px); 
            overflow: hidden;
        }
        .sidebar { 
            background: var(--bg-main); 
            border-right: 1px solid var(--border-color); 
            display: flex; 
            flex-direction: column; 
            overflow: hidden;
            height: 100%;
        }
        .sidebar-header {
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
            flex-shrink: 0;
        }
        .chat-list-container {
            flex: 1;
            overflow-y: scroll;
            overflow-x: hidden;
            height: 0;
            scrollbar-width: thin;
            scrollbar-color: var(--primary) var(--bg-main);
        }
        .chat-list-container::-webkit-scrollbar { width: 8px; }
        .chat-list-container::-webkit-scrollbar-track { background: var(--bg-main); border-radius: 4px; }
        .chat-list-container::-webkit-scrollbar-thumb { background: var(--primary); border-radius: 4px; }
        .chat-area { 
            display: flex; 
            flex-direction: column; 
            background: var(--bg-dark); 
            overflow: hidden;
            height: 100%;
        }
        .chat-header {
            padding: 1rem;
            background: var(--bg-main);
            border-bottom: 1px solid var(--border-color);
            flex-shrink: 0;
        }
        .messages-area { 
            flex: 1;
            overflow-y: scroll;
            overflow-x: hidden;
            padding: 1rem;
            height: 0;
            scrollbar-width: thin;
            scrollbar-color: var(--primary) var(--bg-dark);
        }
        .messages-area::-webkit-scrollbar { width: 8px; }
        .messages-area::-webkit-scrollbar-track { background: var(--bg-dark); border-radius: 4px; }
        .messages-area::-webkit-scrollbar-thumb { background: var(--primary); border-radius: 4px; }
        .message-in { 
            background: var(--bg-card); 
            border-radius: var(--radius-lg); 
            padding: 0.75rem 1rem; 
            margin: 0.25rem 0; 
            max-width: 70%; 
            align-self: flex-start; 
        }
        .message-out { 
            background: var(--gradient-primary); 
            color: #000; 
            border-radius: var(--radius-lg); 
            padding: 0.75rem 1rem; 
            margin: 0.25rem 0; 
            max-width: 70%; 
            align-self: flex-end; 
        }
        .contact-item { 
            padding: 0.75rem 1rem; 
            border-bottom: 1px solid var(--border-color); 
            cursor: pointer; 
            transition: all 0.2s; 
        }
        .contact-item:hover { background: var(--bg-card); }
        .contact-item.active { background: rgba(0, 210, 106, 0.1); border-left: 3px solid var(--primary); }
        .input-area { 
            padding: 1rem; 
            background: var(--bg-main); 
            border-top: 1px solid var(--border-color);
            flex-shrink: 0;
        }
        .avatar { 
            width: 40px; 
            height: 40px; 
            border-radius: 50%; 
            background: var(--bg-card); 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-weight: bold; 
            color: var(--text-secondary); 
            overflow: hidden; 
            flex-shrink: 0; 
        }
        .avatar img { width: 100%; height: 100%; object-fit: cover; }
        
        /* Session Modal - å±…ä¸­æ¨¡æ…‹æ¡† */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .modal-overlay.active {
            display: flex;
        }
        .modal-box {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-xl);
            padding: 1.5rem;
            width: 90%;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }
        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin: 0 0 1rem 0;
            color: var(--text-primary);
        }
        .modal-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 1.5rem;
            line-height: 1;
        }
        .modal-close:hover {
            color: var(--text-primary);
        }
        .session-btn {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            width: 100%;
            padding: 0.75rem 1rem;
            background: var(--bg-dark);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
            margin-bottom: 0.5rem;
        }
        .session-btn:hover {
            background: var(--bg-card-hover);
            border-color: var(--primary);
        }
        .session-btn.active {
            background: rgba(0, 210, 106, 0.1);
            border-color: var(--primary);
        }
        .session-status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            flex-shrink: 0;
        }
        .session-status-dot.connected {
            background: var(--success);
            box-shadow: 0 0 8px var(--success);
        }
        .session-status-dot.disconnected {
            background: var(--error);
        }
    </style>
</head>
<body>
    <header class="app-header">
        <h1>
            <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 24 24"><path d="M20 2H4C2.9 2 2 2.9 2 4V22L6 18H20C21.1 18 22 17.1 22 16V4C22 2.9 21.1 2 20 2Z"/></svg>
            WhatsApp CRM
        </h1>
        <div style="display: flex; align-items: center; gap: 1rem;">
            <button onclick="openSessionModal()" style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; background: rgba(0, 210, 106, 0.1); border: 1px solid rgba(0, 210, 106, 0.3); border-radius: 9999px; cursor: pointer; color: var(--text-primary); transition: all 0.2s;">
                <div id="sessionStatus" style="width: 8px; height: 8px; border-radius: 50%; background: var(--success);"></div>
                <span id="sessionName">è¼‰å…¥ä¸­...</span>
                <span style="font-size: 0.75rem; color: var(--text-muted);">â–¼</span>
            </button>
            <nav class="nav-links">
                <a href="index.html" style="color: var(--primary);">ğŸ’¬ èŠå¤©</a>
                <a href="contacts-list.html">ğŸ‘¥ è¯çµ¡äºº</a>
                <a href="media.html">ğŸ–¼ï¸ åª’é«”</a>
                <a href="admin.html">âš™ï¸ ç®¡ç†</a>
            </nav>
        </div>
    </header>

    <div class="chat-container">
        <div class="sidebar">
            <div class="sidebar-header">
                <input type="text" id="search" class="input" placeholder="ğŸ” æœå°‹èŠå¤©..." oninput="filterChats()">
            </div>
            <div id="chat-list" class="chat-list-container">
                <div class="loading"><div class="spinner"></div></div>
            </div>
        </div>

        <div class="chat-area">
            <div id="chat-header" class="chat-header" style="display: none;">
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <div class="avatar" id="chat-avatar">ğŸ‘¤</div>
                    <div>
                        <div id="chat-name" style="font-weight: 600;"></div>
                        <div id="chat-status" style="font-size: 0.75rem; color: var(--text-muted);"></div>
                    </div>
                </div>
            </div>
            <div id="messages" class="messages-area" style="display: flex; flex-direction: column;">
                <div style="flex: 1; display: flex; align-items: center; justify-content: center; color: var(--text-muted);">
                    é¸æ“‡ä¸€å€‹èŠå¤©é–‹å§‹
                </div>
            </div>
            <div class="input-area" id="input-area" style="display: none;">
                <div style="display: flex; gap: 0.5rem;">
                    <input type="text" id="message-input" class="input" placeholder="è¼¸å…¥è¨Šæ¯..." onkeypress="if(event.key==='Enter')sendMessage()">
                    <button class="btn btn-primary" onclick="sendMessage()">ç™¼é€</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Session Modal -->
    <div id="sessionModal" class="modal-overlay" onclick="if(event.target===this)closeSessionModal()">
        <div class="modal-box">
            <h3 class="modal-title">åˆ‡æ› WhatsApp Session</h3>
            <div id="sessionList"></div>
            <button class="btn btn-secondary" style="width: 100%; margin-top: 1rem;" onclick="closeSessionModal()">é—œé–‰</button>
        </div>
    </div>

    <script>
// æª¢æŸ¥ç™»å…¥ç‹€æ…‹
const token = localStorage.getItem("crm_token");
if (!token) { window.location.href = "/login.html"; }

        let currentSessionId = localStorage.getItem('wa_crm_session_id') || 'sess_1771472517677';
        let currentChatId = null;
        let allContacts = [];
        let allSessions = [];
        const avatarCache = new Map();

        async function getAvatar(jid) {
            if (avatarCache.has(jid)) return avatarCache.get(jid);
            try {
                const res = await fetch(`/api/session/${currentSessionId}/avatar/${encodeURIComponent(jid)}`);
                if (res.ok) {
                    const data = await res.json();
                    if (data.url) {
                        avatarCache.set(jid, data.url);
                        return data.url;
                    }
                }
            } catch (e) {}
            avatarCache.set(jid, null);
            return null;
        }

        async function init() {
            await loadSessions();
            await loadContacts();
        }

        async function loadSessions() {
            try {
                const res = await fetch('/api/sessions');
                allSessions = await res.json();
                const s = allSessions.find(x => x.id === currentSessionId) || allSessions[0];
                document.getElementById('sessionName').textContent = s?.name || s?.id?.split('_')[1] || 'Unknown';
                document.getElementById('sessionStatus').style.background = s?.status === 'connected' ? 'var(--success)' : 'var(--error)';
            } catch (e) {}
        }

        async function loadContacts() {
            try {
                const res = await fetch(`/api/session/${currentSessionId}/contacts?limit=500`);
                allContacts = await res.json();
                renderChatList();
            } catch (e) {}
        }

        async function renderChatList() {
            const list = document.getElementById('chat-list');
            const search = document.getElementById('search').value.toLowerCase();
            const filtered = allContacts.filter(c => {
                const name = c.name || c.notify || c.jid;
                return name.toLowerCase().includes(search);
            }).slice(0, 100);

            list.innerHTML = filtered.map(c => {
                const name = c.name || c.notify || c.jid.split('@')[0];
                const icon = c.is_group ? 'ğŸ‘¥' : name[0]?.toUpperCase() || '?';
                const active = c.jid === currentChatId ? 'active' : '';
                const avatarId = 'avatar-' + c.jid.replace(/[^a-zA-Z0-9]/g, '_');
                return `
                    <div class="contact-item ${active}" onclick="selectChat('${c.jid}', '${name.replace(/'/g, "\\'")}')">
                        <div style="display: flex; align-items: center; gap: 0.75rem;">
                            <div class="avatar" id="${avatarId}"></div>
                            <div style="flex: 1; min-width: 0;">
                                <div style="font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${name}</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            filtered.forEach(async c => {
                const avatarId = 'avatar-' + c.jid.replace(/[^a-zA-Z0-9]/g, '_');
                const avatarEl = document.getElementById(avatarId);
                const url = await getAvatar(c.jid);
                if (avatarEl && url) {
                    avatarEl.innerHTML = `<img src="${url}" onerror="this.parentElement.innerHTML='${c.is_group ? 'ğŸ‘¥' : (c.name || c.notify || '?')[0]?.toUpperCase() || '?'}'">`;
                }
            });
        }

        function filterChats() { renderChatList(); }

        async function selectChat(jid, name) {
            currentChatId = jid;
            document.getElementById('chat-name').textContent = name;
            document.getElementById('chat-header').style.display = 'block';
            document.getElementById('input-area').style.display = 'block';
            document.getElementById('messages').innerHTML = '<div class="loading"><div class="spinner"></div></div>';
            renderChatList();

            const avatarEl = document.getElementById('chat-avatar');
            const contact = allContacts.find(c => c.jid === jid);
            avatarEl.textContent = contact?.is_group ? 'ğŸ‘¥' : name[0]?.toUpperCase() || '?';
            const url = await getAvatar(jid);
            if (url) {
                avatarEl.innerHTML = `<img src="${url}" onerror="this.parentElement.innerHTML='${contact?.is_group ? 'ğŸ‘¥' : name[0]?.toUpperCase() || '?'}'">`;
            }

            try {
                const res = await fetch(`/api/session/${currentSessionId}/messages/${encodeURIComponent(jid)}?limit=50`);
                const messages = await res.json();
                renderMessages(messages);
            } catch (e) {
                document.getElementById('messages').innerHTML = '<div style="color: var(--error); text-align: center; padding: 2rem;">è¼‰å…¥å¤±æ•—</div>';
            }
        }

        function renderMessages(messages) {
            const container = document.getElementById("messages");
            container.innerHTML = messages.map(m => {
                const cls = m.from_me ? "message-out" : "message-in";
                const time = m.message_timestamp ? new Date(m.message_timestamp).toLocaleDateString("zh-TW", {year: "numeric", month: "short", day: "numeric"}) + " " + new Date(m.message_timestamp).toLocaleTimeString("zh-TW", {hour: "2-digit", minute: "2-digit"}) : "";
                const msgType = m.message_type || "";
                let content = m.content || "";
                let mediaHtml = "";

                if (msgType === "imageMessage") {
                    const imgPath = m.attachment_path ? "/media/" + m.attachment_path : null;
                    if (imgPath) {
                        mediaHtml = `<div style="margin-top: 0.5rem;"><img src="${imgPath}" style="max-width: 200px; border-radius: 8px;">`;
                    } else {
                        mediaHtml = `<div style="margin-top: 0.5rem;padding:0.75rem;background:#333;border-radius:8px;color:#888;text-align:center;">ğŸ–¼ï¸ [åœ–ç‰‡] - éœ€è¦ä¸‹è¼‰</div>`;
                    }
                    if (!content) content = "[åœ–ç‰‡]";
                } else if (msgType === "videoMessage") {
                    const videoPath = m.attachment_path ? "/media/" + m.attachment_path : null;
                    mediaHtml = `<div style="margin-top: 0.5rem;"><video src="${videoPath}" style="max-width: 250px; border-radius: 8px;" controls preload="metadata"></video></div>`;
                    if (!content) content = "[å½±ç‰‡]";
                } else if (msgType === "audioMessage" || msgType === "pttMessage") {
                    const audioPath = m.attachment_path ? "/media/" + m.attachment_path : "/media/" + m.message_id + ".ogg";
                    mediaHtml = `<div style="margin-top: 0.5rem;"><audio src="${audioPath}" style="width: 200px;" controls preload="metadata"></audio></div>`;
                    content = "ğŸ¤ èªéŸ³è¨Šæ¯";
                } else if (msgType === "stickerMessage") {
                    const stickerPath = m.attachment_path ? "/media/" + m.attachment_path : null;
                    mediaHtml = `<div style="margin-top: 0.5rem;"><img src="${stickerPath}" style="max-width: 150px;"></div>`;
                    content = "";
                } else if (msgType === "documentMessage") {
                    const docPath = m.attachment_path ? "/media/" + m.attachment_path : null;
                    mediaHtml = `<div style="margin-top: 0.5rem;"><a href="${docPath}" target="_blank">ğŸ“ ä¸‹è¼‰æ–‡ä»¶</a></div>`;
                    if (!content) content = "[æ–‡ä»¶]";
                }

                return `<div class="${cls}"><div>${content}${mediaHtml}</div><div style="font-size: 0.65rem; opacity: 0.7; margin-top: 0.25rem;">${time}</div></div>`;
            }).join("");
            // æ»¾å‹•åˆ°æœ€æ–°è¨Šæ¯ï¼ˆè¨Šæ¯æŒ‰æ™‚é–“æ’åºï¼Œæœ€æ–°çš„åœ¨æœ€å¾Œï¼‰
            requestAnimationFrame(() => {
                container.scrollTop = container.scrollHeight;
            });
        }

        async function sendMessage() {
            const input = document.getElementById("message-input");
            const text = input.value.trim();
            if (!text || !currentChatId) return;

            // é¡¯ç¤ºç™¼é€ä¸­çš„è¨Šæ¯
            const container = document.getElementById("messages");
            const tempDiv = document.createElement("div");
            tempDiv.className = "message-out";
            tempDiv.innerHTML = `<div>${text}</div><div style="font-size: 0.65rem; opacity: 0.7; margin-top: 0.25rem;">ç™¼é€ä¸­...</div>`;
            container.appendChild(tempDiv);
            container.scrollTop = container.scrollHeight;

            input.value = "";

            try {
                const res = await fetch("/api/crm/messages/send", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": "Bearer casey-crm"
                    },
                    body: JSON.stringify({
                        sessionId: currentSessionId,
                        recipient: currentChatId,
                        text: text
                    })
                });

                const data = await res.json();
                if (data.success) {
                    // æ›´æ–°ç‹€æ…‹çˆ²å·²ç™¼é€
                    tempDiv.querySelector("div:last-child").textContent = "å·²ç™¼é€ âœ“";
                } else {
                    tempDiv.querySelector("div:last-child").textContent = "ç™¼é€å¤±æ•—";
                    tempDiv.style.opacity = "0.5";
                }
            } catch (e) {
                console.error("ç™¼é€å¤±æ•—:", e);
                tempDiv.querySelector("div:last-child").textContent = "ç™¼é€å¤±æ•—";
                tempDiv.style.opacity = "0.5";
            }
        }

        function openSessionModal() {
            const list = document.getElementById('sessionList');
            list.innerHTML = allSessions.map(s => {
                const isActive = s.id === currentSessionId;
                const statusClass = s.status === 'connected' ? 'connected' : 'disconnected';
                const name = s.name || s.id.split('_')[1] || 'Unknown';
                return `
                    <button class="session-btn ${isActive ? 'active' : ''}" onclick="selectSession('${s.id}')">
                        <div class="session-status-dot ${statusClass}"></div>
                        <div style="flex: 1;">
                            <div style="font-weight: 500;">${name}</div>
                            <div style="font-size: 0.75rem; color: var(--text-muted);">${s.status === 'connected' ? 'å·²é€£æ¥' : 'æœªé€£æ¥'}</div>
                        </div>
                        ${isActive ? '<span style="color: var(--primary);">âœ“</span>' : ''}
                    </button>
                `;
            }).join('') || '<p style="color: var(--text-muted); text-align: center;">æ²’æœ‰å¯ç”¨çš„ Session</p>';
            document.getElementById('sessionModal').classList.add('active');
        }

        function closeSessionModal() { 
            document.getElementById('sessionModal').classList.remove('active'); 
        }
        
        function selectSession(id) { 
            localStorage.setItem('wa_crm_session_id', id); 
            closeSessionModal(); 
            location.reload(); 
        }

        // WebSocket é€£æ¥
        let ws;
        function connectWebSocket() {
            const wsUrl = "wss://" + window.location.host + "/ws";
            ws = new WebSocket(wsUrl);
            ws.onopen = () => console.log("WS å·²é€£æ¥");
            ws.onmessage = (e) => {
                const data = JSON.parse(e.data);
                if (data.type === "new_message" && data.chatId === currentChatId) {
                    // æ–°è¨Šæ¯ - é‡æ–°è¼‰å…¥
                    selectChat(currentChatId, document.getElementById("chat-name").textContent);
                    showNotification("ğŸ’¬ æ–°è¨Šæ¯", data.message?.content?.substring(0,50) || "åª’é«”");
                } else if (data.type === "typing" && data.chatId === currentChatId) {
                    showTyping(data.isTyping);
                } else if (data.type === "media_downloaded") {
                    showNotification("ğŸ“¥ åª’é«”ä¸‹è¼‰å®Œæˆ", data.filename);
                } else if (data.type === "read_receipt") {
                    showNotification("ğŸ“– å·²è®€", "å°æ–¹å·²è®€å–è¨Šæ¯");
                }
            };
            ws.onclose = () => setTimeout(connectWebSocket, 3000);
        }
        function showNotification(title, body) {
            if (Notification.permission === "granted") {
                new Notification(title, { body, icon: "/media/icon.png" });
            }
            console.log(title, body);
        }
        function showTyping(isTyping) {
            const el = document.getElementById("chat-status");
            if (el) el.textContent = isTyping ? "æ­£åœ¨è¼¸å…¥..." : "";
        }
        connectWebSocket();

        init();
    </script>
</body>
</html>
