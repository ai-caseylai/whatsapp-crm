<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WhatsApp CRM</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .chat-message { max-width: 80%; }
        .message-in { align-self: flex-start; background-color: #ffffff; }
        .message-out { align-self: flex-end; background-color: #dcf8c6; }
        .scrollbar-w-2::-webkit-scrollbar { width: 0.5rem; height: 0.5rem; }
        .scrollbar-thumb-rounded::-webkit-scrollbar-thumb { border-radius: 0.25rem; background-color: #cbd5e0; }
        .scrollbar-track-gray-lighter::-webkit-scrollbar-track { background-color: #f7fafc; }
    </style>
</head>
<body class="bg-gray-100 h-screen flex flex-col">
    <!-- Navbar -->
    <div class="bg-[#00a884] text-white p-4 shadow-md flex justify-between items-center z-10">
        <div class="flex items-center gap-4">
            <h1 class="text-xl font-bold flex items-center gap-2">
                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12C2 17.52 6.48 22 12 22C17.52 22 22 17.52 22 12C22 6.48 17.52 2 12 2ZM12 20C7.59 20 4 16.41 4 12C4 7.59 7.59 4 12 4C16.41 4 20 7.59 20 12C20 16.41 16.41 20 12 20ZM12 6C8.69 6 6 8.69 6 12C6 15.31 8.69 18 12 18C15.31 18 18 15.31 18 12C18 8.69 15.31 6 12 6ZM12 16C9.79 16 8 14.21 8 12C8 9.79 9.79 8 12 8C14.21 8 16 9.79 16 12C16 14.21 14.21 16 12 16Z"/></svg>
                WhatsApp CRM
                <span class="text-xs font-normal bg-[#008f6f] px-2 py-0.5 rounded-full">v0.44</span>
            </h1>
            <!-- Navigation Links: Always Visible -->
            <nav class="flex space-x-2 ml-4 text-sm font-medium">
                <a href="#" onclick="switchTab('chat')" id="nav-chat" class="px-3 py-2 rounded bg-[#008f6f] text-white flex items-center gap-1">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path></svg>
                    èŠå¤©å®¤
                </a>
                <a href="#" onclick="switchTab('calendar')" id="nav-calendar" class="px-3 py-2 rounded hover:bg-[#008f6f]/50 transition flex items-center gap-1">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                    ç™¼é€æ—¥æ›†
                </a>
            </nav>
        </div>
        <div class="flex items-center space-x-4">
            <div id="user-identity" class="flex items-center space-x-2 hidden">
                <span class="text-sm opacity-90">å·²ç™»å…¥:</span>
                <span id="user-name" class="font-bold bg-[#008f6f] px-3 py-1 rounded-full text-sm shadow-sm"></span>
            </div>
            <span id="status-badge" class="px-2 py-1 rounded bg-gray-500 text-sm">æª¢æŸ¥ä¸­...</span>
            <button onclick="downloadAllMedia()" class="bg-blue-500 hover:bg-blue-600 px-3 py-1 rounded text-sm transition shadow-sm text-white flex items-center gap-1" title="ä¸‹è¼‰æ‰€æœ‰ç¼ºå¤±çš„åœ–ç‰‡å’Œå½±ç‰‡">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                </svg>
                ä¸‹è¼‰åª’é«”
            </button>
            <button onclick="refreshUnknownContacts()" class="bg-purple-500 hover:bg-purple-600 px-3 py-1 rounded text-sm transition shadow-sm text-white flex items-center gap-1" title="å¾ WhatsApp ç²å–æœªçŸ¥è¯çµ¡äººçš„åç¨±">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                </svg>
                å¾ WA ç²å–
            </button>
            <button onclick="extractNamesFromGroups()" class="bg-green-500 hover:bg-green-600 px-3 py-1 rounded text-sm transition shadow-sm text-white flex items-center gap-1" title="å¾æ‰€æœ‰æ¶ˆæ¯ä¸­æå–è¯çµ¡äººåç¨±ï¼ˆç¾¤çµ„ + ç§äººï¼‰">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                </svg>
                æå–åç¨±
            </button>
            <button onclick="resync()" class="bg-yellow-500 hover:bg-yellow-600 px-3 py-1 rounded text-sm transition shadow-sm text-white" title="æ¸…é™¤è³‡æ–™ä¸¦é‡æ–°æƒæä»¥åŒæ­¥å®Œæ•´æ­·å²">å¼·åˆ¶åŒæ­¥</button>
            <button onclick="openMarketing()" class="bg-[#008f6f] hover:bg-[#007f5f] px-3 py-1 rounded text-sm transition shadow-sm font-bold flex items-center gap-1">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5.882V19.24a1.76 1.76 0 01-3.417.592l-2.147-6.15M18 13a3 3 0 100-6M5.436 13.683A4.001 4.001 0 017 6h1.832c4.1 0 7.625-1.234 9.168-3v14c-1.543-1.766-5.067-3-9.168-3H7a3.988 3.988 0 01-1.564-.317z"></path></svg>
                ç¾¤ç™¼è¡ŒéŠ·
            </button>
            <button onclick="logout()" class="bg-red-500 hover:bg-red-600 px-3 py-1 rounded text-sm transition shadow-sm">ç™»å‡º</button>
        </div>
    </div>

    <!-- Marketing Modal -->
    <div id="marketing-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center">
        <div class="bg-white w-[900px] h-[600px] rounded-xl shadow-2xl flex flex-col overflow-hidden">
            <div class="bg-[#00a884] text-white p-4 flex justify-between items-center">
                <h2 class="text-xl font-bold flex items-center gap-2">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5.882V19.24a1.76 1.76 0 01-3.417.592l-2.147-6.15M18 13a3 3 0 100-6M5.436 13.683A4.001 4.001 0 017 6h1.832c4.1 0 7.625-1.234 9.168-3v14c-1.543-1.766-5.067-3-9.168-3H7a3.988 3.988 0 01-1.564-.317z"></path></svg>
                    WhatsApp è¡ŒéŠ·ç¾¤ç™¼åŠ©æ‰‹
                </h2>
                <button onclick="closeMarketing()" class="hover:bg-[#008f6f] p-1 rounded"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
            </div>
            
            <div class="flex-1 flex overflow-hidden">
                <!-- Left: Contact Selector -->
                <div class="w-1/3 border-r border-gray-200 flex flex-col bg-gray-50">
                    <div class="p-3 border-b border-gray-200">
                        <input type="text" id="mkt-search" onkeyup="filterMarketingContacts()" placeholder="æœå°‹è¯çµ¡äºº (æˆ–è¼¸å…¥é›»è©±è™Ÿç¢¼)..." class="w-full px-3 py-2 border rounded-lg text-sm mb-2">
                        <div class="flex justify-between items-center text-xs text-gray-600">
                            <label class="flex items-center gap-1 cursor-pointer"><input type="checkbox" onchange="toggleAllMarketing(this)"> å…¨é¸é¡¯ç¤º</label>
                            <span id="selected-count">å·²é¸: 0</span>
                        </div>
                        <!-- Add manual number input for self/others -->
                        <div class="mt-2 flex gap-2">
                            <input type="text" id="manual-number" placeholder="æ‰‹å‹•è¼¸å…¥è™Ÿç¢¼ (ä¾‹å¦‚ 85297188675)" class="flex-1 px-2 py-1 border rounded text-xs">
                            <button onclick="addManualContact()" class="bg-gray-200 hover:bg-gray-300 px-2 py-1 rounded text-xs">æ–°å¢</button>
                        </div>
                    </div>
                    <div id="mkt-contacts-list" class="flex-1 overflow-y-auto p-2 space-y-1">
                        <!-- Contacts rendered here -->
                    </div>
                </div>

                <!-- Right: Compose -->
                <div class="w-2/3 p-6 flex flex-col bg-white">
                    <div class="mb-4">
                        <label class="block text-sm font-bold text-gray-700 mb-2">è¨Šæ¯å…§å®¹</label>
                        <textarea id="mkt-text" rows="6" class="w-full border rounded-lg p-3 focus:ring-2 focus:ring-[#00a884] focus:outline-none" placeholder="è¼¸å…¥æ‚¨çš„æ¨å»£è¨Šæ¯..."></textarea>
                    </div>
                    
                    <div class="mb-6">
                        <label class="block text-sm font-bold text-gray-700 mb-2">é™„ä»¶ (åœ–ç‰‡/å½±ç‰‡/æ–‡ä»¶)</label>
                        <input type="file" id="mkt-file" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-[#e6fffa] file:text-[#00a884] hover:file:bg-[#b2f5ea]"/>
                        <p class="text-xs text-gray-500 mt-1">æ”¯æ´ jpg, png, mp4, pdf, doc ç­‰æ ¼å¼</p>
                    </div>

                    <div class="mt-auto border-t pt-4">
                        <div class="flex justify-between items-center mb-4">
                            <div class="text-sm">
                                <span class="font-bold text-gray-700">ä»Šæ—¥é¡åº¦:</span>
                                <span id="daily-limit-text" class="text-green-600 font-bold ml-1">è¼‰å…¥ä¸­...</span>
                            </div>
                            <div class="text-xs text-gray-400">
                                ç³»çµ±é™åˆ¶: 50 å‰‡/å¤©
                            </div>
                        </div>
                        
                        <button onclick="sendBroadcast()" id="btn-broadcast" class="w-full bg-[#00a884] hover:bg-[#008f6f] text-white font-bold py-3 rounded-lg shadow-lg transition flex justify-center items-center gap-2">
                            <span>ğŸš€ ç™¼é€å»£æ’­</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="view-chat" class="flex-1 flex overflow-hidden">
        <!-- Sidebar: Contacts -->
        <div class="w-1/3 md:w-1/4 bg-white border-r border-gray-200 flex flex-col z-0">
            <div class="p-4 border-b border-gray-200 bg-gray-50 space-y-2">
                <input type="text" id="search-input" placeholder="æœå°‹è¯çµ¡äºº..." onkeyup="filterContacts()" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 text-sm">
                <div class="grid grid-cols-2 gap-2">
                    <button onclick="refreshGroupNames()" class="px-2 py-2 bg-blue-500 hover:bg-blue-600 text-white text-xs rounded-lg transition shadow-sm flex items-center justify-center gap-1" title="åˆ·æ–°æ‰€æœ‰ç¾¤çµ„åç¨±">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                        <span id="refresh-groups-text">ç¾¤çµ„</span>
                    </button>
                    <button onclick="refreshLIDContacts()" class="px-2 py-2 bg-green-500 hover:bg-green-600 text-white text-xs rounded-lg transition shadow-sm flex items-center justify-center gap-1" title="åˆ·æ–° LID è¯çµ¡äºº">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                        <span id="refresh-lid-text">è¯çµ¡äºº</span>
                    </button>
                </div>
            </div>
            <div id="contacts-list" class="flex-1 overflow-y-auto scrollbar-w-2 scrollbar-thumb-rounded">
                <div class="p-4 text-center text-gray-500">è¼‰å…¥ä¸­...</div>
            </div>
        </div>

        <!-- Main: Chat -->
        <div class="w-2/3 md:w-3/4 flex flex-col bg-[#e5ddd5] relative">
            <!-- Chat Header -->
            <div id="chat-header" class="p-3 bg-gray-200 border-b border-gray-300 hidden flex items-center shadow-sm">
                <div class="w-10 h-10 rounded-full bg-gray-400 flex items-center justify-center text-white font-bold mr-3" id="header-avatar">?</div>
                <div>
                    <h2 id="current-contact-name" class="font-bold text-gray-800"></h2>
                    <p id="current-contact-id" class="text-xs text-gray-600 font-mono"></p>
                </div>
            </div>

            <!-- QR Container -->
            <div id="qr-container" class="absolute inset-0 bg-[#e5ddd5] z-20 flex flex-col items-center justify-center hidden">
                <div class="bg-white p-8 rounded-xl shadow-2xl text-center max-w-md w-full mx-4">
                    <h3 class="text-2xl font-bold mb-2 text-gray-800">é€£çµ WhatsApp</h3>
                    <p class="text-gray-600 mb-6 text-sm">è«‹ä½¿ç”¨æ‰‹æ©Ÿ WhatsApp æƒæä¸‹æ–¹ QR Code</p>
                    
                    <div class="bg-gray-100 p-2 rounded-lg inline-block mb-4 relative min-h-[250px] flex items-center justify-center w-full">
                        <img id="qr-code" src="" alt="QR Code" class="w-64 h-64 object-contain hidden" />
                        <div id="qr-loading" class="absolute inset-0 flex flex-col items-center justify-center">
                            <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-indigo-600 mb-4"></div>
                            <p id="qr-loading-text" class="text-gray-500 text-sm">è¼‰å…¥ä¸­...</p>
                        </div>
                    </div>

                    <div class="text-left text-sm text-gray-600 space-y-2">
                        <p>1. é–‹å•Ÿæ‰‹æ©Ÿä¸Šçš„ WhatsApp</p>
                        <p>2. é»æ“Š <strong>è¨­å®š</strong> > <strong>é€£çµè£ç½®</strong></p>
                        <p>3. é»æ“Š <strong>é€£çµè£ç½®</strong> ä¸¦æƒææ­¤ç¢¼</p>
                    </div>
                </div>
            </div>

            <!-- Messages Area -->
            <div id="messages-container" class="flex-1 overflow-y-auto p-4 flex flex-col space-y-2 scrollbar-w-2 scrollbar-thumb-rounded hidden"></div>
            
            <!-- Welcome Screen -->
            <div id="welcome-screen" class="flex-1 flex items-center justify-center text-gray-500 flex-col">
                <svg class="w-24 h-24 mb-4 text-gray-300" fill="currentColor" viewBox="0 0 24 24"><path d="M20 2H4C2.9 2 2 2.9 2 4V22L6 18H20C21.1 18 22 17.1 22 16V4C22 2.9 21.1 2 20 2ZM20 16H6L4 18V4H20V16Z"/></svg>
                <p class="text-lg">è«‹é¸æ“‡ä¸€å€‹è¯çµ¡äººæŸ¥çœ‹å°è©±</p>
            </div>
        </div>
    </div>

    <!-- Calendar View (Hidden by default) -->
    <div id="view-calendar" class="flex-1 flex flex-col hidden bg-white p-6 overflow-y-auto">
        <h2 class="text-2xl font-bold mb-6 text-gray-800">ç™¼é€æ—¥æ›†</h2>
        <div class="grid grid-cols-1 md:grid-cols-7 gap-4">
            <!-- Calendar Grid will be rendered here -->
            <div class="md:col-span-5 bg-white rounded-xl shadow border border-gray-200 p-4">
                <div class="flex justify-between items-center mb-4">
                    <button onclick="changeMonth(-1)" class="p-2 hover:bg-gray-100 rounded">&lt;</button>
                    <h3 id="cal-month-year" class="text-lg font-bold"></h3>
                    <button onclick="changeMonth(1)" class="p-2 hover:bg-gray-100 rounded">&gt;</button>
                </div>
                <div class="grid grid-cols-7 gap-1 text-center text-sm text-gray-500 mb-2">
                    <div>æ—¥</div><div>ä¸€</div><div>äºŒ</div><div>ä¸‰</div><div>å››</div><div>äº”</div><div>å…­</div>
                </div>
                <div id="calendar-grid" class="grid grid-cols-7 gap-1 text-sm"></div>
            </div>
            
            <!-- Daily Details -->
            <div class="md:col-span-2 bg-gray-50 rounded-xl p-4 border border-gray-200">
                <h3 class="font-bold text-gray-800 mb-2" id="selected-date-title">é¸æ“‡æ—¥æœŸ</h3>
                <div id="selected-date-stats" class="space-y-3">
                    <p class="text-gray-500 text-sm">è«‹é»æ“Šå·¦å´æ—¥æ›†æŸ¥çœ‹è©³ç´°æ•¸æ“š</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- Tab Switching ---
        function switchTab(tab) {
            const views = ['chat', 'calendar'];
            views.forEach(v => {
                document.getElementById(`view-${v}`).classList.add('hidden');
                document.getElementById(`nav-${v}`).classList.remove('bg-[#008f6f]', 'text-white');
                document.getElementById(`nav-${v}`).classList.add('hover:bg-[#008f6f]/50');
            });
            
            document.getElementById(`view-${tab}`).classList.remove('hidden');
            const activeNav = document.getElementById(`nav-${tab}`);
            activeNav.classList.add('bg-[#008f6f]', 'text-white');
            activeNav.classList.remove('hover:bg-[#008f6f]/50');
            
            if (tab === 'calendar') {
                renderCalendar();
            }
        }

        // --- Calendar Logic ---
        let currentMonth = new Date();
        let calendarStats = {};

        async function fetchCalendarStats(year, month) {
            try {
                // Fetch stats for the whole month
                const start = new Date(year, month, 1).toISOString();
                const end = new Date(year, month + 1, 0, 23, 59, 59).toISOString();
                
                // We need a backend API for this range, currently we can reuse daily-stats endpoint slightly modified
                // Or just fetch all 'from_me' messages in range and aggregate locally for now
                // Ideally backend should provide aggregation. Let's create a new endpoint later.
                // For now, let's mock or simple fetch:
                
                const res = await fetch(`/api/session/${currentSessionId}/calendar-stats?start=${start}&end=${end}`);
                if (res.ok) {
                    calendarStats = await res.json();
                }
            } catch(e) { console.error(e); }
        }

        async function renderCalendar() {
            const year = currentMonth.getFullYear();
            const month = currentMonth.getMonth();
            
            document.getElementById('cal-month-year').textContent = `${year}å¹´ ${month + 1}æœˆ`;
            
            // Fetch data
            await fetchCalendarStats(year, month);

            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startingDay = firstDay.getDay(); // 0 is Sunday
            
            const grid = document.getElementById('calendar-grid');
            grid.innerHTML = '';

            // Empty cells for previous month
            for (let i = 0; i < startingDay; i++) {
                grid.innerHTML += '<div class="h-24 bg-gray-50 border border-gray-100"></div>';
            }

            // Days
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const stat = calendarStats[dateStr] || { sent: 0 };
                const isToday = new Date().toDateString() === new Date(year, month, day).toDateString();
                
                let colorClass = 'bg-white';
                if (stat.sent > 0) colorClass = 'bg-green-50';
                if (stat.sent >= 50) colorClass = 'bg-red-50';
                if (isToday) colorClass = 'ring-2 ring-purple-500';

                grid.innerHTML += `
                    <div onclick="selectDate('${dateStr}')" class="h-24 ${colorClass} border border-gray-200 p-2 cursor-pointer hover:bg-gray-100 transition relative">
                        <div class="font-bold text-gray-700">${day}</div>
                        ${stat.sent > 0 ? `<div class="mt-2 text-xs text-green-600 font-semibold">å·²ç™¼: ${stat.sent}</div>` : ''}
                        ${stat.sent >= 50 ? '<div class="absolute bottom-1 right-1 text-red-500 text-[10px]">å·²æ»¿</div>' : ''}
                    </div>
                `;
            }
        }

        function changeMonth(delta) {
            currentMonth.setMonth(currentMonth.getMonth() + delta);
            renderCalendar();
        }

        function selectDate(dateStr) {
            document.getElementById('selected-date-title').textContent = dateStr;
            const stat = calendarStats[dateStr] || { sent: 0 };
            
            document.getElementById('selected-date-stats').innerHTML = `
                <div class="flex justify-between items-center p-3 bg-white rounded shadow-sm">
                    <span class="text-gray-600">å·²ç™¼é€è¨Šæ¯</span>
                    <span class="text-xl font-bold text-green-600">${stat.sent}</span>
                </div>
                <div class="flex justify-between items-center p-3 bg-white rounded shadow-sm">
                    <span class="text-gray-600">å‰©é¤˜é¡åº¦</span>
                    <span class="text-xl font-bold ${50 - stat.sent < 0 ? 'text-red-500' : 'text-blue-500'}">${Math.max(0, 50 - stat.sent)}</span>
                </div>
                <div class="mt-4">
                    <h4 class="font-bold text-gray-700 text-sm mb-2">ç™¼é€ç´€éŒ„ (Top 5)</h4>
                    <div id="date-logs" class="text-xs text-gray-500 space-y-1">
                        è¼‰å…¥ä¸­...
                    </div>
                </div>
            `;
            
            // Load logs for that date
            fetch(`/api/session/${currentSessionId}/logs?date=${dateStr}`).then(res => res.json()).then(logs => {
                const logsContainer = document.getElementById('date-logs');
                if (logs.length === 0) {
                    logsContainer.innerHTML = 'ç„¡ç™¼é€ç´€éŒ„';
                    return;
                }
                logsContainer.innerHTML = logs.map(l => `
                    <div class="flex justify-between border-b border-gray-100 pb-1">
                        <span class="truncate w-2/3">${l.push_name || l.remote_jid.split('@')[0]}</span>
                        <span>${new Date(l.created_at).toLocaleTimeString('zh-HK')}</span>
                    </div>
                `).join('');
            });
        }

        // Generate or retrieve UUID for this browser session
        function getSessionId() {
            let id = localStorage.getItem('wa_crm_session_id');
            if (!id) {
                // Generate simple UUID
                id = 'sess_' + Math.random().toString(36).substr(2, 9) + '_' + Date.now();
                localStorage.setItem('wa_crm_session_id', id);
            }
            return id;
        }

        const currentSessionId = getSessionId();
        let currentChatId = null;
        let allContacts = [];
        let statusPollInterval = null;
        let currentUserName = null; // å­˜å‚¨ç”¨æˆ·è‡ªå·±çš„åå­—
        let isLoadingChat = false; // é˜²æ­¢é‡å¤åŠ è½½èŠå¤©
        let isLoadingContacts = false; // é˜²æ­¢é‡å¤åŠ è½½è”ç³»äºº

        console.log('Using Session ID:', currentSessionId);

        // --- Core Functions ---

        async function startSession() {
             try {
                 await fetch(`/api/session/${currentSessionId}/start`, { method: 'POST' });
                 checkStatus();
             } catch(e) { console.error(e); }
        }

        async function checkStatus() {
            try {
                const res = await fetch(`/api/session/${currentSessionId}/status`);
                const data = await res.json();
                const badge = document.getElementById('status-badge');
                const qrContainer = document.getElementById('qr-container');
                const userIdentity = document.getElementById('user-identity');
                const userName = document.getElementById('user-name');

                // Update User Info if available
                if (data.user) {
                    // Prefer pushName (user set name), fallback to name, then notify, then ID
                    const name = data.user.pushName || data.user.name || data.user.notify || data.user.id.split(':')[0];
                    userName.textContent = name;
                    currentUserName = name; // ä¿å­˜ç”¨æˆ·åå­—åˆ°å…¨å±€å˜é‡
                    userIdentity.classList.remove('hidden');
                } else {
                    userIdentity.classList.add('hidden');
                }

                if (data.status === 'connected') {
                    badge.textContent = 'å·²é€£ç·š';
                    badge.className = 'px-2 py-1 rounded bg-[#25D366] text-white text-sm transition font-semibold shadow-sm';
                    qrContainer.classList.add('hidden');
                    loadContacts(); // Load contacts when connected
                    
                    // Trigger ensure self
                    fetch(`/api/session/${currentSessionId}/ensure-self`, { method: 'POST' }).catch(console.error);

                    // Show user info
                    if (data.userInfo) {
                        const name = data.userInfo.name || data.userInfo.id.split(':')[0];
                        document.getElementById('user-name').textContent = name;
                        document.getElementById('user-identity').classList.remove('hidden');
                        
                        // Also try to manually add self to contact list in frontend if not present
                        const selfJid = data.selfJid || (data.userInfo.id.split(':')[0] + '@s.whatsapp.net');
                        // We do this inside loadContacts logic usually, but let's store it
                        window.currentUserJid = selfJid;
                    }
                } else if (data.status === 'qr' && data.qr) {
                    badge.textContent = 'æƒæä¸­';
                    badge.className = 'px-2 py-1 rounded bg-yellow-500 text-white text-sm transition';
                    qrContainer.classList.remove('hidden');
                    document.getElementById('qr-code').src = data.qr;
                    document.getElementById('qr-code').classList.remove('hidden');
                    document.getElementById('qr-loading').classList.add('hidden');
                } else if (data.status === 'initializing') {
                    badge.textContent = 'å•Ÿå‹•ä¸­...';
                    badge.className = 'px-2 py-1 rounded bg-[#00a884] text-white text-sm transition';
                    qrContainer.classList.remove('hidden');
                    document.getElementById('qr-code').classList.add('hidden');
                    document.getElementById('qr-loading').classList.remove('hidden');
                    document.getElementById('qr-loading-text').textContent = 'æ­£åœ¨ç”¢ç”Ÿ QR Code...';
                } else {
                    badge.textContent = data.status === 'stopped' ? 'æœªå•Ÿå‹•' : (data.status || 'æœªé€£ç·š');
                    badge.className = 'px-2 py-1 rounded bg-red-500 text-white text-sm transition';
                    
                    qrContainer.classList.remove('hidden');
                    document.getElementById('qr-code').classList.add('hidden');
                    document.getElementById('qr-loading').classList.remove('hidden');
                    
                    if (data.status === 'stopped' || data.status === 'logged_out') {
                        // Auto start if stopped
                        document.getElementById('qr-loading-text').textContent = 'æ­£åœ¨å•Ÿå‹•é€£ç·š...';
                        startSession();
                    } else {
                        document.getElementById('qr-loading-text').textContent = 'é€£ç·šä¸­...';
                    }
                }
            } catch (e) { console.error(e); }

            // Poll for new messages if chat is open
            if (currentChatId && !document.getElementById('messages-container').classList.contains('hidden')) {
                 refreshMessages(currentChatId);
            }
        }

        async function logout() {
            if(confirm('ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿé€™å°‡æœƒæ¸…é™¤æ­¤ç€è¦½å™¨çš„é€£ç·šç´€éŒ„ã€‚')) {
                await fetch(`/api/session/${currentSessionId}/logout`, { method: 'POST' });
                localStorage.removeItem('wa_crm_session_id'); 
                location.reload();
            }
        }

        async function downloadAllMedia() {
            if (!currentSessionId) {
                alert('è«‹å…ˆç™»å…¥');
                return;
            }
            
            if (confirm('å³å°‡é–‹å§‹ä¸‹è¼‰æ‰€æœ‰ç¼ºå¤±çš„åœ–ç‰‡å’Œå½±ç‰‡ï¼ˆæœ€å¤š 500 å€‹ï¼‰ã€‚\n\né€™å¯èƒ½éœ€è¦å¹¾åˆ†é˜æ™‚é–“ï¼Œä¸‹è¼‰å®Œæˆå¾Œè«‹åˆ·æ–°é é¢ã€‚\n\nç¢ºå®šè¦é–‹å§‹å—ï¼Ÿ')) {
                try {
                    const statusBadge = document.getElementById('status-badge');
                    const originalText = statusBadge.textContent;
                    statusBadge.textContent = 'ä¸‹è¼‰ä¸­...';
                    statusBadge.className = 'px-2 py-1 rounded bg-blue-500 text-sm animate-pulse';
                    
                    const res = await fetch(`/api/session/${currentSessionId}/download-all-media`, {
                        method: 'POST'
                    });
                    
                    const result = await res.json();
                    
                    if (result.success) {
                        alert(`âœ… ${result.message}\n\nä¸‹è¼‰æ­£åœ¨å¾Œå°é€²è¡Œï¼Œè«‹ç­‰å¾… 1-3 åˆ†é˜å¾Œåˆ·æ–°é é¢æŸ¥çœ‹ã€‚`);
                        statusBadge.textContent = 'ä¸‹è¼‰é€²è¡Œä¸­...';
                    } else {
                        alert('âŒ ä¸‹è¼‰å¤±æ•—: ' + (result.error || 'æœªçŸ¥éŒ¯èª¤'));
                        statusBadge.textContent = originalText;
                        statusBadge.className = 'px-2 py-1 rounded bg-gray-500 text-sm';
                    }
                } catch (e) {
                    console.error('Download all media error:', e);
                    alert('âŒ ä¸‹è¼‰å¤±æ•—: ' + e.message);
                }
            }
        }
        
        async function refreshUnknownContacts() {
            if (!currentSessionId) {
                alert('è«‹å…ˆç™»å…¥');
                return;
            }
            
            if (confirm('å³å°‡å¾ WhatsApp ç²å–æœªçŸ¥è¯çµ¡äººçš„åç¨±ï¼ˆæœ€å¤š 20 å€‹ï¼‰ã€‚\n\né€™å¯èƒ½éœ€è¦ 10-20 ç§’ã€‚\n\nç¢ºå®šè¦é–‹å§‹å—ï¼Ÿ')) {
                try {
                    const statusBadge = document.getElementById('status-badge');
                    const originalText = statusBadge.textContent;
                    statusBadge.textContent = 'åˆ·æ–°ä¸­...';
                    statusBadge.className = 'px-2 py-1 rounded bg-purple-500 text-sm animate-pulse';
                    
                    const res = await fetch(`/api/session/${currentSessionId}/refresh-unknown-contacts`, {
                        method: 'POST'
                    });
                    
                    const result = await res.json();
                    
                    if (result.success) {
                        alert(`âœ… ${result.message}\n\næ‰¾åˆ° ${result.total} å€‹æœªçŸ¥è¯çµ¡äººï¼Œè™•ç†äº† ${result.processed} å€‹ï¼ŒæˆåŠŸæ›´æ–° ${result.updated} å€‹ã€‚\n\nè«‹åˆ·æ–°é é¢æŸ¥çœ‹æ›´æ–°ã€‚`);
                        statusBadge.textContent = originalText;
                        statusBadge.className = 'px-2 py-1 rounded bg-gray-500 text-sm';
                        
                        // è‡ªå‹•åˆ·æ–°è¯çµ¡äººåˆ—è¡¨
                        if (result.updated > 0) {
                            setTimeout(() => {
                                location.reload();
                            }, 1000);
                        }
                    } else {
                        alert('âŒ åˆ·æ–°å¤±æ•—: ' + (result.error || 'æœªçŸ¥éŒ¯èª¤'));
                        statusBadge.textContent = originalText;
                        statusBadge.className = 'px-2 py-1 rounded bg-gray-500 text-sm';
                    }
                } catch (e) {
                    console.error('Refresh unknown contacts error:', e);
                    alert('âŒ åˆ·æ–°å¤±æ•—: ' + e.message);
                }
            }
        }
        
        // ğŸ†• ä»æ‰€æœ‰æ¶ˆæ¯æå–åç§°
        async function extractNamesFromGroups() {
            if (!currentSessionId) {
                alert('è«‹å…ˆç™»å…¥');
                return;
            }
            
            if (confirm('å³å°‡å¾æ‰€æœ‰æ¶ˆæ¯ï¼ˆç¾¤çµ„ + ç§äººï¼‰ä¸­æå–è¯çµ¡äººåç¨±ï¼ˆæœ€å¤š 10000 æ¢æ¶ˆæ¯ï¼‰ã€‚\n\né€™å¯èƒ½éœ€è¦ 10-30 ç§’ã€‚\n\nç¢ºå®šè¦é–‹å§‹å—ï¼Ÿ')) {
                try {
                    const statusBadge = document.getElementById('status-badge');
                    const originalText = statusBadge.textContent;
                    statusBadge.textContent = 'æå–ä¸­...';
                    statusBadge.className = 'px-2 py-1 rounded bg-green-500 text-sm animate-pulse';
                    
                    const res = await fetch(`/api/session/${currentSessionId}/extract-names-from-groups`, {
                        method: 'POST'
                    });
                    
                    const result = await res.json();
                    
                    if (result.success) {
                        alert(`âœ… ${result.message}\n\nè«‹åˆ·æ–°é é¢æŸ¥çœ‹æ›´æ–°ã€‚`);
                        statusBadge.textContent = originalText;
                        statusBadge.className = 'px-2 py-1 rounded bg-gray-500 text-sm';
                        
                        // è‡ªå‹•åˆ·æ–°è¯çµ¡äººåˆ—è¡¨
                        if (result.updated > 0) {
                            setTimeout(() => {
                                location.reload();
                            }, 1000);
                        }
                    } else {
                        alert('âŒ æå–å¤±æ•—: ' + (result.error || 'æœªçŸ¥éŒ¯èª¤'));
                        statusBadge.textContent = originalText;
                        statusBadge.className = 'px-2 py-1 rounded bg-gray-500 text-sm';
                    }
                } catch (e) {
                    console.error('Extract names error:', e);
                    alert('âŒ æå–å¤±æ•—: ' + e.message);
                }
            }
        }
        
        // ğŸ†• ç¼–è¾‘è”ç³»äººå¤‡æ³¨
        function editContactNote(jid, currentDisplayName, currentCustomName) {
            const newName = prompt(`è«‹è¼¸å…¥è¯çµ¡äººå‚™æ³¨åç¨±:\n\nç•¶å‰é¡¯ç¤º: ${currentDisplayName}\nç•¶å‰å‚™æ³¨: ${currentCustomName || 'ï¼ˆç„¡ï¼‰'}`, currentCustomName || '');
            
            if (newName === null) return; // ç”¨æˆ·å–æ¶ˆ
            
            // ä¿å­˜å¤‡æ³¨
            updateContactNote(jid, newName);
        }
        
        async function updateContactNote(jid, customName) {
            if (!currentSessionId) {
                alert('è«‹å…ˆç™»å…¥');
                return;
            }
            
            try {
                const res = await fetch(`/api/session/${currentSessionId}/update-contact-note`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ jid, customName })
                });
                
                const result = await res.json();
                
                if (result.success) {
                    // åˆ·æ–°è”ç³»äººåˆ—è¡¨
                    await refreshContacts();
                } else {
                    alert('âŒ æ›´æ–°å‚™æ³¨å¤±æ•—: ' + (result.error || 'æœªçŸ¥éŒ¯èª¤'));
                }
            } catch (e) {
                console.error('Update contact note error:', e);
                alert('âŒ æ›´æ–°å‚™æ³¨å¤±æ•—: ' + e.message);
            }
        }
        
        async function resync() {
            if(confirm('å¼·åˆ¶åŒæ­¥å°‡æœƒç™»å‡ºä¸¦éœ€è¦æ‚¨é‡æ–°æƒæ QR Codeã€‚\n\né€™é€šå¸¸èƒ½è§£æ±ºã€Œç¼ºè¨Šæ¯ã€æˆ–ã€Œç¼ºç¾¤çµ„ã€çš„å•é¡Œã€‚\n\nç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿ')) {
                // Same as logout but with different intent message
                await fetch(`/api/session/${currentSessionId}/logout`, { method: 'POST' });
                localStorage.removeItem('wa_crm_session_id'); 
                location.reload();
            }
        }
        
        async function refreshGroupNames() {
            const btn = document.getElementById('refresh-groups-text');
            const originalText = btn.textContent;
            
            try {
                btn.textContent = '...';
                btn.parentElement.disabled = true;
                
                const res = await fetch(`/api/session/${currentSessionId}/refresh-groups`, { 
                    method: 'POST' 
                });
                
                const data = await res.json();
                
                if (data.success) {
                    btn.textContent = `âœ“ ${data.groupsUpdated}`;
                    
                    // Reload contacts to show updated names
                    await loadContacts();
                    
                    // Reset button text after 3 seconds
                    setTimeout(() => {
                        btn.textContent = originalText;
                        btn.parentElement.disabled = false;
                    }, 3000);
                } else {
                    alert('åˆ·æ–°å¤±æ•—: ' + (data.error || 'æœªçŸ¥éŒ¯èª¤'));
                    btn.textContent = originalText;
                    btn.parentElement.disabled = false;
                }
            } catch (error) {
                console.error('åˆ·æ–°ç¾¤çµ„åç¨±å¤±æ•—:', error);
                alert('åˆ·æ–°å¤±æ•—: ' + error.message);
                btn.textContent = originalText;
                btn.parentElement.disabled = false;
            }
        }
        
        async function refreshLIDContacts() {
            const btn = document.getElementById('refresh-lid-text');
            const originalText = btn.textContent;
            
            try {
                btn.textContent = '...';
                btn.parentElement.disabled = true;
                
                const res = await fetch(`/api/session/${currentSessionId}/refresh-lid-contacts`, { 
                    method: 'POST' 
                });
                
                const data = await res.json();
                
                if (data.success) {
                    btn.textContent = `âœ“ ${data.lidContactsFound}`;
                    
                    // Reload contacts to show updated names
                    await loadContacts();
                    
                    // Reset button text after 3 seconds
                    setTimeout(() => {
                        btn.textContent = originalText;
                        btn.parentElement.disabled = false;
                    }, 3000);
                } else {
                    alert('åˆ·æ–°å¤±æ•—: ' + (data.error || 'æœªçŸ¥éŒ¯èª¤'));
                    btn.textContent = originalText;
                    btn.parentElement.disabled = false;
                }
            } catch (error) {
                console.error('åˆ·æ–° LID è¯çµ¡äººå¤±æ•—:', error);
                alert('åˆ·æ–°å¤±æ•—: ' + error.message);
                btn.textContent = originalText;
                btn.parentElement.disabled = false;
            }
        }

        async function loadContacts() {
            // é˜²æ­¢é‡è¤‡åŠ è¼‰
            if (isLoadingContacts) {
                console.log('â³ æ­£åœ¨åŠ è¼‰è¯çµ¡äººä¸­ï¼Œè·³éé‡è¤‡è«‹æ±‚');
                return;
            }
            
            try {
                isLoadingContacts = true;
                const res = await fetch(`/api/session/${currentSessionId}/contacts`);
                const data = await res.json();
                
                if (data.error) {
                    console.error('Error loading contacts:', data.error);
                    return;
                }
                
                // Process and Init
                initContacts(data);

            } catch (e) {
                console.error('Failed to load contacts:', e);
                document.getElementById('contacts-list').innerHTML = '<div class="p-4 text-center text-red-500 text-sm">è¼‰å…¥å¤±æ•—</div>';
            } finally {
                isLoadingContacts = false;
            }
        }

        function initContacts(data) {
            // 1. Filter invalid/broadcast
            let valid = (Array.isArray(data) ? data : []).filter(c => {
                const id = c.jid || c.id;
                return id && !id.includes('status@broadcast');
            });

            // 2. åç«¯å·²ç»åŒ…å«"æˆ‘"å¹¶æ’åºå¥½äº†ï¼Œå‰ç«¯ä¸éœ€è¦å†æ·»åŠ æˆ–æ’åº
            // å¦‚æœåç«¯æ²¡æœ‰è¿”å›"æˆ‘"ï¼Œä¹Ÿä¸æ‰‹åŠ¨æ·»åŠ ï¼ˆè®©åç«¯å¤„ç†ï¼‰
            
            // 3. ğŸ”§ ç§»é™¤å‰ç«¯æ’åº - åç«¯å·²ç»æ’åºå¥½äº†ï¼Œå‰ç«¯ä¸åº”è¯¥å†æ¬¡æ’åº
            // valid.sort(...) - å·²ç§»é™¤ï¼Œä½¿ç”¨åç«¯çš„æ’åºç»“æœ

            // 4. Save to global
            allContacts = valid;

            // 5. Initial Render
            filterContacts();
        }

        function filterContacts() {
            const query = document.getElementById('search-input').value.toLowerCase();
            
            // Handle empty contacts
            if (allContacts.length === 0) {
                 renderContactsList([]);
                 return;
            }

            const filtered = allContacts.filter(c => {
                const id = c.jid || c.id || '';
                const name = c.name || '';
                const notify = c.notify || '';
                return name.toLowerCase().includes(query) || 
                       notify.toLowerCase().includes(query) ||
                       id.includes(query);
            });
            renderContactsList(filtered);
        }

        // å¤´åƒç¼“å­˜ - é¿å…é‡å¤åŠ è½½
        const avatarCache = new Map();
        
        // è·å–å¤´åƒ URLï¼ˆä¼˜åŒ–ï¼šæŒ‰éœ€åŠ è½½ï¼Œä½¿ç”¨ Intersection Observerï¼‰
        async function getAvatarUrl(jid) {
            if (!currentSessionId) return null;
            
            // æ£€æŸ¥ç¼“å­˜
            if (avatarCache.has(jid)) {
                return avatarCache.get(jid);
            }
            
            try {
                const res = await fetch(`/api/session/${currentSessionId}/avatar/${encodeURIComponent(jid)}`);
                const data = await res.json();
                
                const url = data.success ? data.url : null;
                avatarCache.set(jid, url); // ç¼“å­˜ç»“æœï¼ˆåŒ…æ‹¬ nullï¼‰
                return url;
            } catch (e) {
                console.error('è·å–å¤´åƒå¤±è´¥:', e);
                avatarCache.set(jid, null);
                return null;
            }
        }
        
        // Intersection Observer - åªåŠ è½½å¯è§åŒºåŸŸçš„å¤´åƒ
        let avatarObserver = null;
        
        function initAvatarObserver() {
            if (avatarObserver) avatarObserver.disconnect();
            
            avatarObserver = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting && entry.target.dataset.jid && !entry.target.dataset.loaded) {
                        const jid = entry.target.dataset.jid;
                        entry.target.dataset.loaded = 'true';
                        
                        // åŠ è½½å¤´åƒ
                        getAvatarUrl(jid).then(url => {
                            if (url && entry.target) {
                                const name = entry.target.dataset.name || '?';
                                entry.target.innerHTML = `<img src="${url}" class="w-full h-full object-cover" alt="${name}" onerror="this.parentElement.innerHTML='${name[0]?.toUpperCase() || '?'}'">`;
                            }
                        });
                    }
                });
            }, {
                root: document.getElementById('contacts-list'),
                rootMargin: '100px', // æå‰ 100px åŠ è½½
                threshold: 0.01
            });
        }
        
        function renderContactsList(contacts) {
            const list = document.getElementById('contacts-list');
            
            if (contacts.length === 0) {
                 list.innerHTML = '<div class="p-4 text-center text-gray-400 text-sm">æš«ç„¡è¯çµ¡äºº<br>è«‹ç­‰å¾…åŒæ­¥</div>';
                 return;
            }

            list.innerHTML = contacts.map(c => {
                const id = c.jid || c.id; 
                if (!id) return '';
                
                const isGroup = id.endsWith('@g.us');
                const isLID = id.endsWith('@lid');
                
                // Improve display ID logic
                let displayId;
                if (isGroup) {
                    displayId = 'ç¾¤çµ„ Group';
                } else if (isLID) {
                    // For LID contacts, show phone number nicely formatted
                    const phoneNumber = id.split('@')[0];
                    displayId = phoneNumber.length > 10 ? 
                        `+${phoneNumber.substring(0, phoneNumber.length - 10)} ${phoneNumber.substring(phoneNumber.length - 10)}` :
                        phoneNumber;
                } else {
                    displayId = id.split('@')[0];
                }
                
                // ğŸ†• ä¼˜å…ˆæ˜¾ç¤ºè‡ªå®šä¹‰å¤‡æ³¨å
                let name;
                let hasCustomName = false;
                
                if (c.custom_name && c.custom_name.trim()) {
                    // ä¼˜å…ˆä½¿ç”¨è‡ªå®šä¹‰å¤‡æ³¨
                    name = c.custom_name;
                    hasCustomName = true;
                } else if (c.name && c.name.trim()) {
                    name = c.name;
                } else if (c.notify && c.notify.trim()) {
                    name = c.notify;
                } else if (isGroup) {
                    // Don't show JID for groups, show friendly placeholder
                    name = "æœªå‘½åç¾¤çµ„ (åŒæ­¥ä¸­...)";
                } else if (isLID) {
                    // For LID contacts without name, show formatted phone
                    name = displayId;
                } else {
                    name = displayId;
                } 
                
                // æ˜¾ç¤ºåŸå§‹åå­—ï¼ˆå¦‚æœæœ‰è‡ªå®šä¹‰å¤‡æ³¨çš„è¯ï¼‰
                const originalName = hasCustomName ? (c.name || displayId) : '';
                
                return `
                <div class="p-3 border-b border-gray-100 hover:bg-gray-100 cursor-pointer transition flex items-center group relative">
                    <div onclick="loadChat('${id}', '${name.replace(/'/g, "\\'")}')" class="flex items-center flex-1 overflow-hidden min-w-0">
                        <div id="avatar-${id.replace(/[^a-zA-Z0-9]/g, '_')}" 
                             data-jid="${id}" 
                             data-name="${name.replace(/"/g, '&quot;')}"
                             class="w-12 h-12 rounded-full ${isGroup ? 'bg-indigo-400' : 'bg-gray-300'} flex items-center justify-center mr-3 text-white font-bold shrink-0 overflow-hidden">
                            ${name[0].toUpperCase()}
                        </div>
                        <div class="overflow-hidden min-w-0">
                            <div class="font-semibold text-gray-800 truncate">
                                ${name}
                                ${hasCustomName ? '<span class="text-xs text-blue-600 ml-1">ğŸ“</span>' : ''}
                            </div>
                            ${originalName ? `<div class="text-xs text-gray-400 truncate">${originalName}</div>` : ''}
                            <div class="text-xs text-gray-500 truncate font-mono">${displayId}</div>
                        </div>
                    </div>
                    ${!isGroup ? `
                    <button onclick="event.stopPropagation(); editContactNote('${id}', '${name.replace(/'/g, "\\'")}', '${(c.custom_name || '').replace(/'/g, "\\'")}')" 
                            class="opacity-0 group-hover:opacity-100 transition p-2 hover:bg-gray-200 rounded-full text-gray-600" 
                            title="ç·¨è¼¯å‚™æ³¨">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path>
                        </svg>
                    </button>
                    ` : ''}
                </div>
            `;
            }).join('');
            
            // ğŸ†• ä½¿ç”¨ Intersection Observer æŒ‰éœ€åŠ è½½å¤´åƒï¼ˆåªåŠ è½½å¯è§åŒºåŸŸï¼‰
            initAvatarObserver();
            
            // è§‚å¯Ÿæ‰€æœ‰å¤´åƒå…ƒç´ 
            contacts.forEach(c => {
                const id = c.jid || c.id;
                if (!id) return;
                
                const avatarId = `avatar-${id.replace(/[^a-zA-Z0-9]/g, '_')}`;
                const avatarEl = document.getElementById(avatarId);
                if (avatarEl && avatarObserver) {
                    avatarObserver.observe(avatarEl);
                }
            });
        }

        async function loadChat(jid, name) {
            // é˜²æ­¢é‡è¤‡åŠ è¼‰ç›¸åŒèŠå¤©
            if (isLoadingChat && currentChatId === jid) {
                console.log(`â³ æ­£åœ¨åŠ è¼‰èŠå¤© ${jid}ï¼Œè·³éé‡è¤‡è«‹æ±‚`);
                return;
            }
            
            try {
                isLoadingChat = true;
                currentChatId = jid;
                
                document.getElementById('welcome-screen').classList.add('hidden');
                document.getElementById('qr-container').classList.add('hidden');
                document.getElementById('chat-header').classList.remove('hidden');
                const messagesContainer = document.getElementById('messages-container');
                messagesContainer.classList.remove('hidden');
                
                // ğŸ”§ å…ˆä½¿ç”¨ä¼ å…¥çš„åå­—ï¼Œç¨åä»æ¶ˆæ¯ä¸­æ›´æ–°
                let displayName = name;
                document.getElementById('current-contact-name').textContent = displayName;
                document.getElementById('current-contact-id').textContent = jid.endsWith('@g.us') ? 'ç¾¤çµ„ Group' : jid.replace('@s.whatsapp.net', '').replace('@lid', '');
                document.getElementById('header-avatar').textContent = displayName[0].toUpperCase();
                document.getElementById('header-avatar').className = `w-10 h-10 rounded-full flex items-center justify-center text-white font-bold mr-3 ${jid.endsWith('@g.us') ? 'bg-indigo-400' : 'bg-gray-400'}`;

                messagesContainer.innerHTML = '<div class="text-center text-gray-500 mt-4">è¼‰å…¥è¨Šæ¯ä¸­...</div>';

                // ğŸ”§ åŠ è½½æ¶ˆæ¯å¹¶ä»ä¸­æå–çœŸå®çš„è”ç³»äººåå­—
                const messages = await refreshMessages(jid);
                
                // ğŸ”§ ä»æ¶ˆæ¯ä¸­è·å–å¯¹æ–¹çš„çœŸå®åå­—ï¼ˆå¯¹äºç§èŠï¼‰
                if (!jid.endsWith('@g.us') && messages && messages.length > 0) {
                    // æ‰¾åˆ°ç¬¬ä¸€æ¡ä¸æ˜¯è‡ªå·±å‘çš„æ¶ˆæ¯ï¼Œè·å–å¯¹æ–¹çš„åå­—
                    const otherMessage = messages.find(m => !m.from_me);
                    if (otherMessage && otherMessage.push_name) {
                        displayName = otherMessage.push_name;
                        document.getElementById('current-contact-name').textContent = displayName;
                        document.getElementById('header-avatar').textContent = displayName[0].toUpperCase();
                        console.log(`âœ… ä»æ¶ˆæ¯ä¸­æ›´æ–°è”ç³»äººåå­—: ${displayName}`);
                    }
                }
                
                // ğŸ†• è‡ªå‹•ä¸‹è¼‰æ­¤èŠå¤©çš„æ‰€æœ‰ç¼ºå¤±åª’é«”ï¼ˆç•°æ­¥ï¼Œä¸é˜»å¡UIï¼‰
                downloadChatMedia(jid);
            } finally {
                isLoadingChat = false;
            }
        }
        
        // ä¸‹è¼‰èŠå¤©çš„æ‰€æœ‰ç¼ºå¤±åª’é«”
        let isDownloadingMedia = false; // é˜²æ­¢é‡è¤‡ä¸‹è¼‰
        
        async function downloadChatMedia(jid) {
            // é˜²æ­¢é‡è¤‡ä¸‹è¼‰
            if (isDownloadingMedia) {
                console.log(`â³ æ­£åœ¨ä¸‹è¼‰åª’é«”ä¸­ï¼Œè·³éé‡è¤‡è«‹æ±‚`);
                return;
            }
            
            try {
                isDownloadingMedia = true;
                console.log(`ğŸ“¥ é–‹å§‹ä¸‹è¼‰ ${jid} çš„åª’é«”æ–‡ä»¶...`);
                
                const res = await fetch(`/api/session/${currentSessionId}/download-chat-media/${encodeURIComponent(jid)}`, {
                    method: 'POST'
                });
                const data = await res.json();
                
                if (data.success) {
                    if (data.downloaded > 0) {
                        console.log(`âœ… æˆåŠŸä¸‹è¼‰ ${data.downloaded} å€‹åª’é«”æ–‡ä»¶ï¼Œæ­£åœ¨åˆ·æ–°...`);
                        // é‡æ–°åŠ è¼‰æ¶ˆæ¯ä»¥é¡¯ç¤ºæ–°ä¸‹è¼‰çš„åª’é«”
                        if (currentChatId === jid) {
                            await refreshMessages(jid);
                        }
                    } else if (data.total > 0) {
                        console.log(`âš ï¸ ${data.total} å€‹åª’é«”æ–‡ä»¶ä¸‹è¼‰å¤±æ•—ï¼ˆå¯èƒ½æ˜¯æ­·å²æ¶ˆæ¯éˆæ¥å·²éæœŸï¼‰`);
                    } else {
                        console.log(`â„¹ï¸ æ­¤èŠå¤©æ²’æœ‰ç¼ºå¤±çš„åª’é«”æ–‡ä»¶`);
                    }
                }
            } catch (e) {
                console.error('âŒ ä¸‹è¼‰åª’é«”å¤±æ•—:', e);
            } finally {
                isDownloadingMedia = false;
            }
        }
        
        // ğŸ†• æ˜¾ç¤º"æ— æ¶ˆæ¯"æç¤ºï¼Œå¹¶è‡ªåŠ¨è·³è½¬åˆ°æœ€è¿‘æ´»è·ƒçš„ç¾¤ç»„
        async function showNoMessagesWithGroups(jid) {
            const messagesContainer = document.getElementById('messages-container');
            
            try {
                // è°ƒç”¨ API æŸ¥æ‰¾è¯¥è”ç³»äººå‚ä¸çš„ç¾¤ç»„
                const res = await fetch(`/api/session/${currentSessionId}/contact-groups/${jid}`);
                const data = await res.json();
                
                if (data.mostRecentGroup) {
                    // ğŸ”§ æœ‰ç¾¤ç»„ï¼šè‡ªåŠ¨è·³è½¬åˆ°æœ€è¿‘æ´»è·ƒçš„ç¾¤ç»„
                    const group = data.mostRecentGroup;
                    console.log(`ğŸ”„ è”ç³»äººæ— ç§èŠè®°å½•ï¼Œè‡ªåŠ¨è·³è½¬åˆ°æœ€è¿‘æ´»è·ƒçš„ç¾¤ç»„: ${group.name}`);
                    
                    // æ˜¾ç¤ºè·³è½¬æç¤ºï¼ˆçŸ­æš‚ï¼‰
                    messagesContainer.innerHTML = `
                        <div class="text-center text-gray-600 mt-8 px-4">
                            <div class="text-6xl mb-4">ğŸ’¬</div>
                            <div class="text-lg font-semibold mb-2">æ­¤è¯çµ¡äººæ²’æœ‰ç§èŠè¨˜éŒ„</div>
                            <div class="text-sm text-gray-500 mb-4">æ­£åœ¨è·³è½‰åˆ°æœ€è¿‘æ´»èºçš„ç¾¤çµ„...</div>
                            <div class="max-w-md mx-auto">
                                <div class="bg-indigo-50 p-3 rounded-lg border border-indigo-200">
                                    <div class="flex items-center justify-center">
                                        <div class="w-10 h-10 rounded-full bg-indigo-400 flex items-center justify-center text-white font-bold mr-3">
                                            ${(group.name || 'G')[0].toUpperCase()}
                                        </div>
                                        <div class="font-semibold text-gray-800">${group.name || group.jid}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    // 1 ç§’åè‡ªåŠ¨è·³è½¬
                    setTimeout(() => {
                        loadChat(group.jid, group.name || group.jid);
                    }, 1000);
                } else {
                    // æ²¡æœ‰ç¾¤ç»„ï¼šæ˜¾ç¤ºé»˜è®¤æç¤º
                    messagesContainer.innerHTML = `
                        <div class="text-center text-gray-400 mt-8">
                            <div class="text-6xl mb-4">ğŸ“­</div>
                            <div class="text-lg">æš«ç„¡è¨Šæ¯</div>
                            <div class="text-sm mt-2">èˆ‡æ­¤è¯çµ¡äººé–‹å§‹å°è©±å§ï¼</div>
                        </div>
                    `;
                }
            } catch (e) {
                console.error('Error loading contact groups:', e);
                messagesContainer.innerHTML = `
                    <div class="text-center text-gray-400 mt-8">
                        <div class="text-6xl mb-4">ğŸ“­</div>
                        <div class="text-lg">æš«ç„¡è¨Šæ¯</div>
                        <div class="text-sm mt-2">èˆ‡æ­¤è¯çµ¡äººé–‹å§‹å°è©±å§ï¼</div>
                    </div>
                `;
            }
        }
        
        async function refreshMessages(jid) {
            if (currentChatId !== jid) return null;
            const messagesContainer = document.getElementById('messages-container');
            
            try {
                const res = await fetch(`/api/session/${currentSessionId}/messages/${jid}`);
                
                // ğŸ”§ æ£€æŸ¥å“åº”çŠ¶æ€
                if (!res.ok) {
                    console.error(`âŒ API è¿”å›é”™è¯¯: ${res.status}`);
                    messagesContainer.innerHTML = `<div class="text-center text-red-500 mt-4">è¼‰å…¥å¤±æ•— (${res.status})</div>`;
                    return null;
                }
                
                const messages = await res.json();
                
                // ğŸ”§ éªŒè¯è¿”å›çš„æ˜¯æ•°ç»„
                if (!Array.isArray(messages)) {
                    console.error('âŒ API è¿”å›æ ¼å¼é”™è¯¯ï¼Œä¸æ˜¯æ•°ç»„:', messages);
                    messagesContainer.innerHTML = '<div class="text-center text-red-500 mt-4">æ•¸æ“šæ ¼å¼éŒ¯èª¤</div>';
                    return null;
                }
                
                if (messages.length === 0) {
                    // ğŸ”§ æ£€æŸ¥è¯¥è”ç³»äººæ˜¯å¦åœ¨ç¾¤ç»„ä¸­æ´»è·ƒ
                    await showNoMessagesWithGroups(jid);
                    return messages; // è¿”å›ç©ºæ•°ç»„
                }

                const html = messages
                    .filter(msg => {
                        // æª¢æŸ¥æ¶ˆæ¯çµæ§‹
                        const fullMsg = msg.full_message_json;
                        const msgContent = fullMsg?.message || fullMsg;
                        
                        // éæ¿¾æ‰å”è­°æ¶ˆæ¯å’Œå¯†é‘°åˆ†ç™¼æ¶ˆæ¯
                        if (msgContent?.protocolMessage || msgContent?.senderKeyDistributionMessage) return false;
                        if (msg.message_type === 'associatedChildMessage') return false;
                        
                        // ä¿ç•™æ‰€æœ‰å…¶ä»–æ¶ˆæ¯
                        return true;
                    })
                    .map(msg => renderMessageBubble(msg))
                    .join('');
                
                console.log(`Loaded ${messages.length} messages, filtered to ${html ? 'some' : 'none'}`);
                
                // å¦‚æœæ²’æœ‰æ¶ˆæ¯ï¼Œé¡¯ç¤ºæç¤º
                if (!html || html.trim() === '') {
                    await showNoMessagesWithGroups(jid);
                    return messages; // è¿”å›åŸå§‹æ¶ˆæ¯æ•°ç»„
                }
                
                messagesContainer.innerHTML = html;
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
                
                return messages; // ğŸ”§ è¿”å›æ¶ˆæ¯æ•°ç»„ä¾› loadChat ä½¿ç”¨

            } catch (e) {
                console.error('Error loading messages:', e);
                return null;
            }
        }
        
        function renderMessageBubble(msg) {
            const isFromMe = msg.from_me;
            const timestamp = msg.message_timestamp;
            const date = new Date(timestamp).toLocaleString('zh-HK'); 
            
            let content = msg.content || '';
            let type = msg.message_type;
            let attachmentPath = msg.attachment_path;
            let mediaPath = msg.media_path; // ç›´æ¥ä½¿ç”¨ media_path

            // ğŸ”§ æ”¹è¿›ï¼šä¼˜å…ˆä½¿ç”¨ msg.contentï¼Œåªæœ‰å½“å®ƒæ˜¯ç©ºæˆ–æ˜¯ç±»å‹åç§°æ—¶æ‰ä» full_message_json æå–
            const isContentEmpty = !content || content.trim() === '';
            const isContentTypeName = ['conversation', 'extendedTextMessage', 'imageMessage', 'videoMessage', 'audioMessage', 'stickerMessage', 'documentMessage', 'pttMessage'].includes(content);
            
            if (isContentEmpty || isContentTypeName) {
                const realMsg = msg.full_message_json?.message;
                if (realMsg) {
                    // Unwrap message layers
                    let unwrapped = realMsg;
                    if (realMsg.viewOnceMessage?.message) unwrapped = realMsg.viewOnceMessage.message;
                    if (realMsg.viewOnceMessageV2?.message) unwrapped = realMsg.viewOnceMessageV2.message;
                    if (realMsg.ephemeralMessage?.message) unwrapped = realMsg.ephemeralMessage.message;
                    if (realMsg.documentWithCaptionMessage?.message) unwrapped = realMsg.documentWithCaptionMessage.message;
                    
                    // Extract text content
                    if (unwrapped.conversation) {
                        content = unwrapped.conversation;
                    } else if (unwrapped.extendedTextMessage?.text) {
                        content = unwrapped.extendedTextMessage.text;
                    } else if (unwrapped.imageMessage?.caption) {
                        content = unwrapped.imageMessage.caption;
                    } else if (unwrapped.videoMessage?.caption) {
                        content = unwrapped.videoMessage.caption;
                    } else if (unwrapped.documentMessage?.fileName) {
                        content = unwrapped.documentMessage.fileName;
                    }
                }
            }
            
            // ğŸ†• è°ƒè¯•æ—¥å¿—
            if (!content || content.trim() === '') {
                console.log('âš ï¸ æ¶ˆæ¯å†…å®¹ä¸ºç©º:', {
                    message_id: msg.message_id,
                    original_content: msg.content,
                    type: type,
                    has_attachment: !!attachmentPath,
                    has_media: !!mediaPath
                });
            }

            // æª¢æ¸¬ Emoji å’Œ Reaction æ¶ˆæ¯
            const isEmojiOnly = content && /^[\u{1F600}-\u{1F64F}\u{1F300}-\u{1F5FF}\u{1F680}-\u{1F6FF}\u{2600}-\u{26FF}\u{2700}-\u{27BF}\u{1F900}-\u{1F9FF}\u{1F1E0}-\u{1F1FF}]+$/u.test(content.trim());
            const isReaction = content && content.includes('(å›æ‡‰è¨Šæ¯)');

            // Display Logic
            let displayContent = content;
            
            // ğŸ”§ æ”¹è¿›ï¼šåªæœ‰å½“ content æ˜¯ç±»å‹åç§°æˆ–ç©ºæ—¶æ‰è¿›è¡Œç‰¹æ®Šå¤„ç†
            const mediaTypeNames = ['conversation', 'extendedTextMessage', 'stickerMessage', 'audioMessage', 'pttMessage', 'imageMessage', 'videoMessage', 'documentMessage', 'pollCreationMessageV3'];
            
            if (!displayContent || mediaTypeNames.includes(displayContent) || displayContent.trim() === '') {
                const m = msg.full_message_json?.message || {};
                
                // æ£€æŸ¥ç‰¹æ®Šæ¶ˆæ¯ç±»å‹
                if (m.contactMessage) {
                    displayContent = '[è¯çµ¡äººå¡ç‰‡]';
                } else if (m.locationMessage) {
                    displayContent = '[ä½ç½®è³‡è¨Š]';
                } else if (m.pollCreationMessageV3 || displayContent === 'pollCreationMessageV3') {
                    displayContent = '[æŠ•ç¥¨]';
                } else if (displayContent === 'stickerMessage' || displayContent === '[è²¼åœ–]') {
                    displayContent = '';  // è²¼åœ–ä¸éœ€è¦æ–‡å­—
                } else if (['audioMessage', 'pttMessage', '[èªéŸ³è¨Šæ¯]', '[èªéŸ³]'].includes(displayContent)) {
                    displayContent = '';  // èªéŸ³ä¸éœ€è¦æ–‡å­—ï¼ˆæœ‰æ’­æ”¾å™¨ï¼‰
                } else if (displayContent === 'imageMessage' || displayContent === '[åœ–ç‰‡]') {
                    displayContent = '';  // åœ–ç‰‡ä¸éœ€è¦æ–‡å­—ï¼ˆæœƒé¡¯ç¤ºåœ–ç‰‡ï¼‰
                } else if (displayContent === 'videoMessage' || displayContent === '[å½±ç‰‡]') {
                    displayContent = '';  // è¦–é »ä¸éœ€è¦æ–‡å­—ï¼ˆæœƒé¡¯ç¤ºè¦–é »ï¼‰
                } else if (displayContent === 'conversation' || displayContent === 'extendedTextMessage') {
                    // è¿™äº›ç±»å‹åº”è¯¥å·²ç»æœ‰å†…å®¹äº†ï¼Œå¦‚æœè¿˜æ˜¯ç©ºçš„å°±ä¿æŒç©º
                    displayContent = '';
                }
            }

            let attachmentHtml = '';
            
            // å„ªå…ˆä½¿ç”¨ media_pathï¼Œå…¶æ¬¡ä½¿ç”¨ attachment_path
            const finalMediaPath = mediaPath || (attachmentPath ? `/media/${attachmentPath}` : null);
            
            // ğŸ”§ è°ƒè¯•ï¼šè´´å›¾æ¶ˆæ¯
            if (type && (type.includes('sticker') || type === 'stickerMessage')) {
                console.log('ğŸ¨ è²¼åœ–æ¶ˆæ¯:', {
                    message_id: msg.message_id,
                    type: type,
                    finalMediaPath: finalMediaPath,
                    attachmentPath: attachmentPath,
                    mediaPath: mediaPath
                });
            }
            
            if (finalMediaPath) {
                 if (['imageMessage', 'image'].includes(type)) {
                     attachmentHtml = `
                         <div class="mt-2">
                             <img src="${finalMediaPath}" 
                                  class="rounded-lg max-w-sm max-h-96 cursor-pointer shadow-md hover:shadow-xl transition-all hover:scale-105" 
                                  onclick="window.open('${finalMediaPath}', '_blank')"
                                  onerror="if(this.retryCount===undefined){this.retryCount=0;}if(this.retryCount<3){this.retryCount++;setTimeout(()=>{this.src='${finalMediaPath}?retry='+this.retryCount;},1000*this.retryCount);}else{this.parentElement.innerHTML='<div class=\\'text-gray-400 text-sm p-4 bg-gray-100 rounded\\'>ğŸ“· åœ–ç‰‡è¼‰å…¥å¤±æ•—</div>';}" />
                         </div>`;
                     if (!content || content === 'imageMessage') displayContent = '';
                 } else if (['videoMessage', 'video'].includes(type)) {
                     attachmentHtml = `
                         <div class="mt-2">
                             <video controls src="${finalMediaPath}" 
                                    class="rounded-lg max-w-sm max-h-96 shadow-md"
                                    onerror="if(this.retryCount===undefined){this.retryCount=0;}if(this.retryCount<3){this.retryCount++;setTimeout(()=>{this.src='${finalMediaPath}?retry='+this.retryCount;this.load();},1000*this.retryCount);}else{this.parentElement.innerHTML='<div class=\\'text-gray-400 text-sm p-4 bg-gray-100 rounded\\'>ğŸ¥ è¦–é »è¼‰å…¥å¤±æ•—</div>';}">
                             </video>
                         </div>`;
                     if (!content || content === 'videoMessage') displayContent = '';
                 } else if (['audioMessage', 'audio', 'pttMessage'].includes(type)) {
                     attachmentHtml = `
                         <div class="mt-2 flex items-center gap-2 bg-white/30 p-2 rounded-lg">
                             <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                 <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15.536a5 5 0 001.414 1.414m2.828-9.9a9 9 0 000 12.728M12 18a6 6 0 100-12 6 6 0 000 12z"/>
                             </svg>
                             <audio controls src="${finalMediaPath}" class="flex-1 h-8"></audio>
                         </div>`;
                     if (!content || content === 'audioMessage' || content === 'pttMessage') displayContent = '';
                } else if (['stickerMessage', 'sticker'].includes(type)) {
                    attachmentHtml = `
                        <div class="mt-2 relative group">
                            <img src="${finalMediaPath}" class="w-36 h-36 object-contain rounded-lg" 
                                 onerror="if(this.retryCount===undefined){this.retryCount=0;}if(this.retryCount<3){this.retryCount++;setTimeout(()=>{this.src='${finalMediaPath}?retry='+this.retryCount;},1000*this.retryCount);}else{this.parentElement.innerHTML='<div class=\\'w-36 h-36 flex items-center justify-center bg-gradient-to-br from-purple-100 to-pink-100 rounded-lg\\' title=\\'è²¼åœ–è¼‰å…¥å¤±æ•—\\'><div class=\\'text-center\\'><div class=\\'text-4xl mb-1\\'>ğŸ¨</div><div class=\\'text-xs text-gray-500\\'>è¼‰å…¥å¤±æ•—</div></div></div>';}" />
                        </div>`;
                    displayContent = '';
                } else if (type === 'stickerMessage' || content === '[è²¼åœ–]') {
                    // ğŸ”§ è™•ç†æ²’æœ‰ finalMediaPath çš„è²¼åœ–
                    attachmentHtml = `
                        <div class="mt-2 relative group">
                            <div class="w-36 h-36 flex items-center justify-center bg-gradient-to-br from-purple-100 to-pink-100 rounded-lg">
                                <div class="text-center">
                                    <div class="text-4xl mb-2">ğŸ¨</div>
                                    <div class="text-xs text-gray-500">[è²¼åœ–]</div>
                                </div>
                            </div>
                        </div>`;
                    displayContent = '';
                } else {
                     const fileName = content || 'é™„ä»¶';
                     attachmentHtml = `
                        <a href="${finalMediaPath}" target="_blank" class="block mt-2 bg-white/50 p-2 rounded border border-gray-200 hover:bg-white transition flex items-center gap-2 max-w-xs">
                            <div class="bg-gray-200 p-2 rounded text-gray-600">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                            </div>
                            <div class="overflow-hidden">
                                <div class="text-sm font-semibold truncate text-gray-800">${fileName}</div>
                                <div class="text-xs text-gray-500">é»æ“Šä¸‹è¼‰</div>
                            </div>
                        </a>`;
                     if (content === fileName) displayContent = '';
                 }
            }

            // ğŸ”§ å¤„ç†æ²¡æœ‰ finalMediaPath çš„è´´å›¾
            if (!attachmentHtml && (type === 'stickerMessage' || displayContent === '[è²¼åœ–]' || content === '[è²¼åœ–]')) {
                attachmentHtml = `
                    <div class="mt-2 relative group">
                        <div class="w-36 h-36 flex items-center justify-center bg-gradient-to-br from-purple-100 to-pink-100 rounded-lg">
                            <div class="text-center">
                                <div class="text-4xl mb-2">ğŸ¨</div>
                                <div class="text-xs text-gray-500">è²¼åœ–</div>
                            </div>
                        </div>
                    </div>`;
                displayContent = '';
            }
            
            if (!displayContent && !attachmentHtml) {
                displayContent = '<span class="italic text-gray-400">ç„¡æ³•é¡¯ç¤ºæ­¤è¨Šæ¯æ ¼å¼</span>';
            }

            // ç‰¹æ®Šè™•ç† Emoji å’Œ Reaction
            if (isEmojiOnly || isReaction) {
                const emojiSize = isReaction ? 'text-4xl' : 'text-5xl';
                const emojiText = isReaction ? content.replace('(å›æ‡‰è¨Šæ¯)', '').trim() : content;
                return `
                    <div class="chat-message rounded-lg mb-2 bg-transparent shadow-none p-2 ${isFromMe ? 'self-end' : 'self-start'}">
                        ${msg.push_name && !isFromMe ? `<div class="text-xs text-orange-600 font-bold mb-1">${msg.push_name}</div>` : ''}
                        <div class="${emojiSize} leading-none">${emojiText}</div>
                        ${isReaction ? '<div class="text-xs text-gray-500 mt-1">åæ‡‰</div>' : ''}
                        <div class="text-[10px] mt-1 text-gray-500 bg-white/50 px-1 rounded">${date}</div>
                    </div>
                `;
            }

            const isSticker = ['stickerMessage', 'sticker'].includes(type);
            const bubbleClass = isSticker ? 'bg-transparent shadow-none p-0' : (isFromMe ? 'message-out' : 'message-in');
            const timeClass = isSticker ? 'text-gray-500 bg-white/50 px-1 rounded' : 'text-gray-400';

            // Extract sender info (for group messages)
            let senderInfo = '';
            if (!isFromMe && !isSticker) {
                const senderName = msg.push_name || null;
                const senderPhone = msg.participant_phone || (msg.participant ? msg.participant.split('@')[0] : null);
                
                if (senderName || senderPhone) {
                    const displayName = senderName || senderPhone || 'æœªçŸ¥ç™¼é€è€…';
                    const displayPhone = senderPhone || '';
                    
                    // Check if current chat is a group
                    const isGroupChat = currentChatId && currentChatId.endsWith('@g.us');
                    
                    if (isGroupChat) {
                        // In group chats, always show sender info
                        senderInfo = `
                            <div class="text-xs mb-1 flex items-center gap-2">
                                <span class="font-bold text-orange-600">${displayName}</span>
                                ${displayPhone ? `<span class="text-gray-500 font-mono text-[10px]">${displayPhone}</span>` : ''}
                            </div>
                        `;
                    } else if (senderName) {
                        // In 1-on-1 chats, only show name if available
                        senderInfo = `<div class="text-xs text-orange-600 font-bold mb-1">${senderName}</div>`;
                    }
                }
            }

            return `
                <div class="chat-message rounded-lg mb-2 ${bubbleClass} ${!isSticker ? 'p-3 shadow-sm' : ''}">
                    ${senderInfo}
                    ${displayContent ? `<div class="text-sm text-gray-800 break-words whitespace-pre-wrap">${displayContent}</div>` : ''}
                    ${attachmentHtml}
                    <div class="text-[10px] mt-1 text-right ${timeClass}">${date}</div>
                </div>
            `;
        }

        // WebSocket connection for real-time updates
        let ws = null;
        
        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const host = window.location.host;
            const wsUrl = `${protocol}//${host}`;
            
            console.log('ğŸ”Œ é€£æ¥ WebSocket:', wsUrl);
            ws = new WebSocket(wsUrl);
            
            ws.onopen = () => {
                console.log('âœ… WebSocket å·²é€£æ¥');
            };
            
            ws.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    
                    if (data.type === 'connected') {
                        console.log('âœ… WebSocket:', data.message);
                        return;
                    }
                    
                    if (data.type === 'new_message') {
                        const isGroup = data.isGroup || (data.chatId && data.chatId.endsWith('@g.us'));
                        const messageType = isGroup ? 'ç¾¤ç»„æ¶ˆæ¯' : 'ç§èŠæ¶ˆæ¯';
                        const sender = data.message?.push_name || 'æœªçŸ¥';
                        const hasMedia = data.message?.attachment_path || ['imageMessage', 'videoMessage', 'audioMessage', 'stickerMessage', 'documentMessage'].includes(data.message?.message_type);
                        
                        console.log(`ğŸ“¨ æ”¶åˆ°${messageType}: ä¼šè¯=${data.sessionId}, èŠå¤©=${data.chatId}, å‘é€è€…=${sender}${hasMedia ? ' ğŸ“åª’ä½“' : ''}`);
                        
                        // ğŸ†• å¦‚æœæ¶ˆæ¯åŒ…å«åª’ä½“ï¼Œå»¶è¿Ÿ300msåˆ·æ–°ä»¥ç¡®ä¿åª’ä½“å·²ä¿å­˜
                        const refreshDelay = hasMedia ? 300 : 0;
                        
                        setTimeout(() => {
                            // If the message is for the currently open chat, refresh it immediately
                            if (currentChatId === data.chatId && currentSessionId === data.sessionId) {
                                console.log(`ğŸ”„ åˆ·æ–°å½“å‰èŠå¤©: ${data.chatId}${hasMedia ? ' (ç­‰å¾…åª’ä½“)' : ''}`);
                                refreshMessages(data.chatId);
                            } else {
                                // è‡ªåŠ¨æ‰“å¼€æ”¶åˆ°æ–°æ¶ˆæ¯çš„èŠå¤©ï¼ˆæ‰€æœ‰æ¶ˆæ¯å¤„ç†æ–¹å¼ç›¸åŒï¼‰
                                console.log(`ğŸ”” è‡ªåŠ¨æ‰“å¼€æ–°æ¶ˆæ¯èŠå¤©: ${data.chatId}`);
                                // è·å–è”ç³»äººåç§°
                                const contactName = sender || data.chatId.split('@')[0];
                                loadChat(data.chatId, contactName);
                            }
                            
                            // Always refresh contacts list to update last message time and bring chat to top
                            console.log('ğŸ”„ åˆ·æ–°è”ç³»äººåˆ—è¡¨...');
                            loadContacts();
                        }, refreshDelay);
                    }
                } catch (e) {
                    console.error('âŒ è§£æ WebSocket æ¶ˆæ¯å¤±æ•—:', e, 'åŸå§‹æ•°æ®:', event.data);
                }
            };
            
            ws.onerror = (error) => {
                console.error('âŒ WebSocket éŒ¯èª¤:', error);
            };
            
            ws.onclose = () => {
                console.log('âŒ WebSocket å·²æ–·é–‹ï¼Œ5ç§’å¾Œé‡é€£...');
                setTimeout(connectWebSocket, 5000);
            };
        }
        
        // Start polling
        startSession(); // Auto-start on load
        setInterval(checkStatus, 3000); // Check status every 3 seconds
        
        // Auto-refresh contacts occasionally to catch new syncs
        setInterval(() => {
            if (!document.getElementById('qr-container').classList.contains('hidden')) return;
            loadContacts();
        }, 10000); // Refresh contacts every 10 seconds
        
        // Connect WebSocket for real-time message updates
        connectWebSocket();

        // --- Marketing Logic ---
        let selectedContacts = new Set();
        let marketingContacts = [];

        async function openMarketing() {
            document.getElementById('marketing-modal').classList.remove('hidden');
            
            // Ensure contacts are loaded
            if (allContacts.length === 0) {
                await loadContacts();
            }

            // Load stats
            try {
                const res = await fetch(`/api/session/${currentSessionId}/daily-stats`);
                const stats = await res.json();
                const remaining = stats.remaining;
                const el = document.getElementById('daily-limit-text');
                el.textContent = `${stats.sent} / ${stats.limit} (å‰©é¤˜: ${remaining})`;
                el.className = remaining > 0 ? 'text-green-600 font-bold ml-1' : 'text-red-600 font-bold ml-1';
                
                if (remaining <= 0) {
                    document.getElementById('btn-broadcast').disabled = true;
                    document.getElementById('btn-broadcast').classList.add('opacity-50', 'cursor-not-allowed');
                    document.getElementById('btn-broadcast').innerHTML = '<span>ğŸš« ä»Šæ—¥é¡åº¦å·²ç”¨å®Œ</span>';
                }
            } catch(e) { console.error(e); }

            // Render Contacts
            // Filter out status broadcast
            marketingContacts = allContacts.filter(c => {
                const id = c.jid || c.id;
                return id && !id.includes('status@broadcast');
            });
            renderMarketingContacts();
        }

        function closeMarketing() {
            document.getElementById('marketing-modal').classList.add('hidden');
        }

        function renderMarketingContacts() {
            const list = document.getElementById('mkt-contacts-list');
            const query = document.getElementById('mkt-search').value.toLowerCase();
            
            // Filter contacts properly
            const filtered = marketingContacts.filter(c => {
                const id = c.jid || c.id || '';
                // Filter out broadcast and special ids
                if (id.includes('@broadcast') || id.includes('@lid')) return false;
                
                return (c.name && c.name.toLowerCase().includes(query)) || 
                       (c.notify && c.notify.toLowerCase().includes(query)) ||
                       id.includes(query);
            });

            if (filtered.length === 0) {
                list.innerHTML = '<div class="p-4 text-center text-gray-400 text-xs">æ²’æœ‰æ‰¾åˆ°è¯çµ¡äºº</div>';
                return;
            }

            list.innerHTML = filtered.map(c => {
                const id = c.jid || c.id;
                const isGroup = id.endsWith('@g.us');
                // Use consistent name logic
                const name = c.name || c.notify || (isGroup ? "æœªå‘½åç¾¤çµ„" : id.split('@')[0]);
                
                const isSelected = selectedContacts.has(id);
                return `
                    <label class="flex items-center p-2 hover:bg-gray-100 rounded cursor-pointer border-b border-gray-50">
                        <input type="checkbox" value="${id}" ${isSelected ? 'checked' : ''} onchange="toggleContact('${id}', this)" class="form-checkbox h-4 w-4 text-[#00a884] rounded border-gray-300 focus:ring-[#00a884] shrink-0">
                        <div class="ml-2 overflow-hidden w-full">
                            <div class="text-sm font-medium text-gray-800 truncate">${name}</div>
                            <div class="text-xs text-gray-500 truncate flex items-center justify-between">
                                <span>${isGroup ? 'ç¾¤çµ„' : id.split('@')[0]}</span>
                                ${isGroup ? '<span class="bg-gray-200 text-gray-600 px-1 rounded text-[10px]">Group</span>' : ''}
                            </div>
                        </div>
                    </label>
                `;
            }).join('');
        }

        function filterMarketingContacts() {
            renderMarketingContacts();
        }

        function toggleContact(id, cb) {
            if (cb.checked) selectedContacts.add(id);
            else selectedContacts.delete(id);
            document.getElementById('selected-count').textContent = `å·²é¸: ${selectedContacts.size}`;
        }

        function toggleAllMarketing(cb) {
            const query = document.getElementById('mkt-search').value.toLowerCase();
            const filtered = marketingContacts.filter(c => {
                const id = c.jid || c.id || '';
                return (c.name && c.name.toLowerCase().includes(query)) || 
                       (c.notify && c.notify.toLowerCase().includes(query)) ||
                       id.includes(query);
            });

            filtered.forEach(c => {
                const id = c.jid || c.id;
                if (cb.checked) selectedContacts.add(id);
                else selectedContacts.delete(id);
            });
            
            renderMarketingContacts();
            document.getElementById('selected-count').textContent = `å·²é¸: ${selectedContacts.size}`;
        }

        function addManualContact() {
            const input = document.getElementById('manual-number');
            let num = input.value.replace(/[^0-9]/g, '');
            if (!num) return alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„é›»è©±è™Ÿç¢¼');
            
            const jid = num + '@s.whatsapp.net';
            
            // Check if already exists
            if (!marketingContacts.find(c => c.id === jid || c.jid === jid)) {
                marketingContacts.unshift({
                    id: jid,
                    name: `æ‰‹å‹•æ–°å¢ (${num})`,
                    notify: num
                });
            }
            
            // Auto select
            selectedContacts.add(jid);
            renderMarketingContacts();
            document.getElementById('selected-count').textContent = `å·²é¸: ${selectedContacts.size}`;
            input.value = '';
        }

        async function sendBroadcast() {
            const recipients = Array.from(selectedContacts);
            if (recipients.length === 0) return alert('è«‹è‡³å°‘é¸æ“‡ä¸€ä½è¯çµ¡äºº');
            
            const text = document.getElementById('mkt-text').value;
            const fileInput = document.getElementById('mkt-file');
            
            if (!text && fileInput.files.length === 0) return alert('è«‹è¼¸å…¥è¨Šæ¯å…§å®¹æˆ–é¸æ“‡é™„ä»¶');

            if (!confirm(`ç¢ºå®šè¦ç™¼é€çµ¦ ${recipients.length} ä½è¯çµ¡äººå—ï¼Ÿ\n\nç³»çµ±å°‡æœƒé€ä¸€ç™¼é€ï¼Œè«‹å‹¿é—œé–‰è¦–çª—ã€‚`)) return;

            const btn = document.getElementById('btn-broadcast');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = `<svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> ç™¼é€ä¸­...`;

            const formData = new FormData();
            formData.append('recipients', JSON.stringify(recipients));
            formData.append('text', text);
            if (fileInput.files[0]) {
                formData.append('attachment', fileInput.files[0]);
            }

            try {
                const res = await fetch(`/api/session/${currentSessionId}/broadcast`, {
                    method: 'POST',
                    body: formData
                });
                const result = await res.json();
                
                if (result.error) {
                    alert('ç™¼é€å¤±æ•—: ' + result.error);
                } else {
                    alert('å»£æ’­ä»»å‹™å·²å•Ÿå‹•ï¼\n\nç³»çµ±å°‡åœ¨èƒŒæ™¯é€ä¸€ç™¼é€è¨Šæ¯ï¼Œæ‚¨å¯ä»¥ç¹¼çºŒä½¿ç”¨å…¶ä»–åŠŸèƒ½ã€‚');
                    closeMarketing();
                    // Reset form
                    document.getElementById('mkt-text').value = '';
                    document.getElementById('mkt-file').value = '';
                    selectedContacts.clear();
                    renderMarketingContacts();
                    document.getElementById('selected-count').textContent = 'å·²é¸: 0';
                }
            } catch (e) {
                alert('ç™¼ç”ŸéŒ¯èª¤: ' + e.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

    </script>
</body>
</html>
