<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WhatsApp CRM</title>
    <link rel="stylesheet" href="shared-styles.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .chat-container { 
            display: grid; 
            grid-template-columns: 320px 1fr; 
            height: calc(100vh - 65px); 
            overflow: hidden;
        }
        .sidebar { 
            background: var(--bg-main); 
            border-right: 1px solid var(--border-color); 
            display: flex; 
            flex-direction: column; 
            overflow: hidden;
            height: 100%;
        }
        .sidebar-header {
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
            flex-shrink: 0;
        }
        .chat-list-container {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            height: 0; /* é‡è¦ï¼šè®“ flex å­å…ƒç´ å¯ä»¥æ»¾å‹• */
        }
        .chat-area { 
            display: flex; 
            flex-direction: column; 
            background: var(--bg-dark); 
            overflow: hidden;
            height: 100%;
        }
        .chat-header {
            padding: 1rem;
            background: var(--bg-main);
            border-bottom: 1px solid var(--border-color);
            flex-shrink: 0;
        }
        .messages-area { 
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 1rem;
            height: 0; /* é‡è¦ï¼šè®“ flex å­å…ƒç´ å¯ä»¥æ»¾å‹• */
        }
        .message-in { 
            background: var(--bg-card); 
            border-radius: var(--radius-lg); 
            padding: 0.75rem 1rem; 
            margin: 0.25rem 0; 
            max-width: 70%; 
            align-self: flex-start; 
        }
        .message-out { 
            background: var(--gradient-primary); 
            color: #000; 
            border-radius: var(--radius-lg); 
            padding: 0.75rem 1rem; 
            margin: 0.25rem 0; 
            max-width: 70%; 
            align-self: flex-end; 
        }
        .contact-item { 
            padding: 0.75rem 1rem; 
            border-bottom: 1px solid var(--border-color); 
            cursor: pointer; 
            transition: all 0.2s; 
        }
        .contact-item:hover { background: var(--bg-card); }
        .contact-item.active { background: rgba(0, 210, 106, 0.1); border-left: 3px solid var(--primary); }
        .input-area { 
            padding: 1rem; 
            background: var(--bg-main); 
            border-top: 1px solid var(--border-color);
            flex-shrink: 0;
        }
        .avatar { 
            width: 40px; 
            height: 40px; 
            border-radius: 50%; 
            background: var(--bg-card); 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-weight: bold; 
            color: var(--text-secondary); 
            overflow: hidden; 
            flex-shrink: 0; 
        }
        .avatar img { width: 100%; height: 100%; object-fit: cover; }
    </style>
</head>
<body>
    <header class="app-header">
        <h1>
            <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 24 24"><path d="M20 2H4C2.9 2 2 2.9 2 4V22L6 18H20C21.1 18 22 17.1 22 16V4C22 2.9 21.1 2 20 2Z"/></svg>
            WhatsApp CRM
        </h1>
        <div style="display: flex; align-items: center; gap: 1rem;">
            <div class="session-selector" onclick="openSessionModal()">
                <div class="session-status" id="sessionStatus"></div>
                <span id="sessionName">è¼‰å…¥ä¸­...</span>
            </div>
            <nav class="nav-links">
                <a href="index.html" style="color: var(--primary);">ğŸ’¬ èŠå¤©</a>
                <a href="contacts-list.html">ğŸ‘¥ è¯çµ¡äºº</a>
                <a href="media.html">ğŸ–¼ï¸ åª’é«”</a>
                <a href="admin.html">âš™ï¸ ç®¡ç†</a>
            </nav>
        </div>
    </header>

    <div class="chat-container">
        <!-- å·¦å´ï¼šè¯çµ¡äººæ¸…å–®ï¼ˆç¨ç«‹æ»¾å‹•ï¼‰ -->
        <div class="sidebar">
            <div class="sidebar-header">
                <input type="text" id="search" class="input" placeholder="ğŸ” æœå°‹èŠå¤©..." oninput="filterChats()">
            </div>
            <div id="chat-list" class="chat-list-container">
                <div class="loading"><div class="spinner"></div></div>
            </div>
        </div>

        <!-- å³å´ï¼šèŠå¤©å…§å®¹ï¼ˆç¨ç«‹æ»¾å‹•ï¼‰ -->
        <div class="chat-area">
            <div id="chat-header" class="chat-header" style="display: none;">
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <div class="avatar" id="chat-avatar">ğŸ‘¤</div>
                    <div>
                        <div id="chat-name" style="font-weight: 600;"></div>
                        <div id="chat-status" style="font-size: 0.75rem; color: var(--text-muted);"></div>
                    </div>
                </div>
            </div>
            <div id="messages" class="messages-area" style="display: flex; flex-direction: column;">
                <div style="flex: 1; display: flex; align-items: center; justify-content: center; color: var(--text-muted);">
                    é¸æ“‡ä¸€å€‹èŠå¤©é–‹å§‹
                </div>
            </div>
            <div class="input-area" id="input-area" style="display: none;">
                <div style="display: flex; gap: 0.5rem;">
                    <input type="text" id="message-input" class="input" placeholder="è¼¸å…¥è¨Šæ¯..." onkeypress="if(event.key==='Enter')sendMessage()">
                    <button class="btn btn-primary" onclick="sendMessage()">ç™¼é€</button>
                </div>
            </div>
        </div>
    </div>

    <div id="sessionModal" class="modal-overlay" onclick="if(event.target===this)closeSessionModal()">
        <div class="modal">
            <h3 style="margin: 0 0 1rem 0;">åˆ‡æ› Session</h3>
            <div id="sessionList" style="display: flex; flex-direction: column; gap: 0.5rem;"></div>
            <button class="btn btn-secondary" style="width: 100%; margin-top: 1rem;" onclick="closeSessionModal()">é—œé–‰</button>
        </div>
    </div>

    <script>
        let currentSessionId = localStorage.getItem('wa_crm_session_id') || 'sess_1771472517677';
        let currentChatId = null;
        let allContacts = [];
        let allSessions = [];
        const avatarCache = new Map();

        async function getAvatar(jid) {
            if (avatarCache.has(jid)) return avatarCache.get(jid);
            try {
                const res = await fetch(`/api/session/${currentSessionId}/avatar/${encodeURIComponent(jid)}`);
                if (res.ok) {
                    const data = await res.json();
                    if (data.url) {
                        avatarCache.set(jid, data.url);
                        return data.url;
                    }
                }
            } catch (e) {}
            avatarCache.set(jid, null);
            return null;
        }

        async function init() {
            await loadSessions();
            await loadContacts();
        }

        async function loadSessions() {
            try {
                const res = await fetch('/api/sessions');
                allSessions = await res.json();
                const s = allSessions.find(x => x.id === currentSessionId) || allSessions[0];
                document.getElementById('sessionName').textContent = s?.name || s?.id?.split('_')[1] || 'Unknown';
                document.getElementById('sessionStatus').style.background = s?.status === 'connected' ? 'var(--success)' : 'var(--error)';
            } catch (e) {}
        }

        async function loadContacts() {
            try {
                const res = await fetch(`/api/session/${currentSessionId}/contacts?limit=500`);
                allContacts = await res.json();
                renderChatList();
            } catch (e) {}
        }

        async function renderChatList() {
            const list = document.getElementById('chat-list');
            const search = document.getElementById('search').value.toLowerCase();
            const filtered = allContacts.filter(c => {
                const name = c.name || c.notify || c.jid;
                return name.toLowerCase().includes(search);
            }).slice(0, 100);

            list.innerHTML = filtered.map(c => {
                const name = c.name || c.notify || c.jid.split('@')[0];
                const icon = c.is_group ? 'ğŸ‘¥' : name[0]?.toUpperCase() || '?';
                const active = c.jid === currentChatId ? 'active' : '';
                const avatarId = 'avatar-' + c.jid.replace(/[^a-zA-Z0-9]/g, '_');
                return `
                    <div class="contact-item ${active}" onclick="selectChat('${c.jid}', '${name.replace(/'/g, "\\'")}')">
                        <div style="display: flex; align-items: center; gap: 0.75rem;">
                            <div class="avatar" id="${avatarId}"></div>
                            <div style="flex: 1; min-width: 0;">
                                <div style="font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${name}</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            filtered.forEach(async c => {
                const avatarId = 'avatar-' + c.jid.replace(/[^a-zA-Z0-9]/g, '_');
                const avatarEl = document.getElementById(avatarId);
                const url = await getAvatar(c.jid);
                if (avatarEl && url) {
                    avatarEl.innerHTML = `<img src="${url}" onerror="this.parentElement.innerHTML='${c.is_group ? 'ğŸ‘¥' : (c.name || c.notify || '?')[0]?.toUpperCase() || '?'}'">`;
                }
            });
        }

        function filterChats() { renderChatList(); }

        async function selectChat(jid, name) {
            currentChatId = jid;
            document.getElementById('chat-name').textContent = name;
            document.getElementById('chat-header').style.display = 'block';
            document.getElementById('input-area').style.display = 'block';
            document.getElementById('messages').innerHTML = '<div class="loading"><div class="spinner"></div></div>';
            renderChatList();

            const avatarEl = document.getElementById('chat-avatar');
            const contact = allContacts.find(c => c.jid === jid);
            avatarEl.textContent = contact?.is_group ? 'ğŸ‘¥' : name[0]?.toUpperCase() || '?';
            const url = await getAvatar(jid);
            if (url) {
                avatarEl.innerHTML = `<img src="${url}" onerror="this.parentElement.innerHTML='${contact?.is_group ? 'ğŸ‘¥' : name[0]?.toUpperCase() || '?'}'">`;
            }

            try {
                const res = await fetch(`/api/session/${currentSessionId}/messages/${encodeURIComponent(jid)}?limit=50`);
                const messages = await res.json();
                renderMessages(messages);
            } catch (e) {
                document.getElementById('messages').innerHTML = '<div style="color: var(--error); text-align: center; padding: 2rem;">è¼‰å…¥å¤±æ•—</div>';
            }
        }

        function renderMessages(messages) {
            const container = document.getElementById('messages');
            container.innerHTML = messages.reverse().map(m => {
                const cls = m.from_me ? 'message-out' : 'message-in';
                const content = m.content || '[åª’é«”]';
                const time = m.message_timestamp ? new Date(m.message_timestamp).toLocaleTimeString('zh-TW', {hour: '2-digit', minute: '2-digit'}) : '';
                let mediaHtml = '';
                if (m.attachment_path) {
                    mediaHtml = `<div style="margin-top: 0.5rem;"><img src="/media/${m.attachment_path}" style="max-width: 200px; border-radius: 8px;" onerror="this.style.display='none'"></div>`;
                }
                return `<div class="${cls}"><div>${content}${mediaHtml}</div><div style="font-size: 0.65rem; opacity: 0.7; margin-top: 0.25rem;">${time}</div></div>`;
            }).join('');
            container.scrollTop = container.scrollHeight;
        }

        async function sendMessage() {
            const input = document.getElementById('message-input');
            const text = input.value.trim();
            if (!text || !currentChatId) return;
            input.value = '';
        }

        function openSessionModal() {
            const list = document.getElementById('sessionList');
            list.innerHTML = allSessions.map(s => {
                const active = s.id === currentSessionId ? 'btn-primary' : 'btn-secondary';
                const status = s.status === 'connected' ? 'ğŸŸ¢' : 'ğŸ”´';
                return `<button class="btn ${active}" style="justify-content: flex-start; width: 100%;" onclick="selectSession('${s.id}')">${status} ${s.name || s.id.split('_')[1]}</button>`;
            }).join('') || '<p style="color: var(--text-muted);">æ²’æœ‰ session</p>';
            document.getElementById('sessionModal').classList.add('active');
        }

        function closeSessionModal() { document.getElementById('sessionModal').classList.remove('active'); }
        function selectSession(id) { localStorage.setItem('wa_crm_session_id', id); closeSessionModal(); location.reload(); }

        init();
    </script>
</body>
</html>
