<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LID æ˜ å°„ç®¡ç† - WhatsApp CRM</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto p-6">
        <div class="bg-white rounded-lg shadow-lg p-6">
            <h1 class="text-3xl font-bold mb-6 text-gray-800">ğŸ“‹ LID æ˜ å°„ç®¡ç†</h1>
            
            <!-- Session Info -->
            <div class="mb-6 p-4 bg-blue-50 rounded-lg">
                <p class="text-sm text-gray-600">Session ID: <span id="sessionId" class="font-mono font-bold"></span></p>
            </div>
            
            <!-- Auto Map Button -->
            <div class="mb-6">
                <button onclick="autoMapLids()" class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-lg transition">
                    ğŸ¤– è‡ªå‹•æ˜ å°„ LID
                </button>
                <button onclick="loadCandidates()" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-lg ml-2 transition">
                    ğŸ”„ åˆ·æ–°åˆ—è¡¨
                </button>
                <a href="/" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-6 rounded-lg ml-2 inline-block transition">
                    â† è¿”å›ä¸»é 
                </a>
            </div>
            
            <!-- Status Messages -->
            <div id="statusMessage" class="mb-4 hidden"></div>
            
            <!-- Existing Mappings -->
            <div class="mb-8">
                <h2 class="text-2xl font-bold mb-4 text-gray-700">âœ… å·²å»ºç«‹çš„æ˜ å°„</h2>
                <div id="existingMappings" class="bg-gray-50 p-4 rounded-lg">
                    <p class="text-gray-500">è¼‰å…¥ä¸­...</p>
                </div>
            </div>
            
            <!-- Unmapped LIDs -->
            <div>
                <h2 class="text-2xl font-bold mb-4 text-gray-700">âš ï¸ éœ€è¦æ˜ å°„çš„ LID</h2>
                <div id="candidatesList" class="space-y-4">
                    <p class="text-gray-500">è¼‰å…¥ä¸­...</p>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        const SESSION_ID = 'sess_9ai6rbwfe_1770361159106'; // Update this if needed
        document.getElementById('sessionId').textContent = SESSION_ID;
        
        function showStatus(message, type = 'info') {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.className = `mb-4 p-4 rounded-lg ${
                type === 'success' ? 'bg-green-100 text-green-800' :
                type === 'error' ? 'bg-red-100 text-red-800' :
                'bg-blue-100 text-blue-800'
            }`;
            statusDiv.textContent = message;
            statusDiv.classList.remove('hidden');
            
            setTimeout(() => {
                statusDiv.classList.add('hidden');
            }, 5000);
        }
        
        async function loadExistingMappings() {
            try {
                const response = await fetch(`/api/session/${SESSION_ID}/lid-mappings`);
                const mappings = await response.json();
                
                const container = document.getElementById('existingMappings');
                
                if (mappings.length === 0) {
                    container.innerHTML = '<p class="text-gray-500">æš«ç„¡æ˜ å°„</p>';
                    return;
                }
                
                container.innerHTML = `
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">LID JID</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Traditional JID</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">å‰µå»ºæ™‚é–“</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                ${mappings.map(m => `
                                    <tr>
                                        <td class="px-4 py-2 text-sm font-mono">${m.lid_jid}</td>
                                        <td class="px-4 py-2 text-sm font-mono">${m.traditional_jid}</td>
                                        <td class="px-4 py-2 text-sm">${new Date(m.created_at).toLocaleString('zh-HK')}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            } catch (err) {
                console.error('Error loading existing mappings:', err);
                document.getElementById('existingMappings').innerHTML = 
                    '<p class="text-red-500">è¼‰å…¥å¤±æ•—: ' + err.message + '</p>';
            }
        }
        
        async function loadCandidates() {
            try {
                showStatus('æ­£åœ¨è¼‰å…¥éœ€è¦æ˜ å°„çš„ LID...', 'info');
                
                const response = await fetch(`/api/session/${SESSION_ID}/lid-mapping-candidates`);
                const candidates = await response.json();
                
                const container = document.getElementById('candidatesList');
                
                if (candidates.length === 0) {
                    container.innerHTML = '<p class="text-green-600 font-bold">ğŸ‰ æ‰€æœ‰ LID å·²æ˜ å°„å®Œæˆï¼</p>';
                    showStatus('æ‰€æœ‰ LID å·²æ˜ å°„å®Œæˆï¼', 'success');
                    return;
                }
                
                container.innerHTML = candidates.map(c => `
                    <div class="bg-white border border-gray-200 rounded-lg p-4 shadow-sm">
                        <div class="flex justify-between items-start mb-3">
                            <div class="flex-1">
                                <p class="font-mono text-sm text-gray-600 mb-1">${c.lid_jid || c.remote_jid || 'Unknown LID'}</p>
                                <p class="text-lg font-bold">${c.push_name || c.lid_name || 'æœªçŸ¥è¯çµ¡äºº'}</p>
                                <p class="text-sm text-gray-500">
                                    ç¸½æ¶ˆæ¯: ${c.total_messages || 0} | æ‚¨ç™¼é€: ${c.my_messages || 0}
                                </p>
                            </div>
                            <button 
                                onclick="viewMessages('${c.lid_jid || c.remote_jid}')" 
                                class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm transition"
                            >
                                æŸ¥çœ‹å°è©±
                            </button>
                        </div>
                        <div class="mt-3 flex gap-2">
                            <input 
                                type="text" 
                                id="phone_${(c.lid_jid || c.remote_jid).replace(/[^0-9]/g, '')}" 
                                placeholder="è¼¸å…¥é›»è©±è™Ÿç¢¼ (852XXXXXXXX)" 
                                class="flex-1 border border-gray-300 rounded-lg px-3 py-2 text-sm"
                            />
                            <button 
                                onclick="addMapping('${c.lid_jid || c.remote_jid}')" 
                                class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg text-sm transition"
                            >
                                å»ºç«‹æ˜ å°„
                            </button>
                        </div>
                    </div>
                `).join('');
                
                showStatus(`æ‰¾åˆ° ${candidates.length} å€‹éœ€è¦æ˜ å°„çš„ LID`, 'info');
            } catch (err) {
                console.error('Error loading candidates:', err);
                showStatus('è¼‰å…¥å¤±æ•—: ' + err.message, 'error');
            }
        }
        
        async function viewMessages(lidJid) {
            try {
                const response = await fetch(`/api/session/${SESSION_ID}/lid-messages/${encodeURIComponent(lidJid)}`);
                const messages = await response.json();
                
                const content = messages.map(m => `
                    <div class="${m.from_me ? 'text-right' : 'text-left'} mb-2">
                        <div class="inline-block ${m.from_me ? 'bg-green-100' : 'bg-gray-100'} rounded-lg px-4 py-2 max-w-md">
                            <p class="text-xs text-gray-500 mb-1">${m.from_me ? 'æ‚¨' : (m.push_name || 'å°æ–¹')} - ${new Date(m.message_timestamp).toLocaleString('zh-HK')}</p>
                            <p class="text-sm">${m.content || '[åª’é«”æ¶ˆæ¯]'}</p>
                        </div>
                    </div>
                `).join('');
                
                const modal = `
                    <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onclick="this.remove()">
                        <div class="bg-white rounded-lg p-6 max-w-2xl w-full mx-4 max-h-[80vh] overflow-y-auto" onclick="event.stopPropagation()">
                            <h3 class="text-xl font-bold mb-4">å°è©±è¨˜éŒ„ - ${lidJid}</h3>
                            <div class="space-y-2 mb-4">
                                ${content || '<p class="text-gray-500">ç„¡æ¶ˆæ¯è¨˜éŒ„</p>'}
                            </div>
                            <button onclick="this.closest('.fixed').remove()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg">
                                é—œé–‰
                            </button>
                        </div>
                    </div>
                `;
                
                document.body.insertAdjacentHTML('beforeend', modal);
            } catch (err) {
                console.error('Error viewing messages:', err);
                showStatus('ç„¡æ³•è¼‰å…¥æ¶ˆæ¯: ' + err.message, 'error');
            }
        }
        
        async function addMapping(lidJid) {
            const phoneInput = document.getElementById('phone_' + lidJid.replace(/[^0-9]/g, ''));
            const phone = phoneInput.value.trim();
            
            if (!phone) {
                showStatus('è«‹è¼¸å…¥é›»è©±è™Ÿç¢¼', 'error');
                return;
            }
            
            // Ensure phone has @s.whatsapp.net suffix
            const traditionalJid = phone.includes('@') ? phone : `${phone}@s.whatsapp.net`;
            
            try {
                showStatus('æ­£åœ¨å»ºç«‹æ˜ å°„...', 'info');
                
                const response = await fetch(`/api/session/${SESSION_ID}/lid-mapping`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ lid_jid: lidJid, traditional_jid: traditionalJid })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showStatus('æ˜ å°„å»ºç«‹æˆåŠŸï¼', 'success');
                    phoneInput.value = '';
                    await loadExistingMappings();
                    await loadCandidates();
                } else {
                    throw new Error(result.error || 'æœªçŸ¥éŒ¯èª¤');
                }
            } catch (err) {
                console.error('Error adding mapping:', err);
                showStatus('å»ºç«‹æ˜ å°„å¤±æ•—: ' + err.message, 'error');
            }
        }
        
        async function autoMapLids() {
            try {
                showStatus('æ­£åœ¨è‡ªå‹•æ˜ å°„ LID...', 'info');
                
                const response = await fetch(`/api/session/${SESSION_ID}/auto-map-lids`, {
                    method: 'POST'
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showStatus(`è‡ªå‹•æ˜ å°„å®Œæˆï¼æˆåŠŸæ˜ å°„ ${result.mapped} å€‹ LID`, 'success');
                    await loadExistingMappings();
                    await loadCandidates();
                } else {
                    throw new Error(result.error || 'æœªçŸ¥éŒ¯èª¤');
                }
            } catch (err) {
                console.error('Error auto-mapping:', err);
                showStatus('è‡ªå‹•æ˜ å°„å¤±æ•—: ' + err.message, 'error');
            }
        }
        
        // Initial load
        loadExistingMappings();
        loadCandidates();
    </script>
</body>
</html>
